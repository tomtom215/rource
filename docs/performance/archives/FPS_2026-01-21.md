# FPS Performance Optimization Report - ARCHIVED

> **Status**: ARCHIVED - This was an early optimization report from 2026-01-21.
> Subsequent phases (40-58) have superseded these optimizations.
> See [SUCCESSFUL_OPTIMIZATIONS.md](../SUCCESSFUL_OPTIMIZATIONS.md) for the complete history.

**Original Date**: 2026-01-21
**Test Count at Time**: 245 tests (now 1,899+)

---

## Methodology

All optimizations followed these principles:
- **Verified**: Based on profiling data, not speculation
- **Validated**: Tested against real-world workloads (Home Assistant core: 100k+ commits)
- **Stable**: No regressions in functionality
- **Testable**: Covered by unit tests
- **Observable**: Benchmarks measure actual impact
- **Measurable**: Before/after comparisons with criterion
- **Deterministic**: Same input produces same output

## Benchmark Configuration

- **Framework**: criterion 0.5
- **Profile**: Release with LTO
- **Warmup**: 3 seconds per benchmark
- **Samples**: 100 per benchmark
- **Test cases**: 100 to 10,000 files, 10 to 200 directories

---

## Optimizations Implemented

### 1. Allocation Reuse for Hot Path Buffers

**Location**: `rource-core/src/scene/mod.rs`

**Problem**: Every frame allocated new `Vec` and `HashMap` instances for:
- Completed actions tracking
- Files marked for removal
- Force calculation data
- Force vectors per directory

**Solution**: Added reusable buffers to `Scene` struct:
```rust
completed_actions_buffer: Vec<(ActionId, UserId)>,
files_to_remove_buffer: Vec<FileId>,
forces_buffer: HashMap<DirId, Vec2>,
dir_data_buffer: Vec<DirForceData>,
```

**Impact**:

| Benchmark | Before | After | Change |
|-----------|--------|-------|--------|
| force_layout/10 dirs | 5.18 us | 4.41 us | **-14.5%** |
| force_layout/50 dirs | 60.5 us | 57.9 us | **-4.3%** |
| spatial_query/500 files | 4.53 us | 4.42 us | **-2.4%** |

### 2. Squared Distance Comparisons

**Location**: `rource-core/src/scene/mod.rs`

**Problem**: Force calculations used `length()` and `hypot()` which require `sqrt()`.

**Solution**: Compare squared distances, only compute `sqrt()` when needed:
```rust
let distance_sq = delta.length_squared();
if distance_sq > threshold_sq { ... }
let distance = distance_sq.sqrt();  // Only when needed
```

**Impact**:

| Benchmark | Before | After | Change |
|-----------|--------|-------|--------|
| scene_update/1000 files | 437 us | 382 us | **-12.6%** |
| scene_update/5000 files | 524 us | 471 us | **-10.1%** |
| force_layout/100 dirs | 223 us | 199 us | **-10.8%** |

### 3. Extension Statistics Caching

**Location**: `rource-core/src/scene/mod.rs`

**Problem**: `file_extension_stats()` was called every frame, iterating all files.

**Solution**: Cache results with dirty flag invalidation:
```rust
extension_stats_cache: Vec<(String, usize)>,
extension_stats_dirty: bool,
stats_cache_frame: u32,
```

**Impact**:

| Benchmark | Before | After | Change |
|-----------|--------|-------|--------|
| extension_stats/500 (cached) | 17.2 us | 549 ns | **-96.8%** |
| extension_stats/2000 (cached) | 62.8 us | 2.0 us | **-96.8%** |

---

## Cumulative Results

### Scene Update (Primary Hot Path)

| File Count | Baseline | Optimized | Improvement |
|------------|----------|-----------|-------------|
| 100 | 22.2 us | 18.8 us | **-15.3%** |
| 500 | 418 us | 386 us | **-7.7%** |
| 1000 | 401 us | 392 us | **-2.2%** |
| 5000 | 513 us | 487 us | **-5.1%** |

### Force-Directed Layout

| Directory Count | Baseline | Optimized | Improvement |
|-----------------|----------|-----------|-------------|
| 10 | 5.18 us | 4.20 us | **-18.9%** |
| 200 | 238 us | 210 us | **-11.8%** |

### Spatial Queries

| File Count | Baseline | Optimized | Improvement |
|------------|----------|-----------|-------------|
| 500 | 4.53 us | 4.00 us | **-11.7%** |
| 2000 | 10.6 us | 10.4 us | **-1.9%** |

---

## FPS Impact Analysis

At 60 FPS target (16.67ms frame budget):

| Scene Size | Before | After | FPS Headroom |
|------------|--------|-------|--------------|
| 500 files | 418 us | 386 us | +32 us (~2% more budget) |
| 5000 files | 513 us | 487 us | +26 us (~1.5% more budget) |
| 10000 files | ~1 ms | ~0.9 ms | +100 us (~6% more budget) |

---

## Tests Added

1. `test_extension_stats_caching` - Verifies cache hits and invalidation
2. `test_extension_stats_cache_invalidation_on_file_add` - Verifies dirty flag
3. `test_reusable_buffers_dont_leak` - Verifies buffers don't grow unbounded
4. `test_force_directed_layout_stability` - Verifies physics stability

---

*Optimizations implemented: 2026-01-21*
*Archived: 2026-01-25 | Superseded by Phases 40-58*
