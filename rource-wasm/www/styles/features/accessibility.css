/* SPDX-License-Identifier: GPL-3.0-or-later */
/* Copyright (C) 2026 Tom F <https://github.com/tomtom215> */

/**
 * Rource - Accessibility Styles
 *
 * WCAG compliance improvements, reduced motion support, and auto color scheme.
 */

/* =============================================================================
   Screen Reader Only (Hidden Visually but Accessible)
   ============================================================================= */

/**
 * Hide content visually but keep it accessible to screen readers.
 * Used for status announcements and additional context.
 */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* =============================================================================
   Contrast Improvements (WCAG AA)
   ============================================================================= */

/**
 * Improve contrast ratios to meet WCAG AA requirements (4.5:1 for normal text).
 * Dark theme: #8b949e on #21262d = 3.86:1 (fails), #a8b2bd on #21262d = 4.7:1 (passes)
 */

/* Disabled buttons need higher contrast text */
.showcase-btn:disabled,
.btn:disabled,
.btn-secondary:disabled {
    color: #a8b2bd; /* WCAG AA: 4.7:1 contrast on #21262d */
}

/* Links should be distinguishable without relying solely on color */
.docs-panel a,
.panel-body a,
.help-text a,
.about-banner a:not(.btn) {
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
}

.docs-panel a:hover,
.panel-body a:hover,
.help-text a:hover,
.about-banner a:not(.btn):hover {
    text-decoration-thickness: 2px;
}

/* Improve muted text contrast for informational content */
.panel-guide .help-text,
.docs-section p {
    color: #9ca3af; /* WCAG AA: 4.5:1 on dark backgrounds */
}

/* Maintain h3 visual styling when using h2 for proper heading hierarchy */
h2.h3-style {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
}

/* =============================================================================
   Focus States (A6: Visible Focus Indicators)
   ============================================================================= */

/**
 * Visible focus indicators for keyboard navigation.
 * Uses :focus-visible to show focus rings only for keyboard users,
 * not for mouse/touch interactions.
 *
 * WCAG 2.1 Success Criterion 2.4.7: Focus Visible (Level AA)
 */

/* Base focus ring for all focusable elements */
:focus-visible {
    outline: 2px solid var(--accent-primary, #e94560);
    outline-offset: 2px;
}

/* Remove default focus ring (replaced by :focus-visible) */
:focus:not(:focus-visible) {
    outline: none;
}

/* Button focus states */
.btn:focus-visible,
.control-btn:focus-visible,
.mobile-toolbar-btn:focus-visible,
.bottom-sheet-fab:focus-visible,
.theme-toggle:focus-visible,
.sidebar-toggle:focus-visible,
.showcase-btn:focus-visible {
    outline: 2px solid var(--text-primary, #f0f6fc);
    outline-offset: 2px;
    border-radius: inherit;
}

/* Timeline scrubber focus */
.timeline-slider:focus-visible {
    outline: 3px solid var(--accent-primary, #e94560);
    outline-offset: 4px;
}

/* Timeline thumb focus (for custom range inputs) */
.timeline-slider:focus-visible::-webkit-slider-thumb {
    box-shadow: 0 0 0 3px var(--accent-primary, #e94560);
}

.timeline-slider:focus-visible::-moz-range-thumb {
    box-shadow: 0 0 0 3px var(--accent-primary, #e94560);
}

/* Input field focus */
input:focus-visible,
select:focus-visible,
textarea:focus-visible,
.input-group input:focus-visible {
    outline: 2px solid var(--accent-primary, #e94560);
    outline-offset: 1px;
    border-color: var(--accent-primary, #e94560);
}

/* Link focus */
a:focus-visible {
    outline: 2px solid var(--accent-primary, #e94560);
    outline-offset: 2px;
    border-radius: 2px;
}

/* Tab focus */
.tab-btn:focus-visible,
.quick-action:focus-visible {
    outline: 2px solid var(--accent-primary, #e94560);
    outline-offset: 2px;
    border-radius: var(--radius-md, 8px);
}

/* Panel/card focus (for keyboard-navigable panels) */
.author-item:focus-visible,
.legend-item:focus-visible,
.collapsible-header:focus-visible {
    outline: 2px solid var(--accent-primary, #e94560);
    outline-offset: 2px;
    border-radius: 4px;
}

/* Speed dropdown focus */
.speed-select:focus-visible {
    outline: 2px solid var(--text-primary, #f0f6fc);
    outline-offset: 2px;
}

/* Close button focus */
.modal-close:focus-visible,
.help-close:focus-visible,
.toast-close:focus-visible {
    outline: 2px solid var(--text-primary, #f0f6fc);
    outline-offset: 2px;
    border-radius: 50%;
}

/* Skip link for keyboard users */
.skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--accent-primary, #e94560);
    color: white;
    padding: 8px 16px;
    z-index: 10000;
    transition: top 0.2s;
}

.skip-link:focus {
    top: 0;
}

/* Light theme focus adjustments */
.light-theme :focus-visible,
:root:not(.theme-manual) :focus-visible {
    outline-color: var(--accent, #d6335a);
}

@media (prefers-color-scheme: light) {
    :root:not(.theme-manual) :focus-visible {
        outline-color: var(--accent, #d6335a);
    }
}

/* =============================================================================
   Composited Animations (GPU Acceleration)
   ============================================================================= */

/**
 * Ensure animations use compositor-friendly properties (transform, opacity)
 * and add will-change hint for GPU acceleration.
 */

.sidebar-scroll-indicator svg {
    will-change: transform;
}

.loading-spinner {
    will-change: transform;
}

.btn-record.recording .record-indicator {
    will-change: transform, opacity;
}

/* =============================================================================
   Reduced Motion Support
   ============================================================================= */

/**
 * Disable animations and transitions for users who prefer reduced motion.
 * This respects the prefers-reduced-motion media query for accessibility.
 */

@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }

    /* Allow subtle hover effects but remove transitions */
    .control-btn,
    .collapsible-header,
    .timeline-slider,
    .theme-toggle,
    .sidebar-toggle,
    .btn,
    .input-group input {
        transition: none !important;
    }

    /* Disable parallax or sliding effects */
    .sidebar-panel {
        scroll-behavior: auto !important;
    }
}

/**
 * Manual reduced motion override class.
 * Applied via JavaScript when user explicitly chooses 'always' reduce motion.
 * This complements the @media query for user preference override.
 */
:root.reduce-motion *,
:root.reduce-motion *::before,
:root.reduce-motion *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
}

:root.reduce-motion .control-btn,
:root.reduce-motion .collapsible-header,
:root.reduce-motion .timeline-slider,
:root.reduce-motion .theme-toggle,
:root.reduce-motion .sidebar-toggle,
:root.reduce-motion .btn,
:root.reduce-motion .input-group input {
    transition: none !important;
}

:root.reduce-motion .sidebar-panel {
    scroll-behavior: auto !important;
}

/* Loading skeleton animations disabled in reduced motion mode */
:root.reduce-motion .skeleton-bar::after,
:root.reduce-motion .loading-spinner,
:root.reduce-motion .skeleton-node,
:root.reduce-motion .skeleton-beam,
:root.reduce-motion .skeleton-pulse {
    animation: none !important;
}

/* =============================================================================
   Auto Color Scheme (System Preference)
   ============================================================================= */

/**
 * Automatically apply light theme for users with light system preference.
 * This can be overridden by the manual theme toggle (JS adds/removes .light-theme class).
 * The :not(.theme-manual) check prevents auto-switching when user has manually toggled.
 */

@media (prefers-color-scheme: light) {
    :root:not(.theme-manual) {
        /* Background Colors */
        --bg-primary: #ffffff;
        --bg-secondary: #f6f8fa;
        --bg-tertiary: #eaeef2;
        --bg-canvas: #f0f3f6;

        /* Text Colors */
        --text-primary: #1f2328;
        --text-secondary: #4d5561;
        --text-muted: #656d76;
        --text-on-accent: #ffffff;

        /* Border Colors */
        --border: #d0d7de;
        --border-light: #afb8c1;

        /* Shadows & Overlays */
        --shadow: rgba(31, 35, 40, 0.12);
        --backdrop: rgba(31, 35, 40, 0.3);
        --backdrop-blur: rgba(31, 35, 40, 0.7);

        /* Accent Colors - adjusted for light backgrounds */
        --accent: #d6335a;
        --accent-hover: #c42952;
        --accent-light: #ff9a9e;
        --accent-secondary: #1a7f37;
        --accent-secondary-hover: #238636;
        --accent-blue: #0969da;
        --accent-blue-light: #218bff;
        --accent-purple: #8250df;
        --accent-orange: #d1650a;
        --accent-gold: #9a6700;
        --accent-gold-hover: #bf8700;

        /* Semantic Colors */
        --success: #1a7f37;
        --error: #cf222e;
        --warning: #9a6700;
    }

    :root:not(.theme-manual) .legend-panel,
    :root:not(.theme-manual) .authors-panel,
    :root:not(.theme-manual) .perf-overlay,
    :root:not(.theme-manual) .stats-overlay {
        background: rgba(246, 248, 250, 0.95);
    }

    :root:not(.theme-manual) #canvas-container {
        background: #e8ecf0;
    }

    :root:not(.theme-manual) .theme-toggle .sun-icon { display: block; }
    :root:not(.theme-manual) .theme-toggle .moon-icon { display: none; }
}

/* =============================================================================
   Backdrop Filter Fallbacks
   ============================================================================= */

/**
 * Progressive enhancement for backdrop-filter.
 * Older browsers (e.g., Firefox <103, older Safari) don't support backdrop-filter.
 * We use @supports to provide fallback with more opaque backgrounds.
 *
 * Strategy: Set solid fallback backgrounds by default, then apply blur
 * with transparent backgrounds when supported.
 */

/* Fallback: more opaque backgrounds when backdrop-filter is not supported */
@supports not (backdrop-filter: blur(1px)) {
    .legend-panel,
    .authors-panel,
    .stats-overlay {
        background: rgba(22, 27, 34, 0.98);
    }

    .perf-overlay {
        background: rgba(13, 17, 23, 0.98);
    }

    .modal-overlay,
    .help-overlay {
        background: rgba(0, 0, 0, 0.85);
    }

    .viz-panel:fullscreen .timeline-container,
    .pseudo-fullscreen .timeline-container {
        background: rgba(22, 27, 34, 0.98);
    }
}

/* Light theme fallbacks */
@supports not (backdrop-filter: blur(1px)) {
    .light-theme .legend-panel,
    .light-theme .authors-panel,
    .light-theme .perf-overlay,
    .light-theme .stats-overlay {
        background: rgba(246, 248, 250, 0.98);
    }
}

/* =============================================================================
   High Contrast Mode (prefers-contrast: more)
   ============================================================================= */

/**
 * Enhanced contrast for users who prefer higher contrast.
 * Increases border visibility and text contrast.
 */

@media (prefers-contrast: more) {
    :root {
        /* High contrast: increase all contrast values above defaults */
        --border: #848d97;          /* ~4.6:1 vs bg-primary (was #6e7681 ~3.8:1) */
        --border-light: #9ca3ab;    /* ~5.7:1 vs bg-primary */
        --text-secondary: #c9d1d9;  /* ~11.6:1 vs bg-primary */
        --text-muted: #b1b8c0;     /* ~8.2:1 vs bg-primary (was #8b949e ~4.86:1, same as default) */
    }

    :root.light-theme {
        --border: #57606a;
        --border-light: #424a53;
        --text-secondary: #24292f;
        --text-muted: #424a53;
    }

    /* Increase border width for better visibility */
    .panel,
    .modal-content,
    .bottom-sheet,
    .legend-panel,
    .stats-overlay,
    .perf-overlay,
    .authors-panel,
    #canvas-container {
        border-width: 2px;
    }

    /* Ensure focus indicators are more visible */
    :focus-visible {
        outline-width: 3px;
        outline-offset: 3px;
    }

    /* Increase button contrast */
    .btn {
        border: 2px solid currentColor;
    }

    .btn:disabled {
        border-color: var(--border);
    }
}

/* =============================================================================
   Windows High Contrast Mode (forced-colors)
   ============================================================================= */

/**
 * Support for Windows High Contrast mode.
 * Uses system colors and removes custom styling that might interfere.
 */

@media (forced-colors: active) {
    /* Reset backgrounds to system colors */
    body,
    header,
    .panel,
    .modal-content,
    .bottom-sheet,
    .sidebar-panel {
        background: Canvas;
        color: CanvasText;
    }

    /* Ensure links are visible */
    a {
        color: LinkText;
    }

    /* Buttons use system button styling */
    .btn,
    .theme-toggle,
    .sidebar-toggle,
    .bottom-sheet-fab,
    .mobile-toolbar-btn {
        background: ButtonFace;
        color: ButtonText;
        border: 2px solid ButtonText;
        forced-color-adjust: none;
    }

    .btn:hover,
    .theme-toggle:hover,
    .sidebar-toggle:hover {
        background: Highlight;
        color: HighlightText;
        border-color: Highlight;
    }

    /* Focus indicators use system highlight */
    :focus-visible {
        outline: 3px solid Highlight;
        outline-offset: 2px;
    }

    /* Ensure form controls are visible */
    input,
    select,
    textarea {
        background: Field;
        color: FieldText;
        border: 2px solid ButtonText;
    }

    /* Checkboxes and switches */
    input[type="checkbox"],
    input[type="radio"],
    .perf-switch input {
        forced-color-adjust: none;
    }

    /* Disabled states */
    .btn:disabled,
    input:disabled {
        color: GrayText;
        border-color: GrayText;
    }

    /* Remove decorative shadows and gradients */
    * {
        box-shadow: none !important;
        text-shadow: none !important;
    }

    /* Ensure SVG icons use current color */
    svg {
        fill: currentColor;
        stroke: currentColor;
    }

    /* Timeline slider track */
    .timeline-slider::-webkit-slider-runnable-track {
        background: ButtonFace;
        border: 1px solid ButtonText;
    }

    .timeline-slider::-moz-range-track {
        background: ButtonFace;
        border: 1px solid ButtonText;
    }

    /* Progress indicators */
    .timeline-progress {
        background: Highlight;
    }
}

/* =============================================================================
   Utility Classes
   ============================================================================= */

/* Visually hidden but accessible to screen readers */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Hidden from everyone including screen readers */
.hidden {
    display: none !important;
}

/* =============================================================================
   Author Filter (Interactive)
   ============================================================================= */

.author-item {
    cursor: pointer;
    padding: 0.25rem;
    margin: -0.25rem;
    border-radius: 4px;
    /* Use composited properties only for better performance */
    transition: opacity 0.15s, transform 0.15s;
}

.author-item:hover {
    background: var(--bg-tertiary);
}

.author-item.filtered {
    opacity: 0.4;
}

.author-item.active {
    background: rgba(233, 69, 96, 0.15);
    border: 1px solid var(--accent);
    margin: calc(-0.25rem - 1px);
    padding: calc(0.25rem - 1px);
}

.author-filter-clear {
    font-size: 0.75rem;
    color: var(--accent);
    cursor: pointer;
    margin-left: auto;
    padding: 0.2rem 0.4rem;
    background: rgba(233, 69, 96, 0.1);
    border-radius: 4px;
    display: none;
}

.author-filter-clear.visible {
    display: block;
}
