<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rource - Software Version Control Visualization</title>
    <meta name="description" content="Visualize your git repository history as an animated tree. Watch your codebase grow as developers collaborate. Runs in your browser with WebAssembly.">
    <meta name="keywords" content="git, visualization, gource, repository, version control, wasm, webassembly">
    <meta name="author" content="Rource Contributors">

    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tomtom215.github.io/rource/">
    <meta property="og:title" content="Rource - Software Version Control Visualization">
    <meta property="og:description" content="Visualize your git repository history as an animated tree. Watch your codebase grow as developers collaborate.">
    <meta property="og:image" content="https://tomtom215.github.io/rource/og-image.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Rource - Software Version Control Visualization">
    <meta name="twitter:description" content="Visualize your git repository history as an animated tree. Runs entirely in your browser.">

    <!-- Favicon (inline SVG as data URI) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23e94560'/><circle cx='50' cy='30' r='8' fill='white'/><circle cx='30' cy='60' r='6' fill='white'/><circle cx='70' cy='55' r='6' fill='white'/><circle cx='50' cy='75' r='5' fill='white'/><line x1='50' y1='38' x2='50' y2='70' stroke='white' stroke-width='2'/><line x1='50' y1='50' x2='32' y2='58' stroke='white' stroke-width='2'/><line x1='50' y1='50' x2='68' y2='53' stroke='white' stroke-width='2'/></svg>">

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#1a1a2e">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f0f23;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --accent-secondary: #533483;
            --text-primary: #eee;
            --text-secondary: #888;
            --border: #333;
            --success: #4ade80;
            --error: #f87171;
            --warning: #fbbf24;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Focus styles for accessibility */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        button:focus-visible, a:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Skip to content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            z-index: 1000;
            text-decoration: none;
            border-radius: 0 0 4px 0;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: 3rem 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, #ff9a9e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero .tagline {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-features {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .hero-feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .hero-feature .icon {
            width: 20px;
            height: 20px;
            fill: var(--accent);
        }

        .hero-cta {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--accent-secondary);
        }

        .btn-secondary:hover {
            background: #6c4298;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .btn-outline:hover {
            background: var(--accent);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent);
        }

        .renderer-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        .renderer-badge.webgl2 {
            color: var(--success);
            border: 1px solid var(--success);
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-links {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .header-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .header-links a:hover {
            color: var(--text-primary);
        }

        .keyboard-shortcuts {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: none;
        }

        @media (min-width: 900px) {
            .keyboard-shortcuts {
                display: block;
            }
        }

        .keyboard-shortcuts kbd {
            background: var(--bg-tertiary);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            margin-right: 0.25rem;
            font-family: inherit;
        }

        /* Main content */
        main {
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        /* Canvas container */
        #canvas-container {
            flex: 1;
            min-height: 400px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Empty state */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .empty-state.hidden {
            display: none;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        /* Legend panel */
        .legend-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(22, 33, 62, 0.95);
            border-radius: 8px;
            padding: 0.75rem;
            max-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        .legend-panel.collapsed {
            max-height: 36px;
            overflow: hidden;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .legend-header h4 {
            font-size: 0.8rem;
            color: var(--accent);
            margin: 0;
        }

        .legend-toggle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .legend-panel.collapsed .legend-toggle {
            transform: rotate(180deg);
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-ext {
            color: #ccc;
        }

        .legend-count {
            color: var(--text-secondary);
            font-size: 0.65rem;
            margin-left: auto;
        }

        /* Info panel */
        .info-panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1rem;
            font-weight: 500;
        }

        .info-value.status-playing { color: var(--success); }
        .info-value.status-paused { color: var(--warning); }
        .info-value.status-error { color: var(--error); }

        /* Timeline */
        .timeline-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .timeline-container label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .timeline-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            outline: none;
        }

        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }

        .timeline-slider::-webkit-slider-thumb:hover {
            background: var(--accent-hover);
            transform: scale(1.1);
        }

        .timeline-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .timeline-slider:disabled {
            opacity: 0.5;
        }

        .timeline-info {
            font-size: 0.85rem;
            color: var(--text-primary);
            min-width: 80px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        /* Input section */
        .input-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
        }

        .input-section h3 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-buttons {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            white-space: nowrap;
            font-size: 0.875rem;
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .tab-btn:hover:not(.active) {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        textarea {
            width: 100%;
            height: 120px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.8rem;
            resize: vertical;
            margin-bottom: 0.75rem;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .help {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            line-height: 1.6;
        }

        .help code {
            background: var(--bg-tertiary);
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            font-size: 0.75rem;
        }

        /* File upload */
        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .file-upload-area:hover,
        .file-upload-area:focus-within {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .file-upload-area.dragover {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.2);
        }

        .file-upload-area input[type="file"] {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .file-upload-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .file-upload-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .file-upload-text strong {
            color: var(--accent);
        }

        .file-name {
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 4px;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Command box */
        .command-box {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .command-box code {
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Loading overlay */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #loading.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--bg-secondary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .loading-subtext {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            opacity: 0.7;
        }

        /* Error toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            transition: transform 0.3s ease;
            max-width: 90%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast-message {
            flex: 1;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
            line-height: 1;
        }

        /* Help modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            color: var(--accent);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            padding: 0.25rem;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-section {
            margin-bottom: 1.5rem;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section h3 {
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .shortcut-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .shortcut-item kbd {
            background: var(--bg-primary);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.8rem;
        }

        /* Footer */
        footer {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            text-align: center;
            border-top: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero {
                padding: 2rem 1rem;
            }

            .hero h1 {
                font-size: 2rem;
            }

            .hero .tagline {
                font-size: 1rem;
            }

            .hero-features {
                gap: 1rem;
            }

            .hero-feature {
                font-size: 0.8rem;
            }

            header {
                padding: 0.75rem 1rem;
            }

            .controls {
                width: 100%;
                justify-content: center;
            }

            main {
                padding: 0.75rem;
            }

            #canvas-container {
                min-height: 300px;
            }

            .info-panel {
                gap: 1rem;
            }

            .timeline-container {
                flex-wrap: wrap;
            }

            .timeline-slider {
                order: 3;
                width: 100%;
            }

            textarea {
                height: 100px;
            }
        }

        @media (max-width: 480px) {
            .hero h1 {
                font-size: 1.75rem;
            }

            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .tab-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }
        }

        /* Utility classes */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div id="loading" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div class="loading-text">Loading Rource...</div>
        <div class="loading-subtext">Initializing WebAssembly module</div>
    </div>

    <!-- Hero section (shown before visualization loaded) -->
    <section id="hero" class="hero">
        <h1>Rource</h1>
        <p class="tagline">
            Visualize your Git repository history as an animated tree.
            Watch your codebase grow as developers collaborate over time.
        </p>
        <div class="hero-features">
            <span class="hero-feature">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                Runs in your browser
            </span>
            <span class="hero-feature">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.92 6-4.72 7.28L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95zM11 2.05C5.94 2.55 2 6.81 2 12c0 3.76 2.09 7.07 5.22 8.78L6 22h5v-5l-2.28 2.28C6.92 18 5 15.21 5 12c0-4.08 3.05-7.44 7-7.93V2.05z"/>
                </svg>
                ~76KB gzipped
            </span>
            <span class="hero-feature">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
                No server needed
            </span>
        </div>
        <div class="hero-cta">
            <button id="btn-try-demo" class="btn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                Try Demo
            </button>
            <a href="https://github.com/tomtom215/rource" class="btn btn-outline" target="_blank" rel="noopener noreferrer">
                View on GitHub
            </a>
        </div>
    </section>

    <header id="app-header" class="hidden">
        <div class="header-brand">
            <h1>Rource</h1>
            <span id="renderer-badge" class="renderer-badge" title="Rendering backend"></span>
        </div>
        <div class="controls">
            <button id="btn-play" class="btn btn-sm" disabled aria-label="Play or pause visualization">
                <svg id="play-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <span id="play-text">Play</span>
            </button>
            <button id="btn-screenshot" class="btn btn-sm btn-secondary" disabled aria-label="Take screenshot">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                Screenshot
            </button>
            <button id="btn-reset" class="btn btn-sm btn-secondary" disabled aria-label="Reset camera position">
                Reset Camera
            </button>
            <button id="btn-help" class="btn btn-sm btn-secondary" aria-label="Show help">?</button>
        </div>
        <div class="header-links">
            <span class="keyboard-shortcuts" aria-label="Keyboard shortcuts hint">
                <kbd>Space</kbd> Play
                <kbd>+/-</kbd> Zoom
                <kbd>S</kbd> Screenshot
            </span>
            <a href="https://github.com/tomtom215/rource" target="_blank" rel="noopener noreferrer" aria-label="View source on GitHub">GitHub</a>
        </div>
    </header>

    <main id="main-content">
        <div id="canvas-container">
            <canvas id="canvas" width="1280" height="720" aria-label="Rource visualization canvas"></canvas>
            <div id="empty-state" class="empty-state">
                <h3>No data loaded</h3>
                <p>Load a log file or try the demo to get started</p>
            </div>
            <div id="legend-panel" class="legend-panel collapsed" role="complementary" aria-label="File type legend">
                <div class="legend-header" id="legend-toggle" role="button" tabindex="0" aria-expanded="false" aria-controls="legend-items">
                    <h4>File Types</h4>
                    <span class="legend-toggle" aria-hidden="true">â–¼</span>
                </div>
                <div class="legend-items" id="legend-items" role="list">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <div class="timeline-container" role="group" aria-label="Timeline controls">
            <label for="timeline-slider">Timeline:</label>
            <input type="range" id="timeline-slider" class="timeline-slider" min="0" max="0" value="0" disabled aria-valuemin="0" aria-valuemax="0" aria-valuenow="0">
            <span class="timeline-info" id="timeline-info" aria-live="polite">0 / 0</span>
        </div>

        <div class="info-panel" role="status" aria-label="Visualization status">
            <div class="info-item">
                <span class="info-label">Status</span>
                <span class="info-value" id="status">Loading...</span>
            </div>
            <div class="info-item">
                <span class="info-label">Commits</span>
                <span class="info-value" id="commit-count">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">Current</span>
                <span class="info-value" id="current-commit">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">Speed</span>
                <span class="info-value" id="speed">10.0</span>
            </div>
        </div>

        <div class="input-section" role="region" aria-label="Load data">
            <h3>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Load Log Data
            </h3>

            <div class="tab-buttons" role="tablist" aria-label="Input methods">
                <button class="tab-btn active" data-tab="paste" role="tab" aria-selected="true" aria-controls="tab-paste" id="tab-btn-paste">Paste Text</button>
                <button class="tab-btn" data-tab="upload" role="tab" aria-selected="false" aria-controls="tab-upload" id="tab-btn-upload">Upload File</button>
                <button class="tab-btn" data-tab="git-command" role="tab" aria-selected="false" aria-controls="tab-git-command" id="tab-btn-git-command">Git Command</button>
            </div>

            <div id="tab-paste" class="tab-content active" role="tabpanel" aria-labelledby="tab-btn-paste">
                <label for="log-input" class="visually-hidden">Log data in custom format</label>
                <textarea id="log-input" placeholder="Paste your log data here..."></textarea>
                <button id="btn-load" class="btn btn-sm" disabled>Load Log</button>
                <p class="help">
                    Format: <code>timestamp|author|action|path</code> (one per line)<br>
                    Actions: <code>A</code>=Add, <code>M</code>=Modify, <code>D</code>=Delete
                </p>
            </div>

            <div id="tab-upload" class="tab-content" role="tabpanel" aria-labelledby="tab-btn-upload" hidden>
                <div class="file-upload-area" id="file-drop-zone" role="button" tabindex="0" aria-label="Click to upload or drag and drop a file">
                    <input type="file" id="file-input" accept=".txt,.log,.csv" aria-describedby="upload-help">
                    <div class="file-upload-icon" aria-hidden="true">&#128194;</div>
                    <div class="file-upload-text">
                        <strong>Click to upload</strong> or drag and drop<br>
                        Supports .txt, .log files
                    </div>
                </div>
                <div id="file-name" class="file-name" aria-live="polite"></div>
                <label for="file-format" class="visually-hidden">Select file format</label>
                <select id="file-format">
                    <option value="auto">Auto-detect format</option>
                    <option value="custom">Custom format (timestamp|author|action|path)</option>
                    <option value="git">Git log format</option>
                </select>
                <button id="btn-load-file" class="btn btn-sm" disabled>Load Uploaded File</button>
                <p class="help" id="upload-help">
                    Upload a log file from your local machine.<br>
                    Supports custom format and git log output.
                </p>
            </div>

            <div id="tab-git-command" class="tab-content" role="tabpanel" aria-labelledby="tab-btn-git-command" hidden>
                <p class="help" style="margin-bottom: 1rem;">
                    Run this command in your repository to generate a compatible log file:
                </p>
                <div class="command-box">
                    <code id="git-command">git log --reverse --date=raw --pretty=format:"%ad|%an" --name-status | awk -F'|' '/^[0-9]/ {ts=$1; author=$2} /^[AMD]\t/ {print ts "|" author "|" substr($0,1,1) "|" substr($0,3)}'</code>
                </div>
                <button id="btn-copy-command" class="btn btn-sm btn-secondary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                    Copy Command
                </button>
                <p class="help" style="margin-top: 0.75rem;">
                    Then upload the output file or paste its contents in the "Paste Text" tab.
                </p>
            </div>
        </div>
    </main>

    <footer>
        <p>
            <strong>Rource</strong> &mdash; A Rust + WebAssembly rewrite of <a href="https://gource.io" target="_blank" rel="noopener noreferrer">Gource</a>
            &nbsp;|&nbsp;
            <a href="https://github.com/tomtom215/rource" target="_blank" rel="noopener noreferrer">Source Code</a>
            &nbsp;|&nbsp;
            GPL-3.0 License
        </p>
    </footer>

    <!-- Toast notification -->
    <div id="toast" class="toast" role="alert" aria-live="assertive">
        <span class="toast-message"></span>
        <button class="toast-close" aria-label="Close notification">&times;</button>
    </div>

    <!-- Help modal -->
    <div id="help-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
        <div class="modal">
            <div class="modal-header">
                <h2 id="help-modal-title">Keyboard Shortcuts & Help</h2>
                <button class="modal-close" aria-label="Close help">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3>Playback Controls</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item"><span>Play / Pause</span><kbd>Space</kbd></div>
                        <div class="shortcut-item"><span>Step Forward</span><kbd>&gt;</kbd></div>
                        <div class="shortcut-item"><span>Step Backward</span><kbd>&lt;</kbd></div>
                    </div>
                </div>
                <div class="modal-section">
                    <h3>Camera Controls</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item"><span>Zoom In</span><kbd>+</kbd> or <kbd>=</kbd></div>
                        <div class="shortcut-item"><span>Zoom Out</span><kbd>-</kbd></div>
                        <div class="shortcut-item"><span>Reset Camera</span><kbd>R</kbd></div>
                        <div class="shortcut-item"><span>Pan</span><kbd>Arrow Keys</kbd></div>
                    </div>
                </div>
                <div class="modal-section">
                    <h3>Mouse / Touch</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item"><span>Pan View</span>Drag</div>
                        <div class="shortcut-item"><span>Zoom</span>Scroll / Pinch</div>
                    </div>
                </div>
                <div class="modal-section">
                    <h3>Other</h3>
                    <div class="shortcut-list">
                        <div class="shortcut-item"><span>Screenshot</span><kbd>S</kbd></div>
                        <div class="shortcut-item"><span>Show Help</span><kbd>?</kbd></div>
                    </div>
                </div>
                <div class="modal-section">
                    <h3>About Rource</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                        Rource visualizes software version control history as an animated tree.
                        Each file is a node, each developer has a unique color, and commits create
                        "beams" connecting developers to the files they modify.
                    </p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; margin-top: 0.5rem;">
                        Built with Rust and WebAssembly, Rource runs entirely in your browser with
                        no server required. It's a modern rewrite of the original
                        <a href="https://gource.io" target="_blank" rel="noopener" style="color: var(--accent);">Gource</a> tool.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { Rource } from './pkg/rource_wasm.js';

        // State
        let rource = null;
        let animationId = null;
        let uploadedFileContent = null;
        let hasLoadedData = false;

        // Demo data - simulates a small project evolution
        const DEMO_DATA = `1704067200|Alice|A|src/main.rs
1704067260|Alice|A|src/lib.rs
1704067320|Alice|A|Cargo.toml
1704067380|Alice|A|README.md
1704153600|Bob|A|src/config.rs
1704153660|Bob|M|src/main.rs
1704153720|Bob|A|src/utils/mod.rs
1704153780|Bob|A|src/utils/helpers.rs
1704240000|Charlie|A|tests/test_main.rs
1704240060|Charlie|M|src/lib.rs
1704240120|Charlie|A|tests/test_config.rs
1704326400|Alice|M|src/main.rs
1704326460|Alice|M|src/config.rs
1704326520|Alice|A|docs/API.md
1704412800|Bob|A|src/api/mod.rs
1704412860|Bob|A|src/api/routes.rs
1704412920|Bob|A|src/api/handlers.rs
1704412980|Bob|M|src/main.rs
1704499200|Charlie|A|src/db/mod.rs
1704499260|Charlie|A|src/db/models.rs
1704499320|Charlie|A|src/db/queries.rs
1704499380|Charlie|M|src/api/handlers.rs
1704585600|Alice|A|src/auth/mod.rs
1704585660|Alice|A|src/auth/jwt.rs
1704585720|Alice|M|src/api/routes.rs
1704585780|Alice|A|tests/test_auth.rs
1704672000|Bob|M|src/db/queries.rs
1704672060|Bob|M|src/api/handlers.rs
1704672120|Bob|A|migrations/001_initial.sql
1704758400|Charlie|A|.github/workflows/ci.yml
1704758460|Charlie|M|Cargo.toml
1704758520|Charlie|A|Dockerfile
1704844800|Alice|M|README.md
1704844860|Alice|A|docs/DEPLOY.md
1704844920|Alice|M|src/main.rs
1704931200|Bob|D|src/utils/helpers.rs
1704931260|Bob|A|src/utils/string.rs
1704931320|Bob|A|src/utils/time.rs
1704931380|Bob|M|src/utils/mod.rs
1705017600|Charlie|M|src/auth/jwt.rs
1705017660|Charlie|A|src/auth/middleware.rs
1705017720|Charlie|M|src/api/routes.rs`;

        // UI elements
        const canvas = document.getElementById('canvas');
        const btnPlay = document.getElementById('btn-play');
        const playIcon = document.getElementById('play-icon');
        const playText = document.getElementById('play-text');
        const btnReset = document.getElementById('btn-reset');
        const btnLoad = document.getElementById('btn-load');
        const btnLoadFile = document.getElementById('btn-load-file');
        const btnCopyCommand = document.getElementById('btn-copy-command');
        const btnScreenshot = document.getElementById('btn-screenshot');
        const btnHelp = document.getElementById('btn-help');
        const btnTryDemo = document.getElementById('btn-try-demo');
        const logInput = document.getElementById('log-input');
        const statusEl = document.getElementById('status');
        const commitCountEl = document.getElementById('commit-count');
        const currentCommitEl = document.getElementById('current-commit');
        const speedEl = document.getElementById('speed');
        const loadingEl = document.getElementById('loading');
        const heroEl = document.getElementById('hero');
        const appHeader = document.getElementById('app-header');
        const timelineSlider = document.getElementById('timeline-slider');
        const timelineInfo = document.getElementById('timeline-info');
        const fileInput = document.getElementById('file-input');
        const fileDropZone = document.getElementById('file-drop-zone');
        const fileNameEl = document.getElementById('file-name');
        const fileFormatSelect = document.getElementById('file-format');
        const emptyState = document.getElementById('empty-state');
        const rendererBadge = document.getElementById('renderer-badge');
        const toast = document.getElementById('toast');
        const helpModal = document.getElementById('help-modal');

        // Toast notification
        function showToast(message, type = 'error', duration = 5000) {
            toast.querySelector('.toast-message').textContent = message;
            toast.className = `toast ${type} visible`;

            setTimeout(() => {
                toast.classList.remove('visible');
            }, duration);
        }

        toast.querySelector('.toast-close').addEventListener('click', () => {
            toast.classList.remove('visible');
        });

        // Help modal
        function openHelpModal() {
            helpModal.classList.add('visible');
            helpModal.querySelector('.modal-close').focus();
        }

        function closeHelpModal() {
            helpModal.classList.remove('visible');
            btnHelp.focus();
        }

        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) closeHelpModal();
        });

        helpModal.querySelector('.modal-close').addEventListener('click', closeHelpModal);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && helpModal.classList.contains('visible')) {
                closeHelpModal();
            }
            if (e.key === '?' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                openHelpModal();
            }
        });

        btnHelp.addEventListener('click', openHelpModal);

        // Resize canvas to fit container
        function resizeCanvas() {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            if (canvas.width !== width || canvas.height !== height) {
                canvas.width = width;
                canvas.height = height;
                if (rource) {
                    rource.resize(width, height);
                    rource.forceRender();
                }
            }
        }

        // Animation loop
        function animate(timestamp) {
            if (rource) {
                rource.frame(timestamp);
                updateUI();
            }
            animationId = requestAnimationFrame(animate);
        }

        // Update UI elements
        function updateUI() {
            if (!rource) return;

            const playing = rource.isPlaying();
            const total = rource.commitCount();
            const current = rource.currentCommit();

            // Update play button
            playText.textContent = playing ? 'Pause' : 'Play';
            playIcon.innerHTML = playing
                ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'
                : '<path d="M8 5v14l11-7z"/>';
            btnPlay.setAttribute('aria-label', playing ? 'Pause visualization' : 'Play visualization');

            currentCommitEl.textContent = current;
            speedEl.textContent = rource.getSpeed().toFixed(1);

            // Update status with styling
            const statusText = playing ? 'Playing' : (current >= total ? 'Finished' : 'Paused');
            statusEl.textContent = statusText;
            statusEl.className = 'info-value' + (playing ? ' status-playing' : ' status-paused');

            // Update timeline slider
            if (total > 0) {
                timelineSlider.max = total - 1;
                timelineSlider.value = Math.min(current, total - 1);
                timelineSlider.disabled = false;
                timelineSlider.setAttribute('aria-valuemax', total - 1);
                timelineSlider.setAttribute('aria-valuenow', Math.min(current, total - 1));
                timelineInfo.textContent = `${current} / ${total}`;
            } else {
                timelineSlider.max = 0;
                timelineSlider.value = 0;
                timelineSlider.disabled = true;
                timelineInfo.textContent = '0 / 0';
            }
        }

        // Load log data and update UI
        function loadLogData(content, format) {
            if (!rource || !content.trim()) {
                showToast('Please enter or upload log data first.', 'error');
                return;
            }

            try {
                let count;
                if (format === 'git') {
                    count = rource.loadGitLog(content);
                } else {
                    // custom or auto - try custom first
                    count = rource.loadCustomLog(content);
                }

                if (count === 0) {
                    showToast('No commits found. Check your log format.', 'error');
                    return;
                }

                commitCountEl.textContent = count;
                statusEl.textContent = `Loaded ${count} commits`;
                hasLoadedData = true;
                emptyState.classList.add('hidden');
                updateUI();
                updateLegend(content);

                // Show success toast
                showToast(`Loaded ${count} commits successfully!`, 'success', 3000);

                // Switch to app mode (hide hero)
                switchToAppMode();

            } catch (e) {
                const errorMsg = e.toString();
                statusEl.textContent = 'Parse error';
                statusEl.className = 'info-value status-error';
                showToast(`Failed to parse log: ${errorMsg}`, 'error');
                console.error('Failed to parse log:', e);
            }
        }

        // Switch from landing page to app mode
        function switchToAppMode() {
            heroEl.classList.add('hidden');
            appHeader.classList.remove('hidden');
        }

        // File extension color mapping (matches rource-core/src/scene/file.rs)
        const extensionColors = {
            'rs': '#dea584', 'go': '#00add8', 'py': '#3572a5', 'pyi': '#3572a5',
            'js': '#f7df1e', 'mjs': '#f7df1e', 'cjs': '#f7df1e',
            'ts': '#3178c6', 'mts': '#3178c6', 'cts': '#3178c6',
            'jsx': '#61dafb', 'tsx': '#61dafb',
            'java': '#b07219', 'kt': '#a78bfa', 'kts': '#a78bfa',
            'c': '#5555ff', 'h': '#5555ff',
            'cpp': '#00599c', 'cc': '#00599c', 'cxx': '#00599c', 'hpp': '#00599c',
            'cs': '#9b4f96', 'fs': '#b845fc', 'fsx': '#b845fc',
            'rb': '#cc342d', 'php': '#4f5d95', 'swift': '#f05138',
            'html': '#e34c26', 'htm': '#e34c26', 'css': '#563d7c',
            'scss': '#cd6799', 'sass': '#cd6799', 'less': '#cd6799',
            'json': '#808080', 'yaml': '#cb171e', 'yml': '#cb171e',
            'toml': '#9c4221', 'xml': '#0060ac', 'md': '#083fa1',
            'sh': '#008000', 'bash': '#008000', 'zsh': '#008000',
            'dockerfile': '#2496ed', 'sql': '#e38c00', 'graphql': '#e535ab'
        };

        function hashExtension(ext) {
            let hash = 0;
            for (let i = 0; i < ext.length; i++) {
                hash = (hash * 31 + ext.charCodeAt(i)) >>> 0;
            }
            const hue = hash % 360;
            return `hsl(${hue}, 50%, 50%)`;
        }

        function getExtensionColor(ext) {
            const lower = ext.toLowerCase();
            return extensionColors[lower] || hashExtension(lower);
        }

        // Update file type legend
        function updateLegend(content) {
            const legendItems = document.getElementById('legend-items');
            const extensionCounts = {};

            const lines = content.split('\n');
            for (const line of lines) {
                let path = '';
                if (line.includes('|')) {
                    const parts = line.split('|');
                    if (parts.length >= 4) {
                        path = parts[3].trim();
                    }
                } else if (line.includes('\t')) {
                    const parts = line.split('\t');
                    if (parts.length >= 2) {
                        path = parts[parts.length - 1].trim();
                    }
                }

                if (path) {
                    const dotIdx = path.lastIndexOf('.');
                    if (dotIdx > 0 && dotIdx < path.length - 1) {
                        const ext = path.substring(dotIdx + 1).toLowerCase();
                        if (ext.length <= 10) {
                            extensionCounts[ext] = (extensionCounts[ext] || 0) + 1;
                        }
                    }
                }
            }

            const sorted = Object.entries(extensionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            legendItems.innerHTML = sorted.map(([ext, count]) => {
                const color = getExtensionColor(ext);
                return `<div class="legend-item" role="listitem">
                    <span class="legend-color" style="background: ${color}" aria-hidden="true"></span>
                    <span class="legend-ext">.${ext}</span>
                    <span class="legend-count">${count}</span>
                </div>`;
            }).join('');

            if (sorted.length > 0) {
                document.getElementById('legend-panel').classList.remove('collapsed');
                document.getElementById('legend-toggle').setAttribute('aria-expanded', 'true');
            }
        }

        // Legend toggle
        const legendToggle = document.getElementById('legend-toggle');
        legendToggle.addEventListener('click', () => {
            const panel = document.getElementById('legend-panel');
            panel.classList.toggle('collapsed');
            const isExpanded = !panel.classList.contains('collapsed');
            legendToggle.setAttribute('aria-expanded', isExpanded.toString());
            const toggle = panel.querySelector('.legend-toggle');
            toggle.textContent = isExpanded ? 'â–²' : 'â–¼';
        });

        legendToggle.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                legendToggle.click();
            }
        });

        // Initialize
        async function main() {
            try {
                await init();

                resizeCanvas();
                rource = new Rource(canvas);

                // Update renderer badge
                const isWebGL2 = rource.isWebGL2();
                rendererBadge.textContent = isWebGL2 ? 'WebGL2' : 'Software';
                if (isWebGL2) {
                    rendererBadge.classList.add('webgl2');
                }

                // Enable buttons
                btnPlay.disabled = false;
                btnReset.disabled = false;
                btnScreenshot.disabled = false;
                btnLoad.disabled = false;
                btnTryDemo.disabled = false;

                // Start animation loop
                animationId = requestAnimationFrame(animate);

                // Hide loading
                loadingEl.classList.add('hidden');
                statusEl.textContent = 'Ready';

            } catch (e) {
                console.error('Failed to initialize:', e);
                statusEl.textContent = 'Error';
                statusEl.className = 'info-value status-error';
                loadingEl.querySelector('.loading-text').textContent = 'Failed to load';
                loadingEl.querySelector('.loading-subtext').textContent = e.message || 'Unknown error';
                showToast(`Initialization failed: ${e.message}`, 'error', 10000);
            }
        }

        // Event handlers
        btnPlay.addEventListener('click', () => {
            if (rource) {
                if (!hasLoadedData) {
                    showToast('Load some data first using the options below, or click "Try Demo".', 'error');
                    return;
                }
                rource.togglePlay();
                updateUI();
            }
        });

        btnReset.addEventListener('click', () => {
            if (rource) {
                rource.resetCamera();
            }
        });

        // Try Demo button
        btnTryDemo.addEventListener('click', () => {
            if (rource) {
                loadLogData(DEMO_DATA, 'custom');
                rource.play();
                updateUI();
            }
        });

        // Screenshot
        btnScreenshot.addEventListener('click', takeScreenshot);

        function takeScreenshot() {
            if (!rource) return;

            try {
                const pngData = rource.captureScreenshot();
                const blob = new Blob([pngData], { type: 'image/png' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `rource_screenshot_${Date.now()}.png`;
                a.click();

                URL.revokeObjectURL(url);
                showToast('Screenshot saved!', 'success', 2000);
            } catch (e) {
                console.error('Screenshot failed:', e);
                showToast(`Screenshot failed: ${e}`, 'error');
            }
        }

        btnLoad.addEventListener('click', () => {
            if (rource && logInput.value.trim()) {
                loadLogData(logInput.value, 'custom');
            } else {
                showToast('Please paste some log data first.', 'error');
            }
        });

        // Timeline slider
        timelineSlider.addEventListener('input', () => {
            if (rource) {
                const index = parseInt(timelineSlider.value, 10);
                rource.pause();
                rource.seek(index);
                updateUI();
            }
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                // Update active button
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-selected', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');

                // Update visible content
                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                    c.setAttribute('hidden', '');
                });
                const tabContent = document.getElementById(`tab-${tab}`);
                tabContent.classList.add('active');
                tabContent.removeAttribute('hidden');
            });
        });

        // File upload
        fileDropZone.addEventListener('click', () => fileInput.click());

        fileDropZone.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFileUpload(file);
        });

        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('dragover');
        });

        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('dragover');
        });

        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFileUpload(file);
        });

        function handleFileUpload(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showToast('File too large. Maximum size is 10MB.', 'error');
                return;
            }

            fileNameEl.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFileContent = e.target.result;
                btnLoadFile.disabled = false;
                showToast(`File "${file.name}" ready to load.`, 'success', 2000);
            };
            reader.onerror = () => {
                showToast('Error reading file. Please try again.', 'error');
                btnLoadFile.disabled = true;
            };
            reader.readAsText(file);
        }

        btnLoadFile.addEventListener('click', () => {
            if (uploadedFileContent) {
                const format = fileFormatSelect.value;
                loadLogData(uploadedFileContent, format);
            }
        });

        // Copy git command
        btnCopyCommand.addEventListener('click', async () => {
            const command = document.getElementById('git-command').textContent;
            try {
                await navigator.clipboard.writeText(command);
                btnCopyCommand.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    Copied!
                `;
                setTimeout(() => {
                    btnCopyCommand.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                        Copy Command
                    `;
                }, 2000);
            } catch (err) {
                showToast('Failed to copy command. Please copy manually.', 'error');
            }
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

            // Screenshot
            if (e.key === 's' || e.key === 'S') {
                takeScreenshot();
                return;
            }

            // Help
            if (e.key === '?') {
                e.preventDefault();
                openHelpModal();
                return;
            }

            if (rource) {
                rource.onKeyDown(e.key);
                updateUI();
            }
        });

        // Mouse controls
        canvas.addEventListener('mousedown', (e) => {
            if (rource) {
                const rect = canvas.getBoundingClientRect();
                rource.onMouseDown(e.clientX - rect.left, e.clientY - rect.top);
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (rource) rource.onMouseUp();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (rource) {
                const rect = canvas.getBoundingClientRect();
                rource.onMouseMove(e.clientX - rect.left, e.clientY - rect.top);
            }
        });

        canvas.addEventListener('wheel', (e) => {
            if (rource) {
                e.preventDefault();
                rource.onWheel(e.deltaY);
            }
        }, { passive: false });

        // Touch controls
        let touchState = {
            startX: 0,
            startY: 0,
            lastX: 0,
            lastY: 0,
            initialDistance: 0,
            isPanning: false,
            isPinching: false
        };

        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();

            if (e.touches.length === 1) {
                touchState.isPanning = true;
                touchState.isPinching = false;
                touchState.startX = e.touches[0].clientX - rect.left;
                touchState.startY = e.touches[0].clientY - rect.top;
                touchState.lastX = touchState.startX;
                touchState.lastY = touchState.startY;
                if (rource) {
                    rource.onMouseDown(touchState.startX, touchState.startY);
                }
            } else if (e.touches.length === 2) {
                touchState.isPanning = false;
                touchState.isPinching = true;
                touchState.initialDistance = getTouchDistance(e.touches);
                if (rource) {
                    rource.onMouseUp();
                }
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();

            if (touchState.isPanning && e.touches.length === 1) {
                const x = e.touches[0].clientX - rect.left;
                const y = e.touches[0].clientY - rect.top;
                if (rource) {
                    rource.onMouseMove(x, y);
                }
                touchState.lastX = x;
                touchState.lastY = y;
            } else if (touchState.isPinching && e.touches.length === 2) {
                const currentDistance = getTouchDistance(e.touches);
                const scaleFactor = currentDistance / touchState.initialDistance;

                if (rource && Math.abs(scaleFactor - 1.0) > 0.01) {
                    if (scaleFactor > 1.0) {
                        rource.zoom(1.05);
                    } else {
                        rource.zoom(0.95);
                    }
                    touchState.initialDistance = currentDistance;
                }
            }
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (rource && touchState.isPanning) {
                rource.onMouseUp();
            }
            touchState.isPanning = false;
            touchState.isPinching = false;
        }, { passive: false });

        canvas.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            if (rource) {
                rource.onMouseUp();
            }
            touchState.isPanning = false;
            touchState.isPinching = false;
        }, { passive: false });

        // Handle resize
        window.addEventListener('resize', resizeCanvas);

        // Start
        main();
    </script>
</body>
</html>
