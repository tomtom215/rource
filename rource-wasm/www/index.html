<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rource - Software Version Control Visualization</title>
    <meta name="description" content="Visualize your git repository history as an animated tree. Watch your codebase grow as developers collaborate. Runs in your browser with WebAssembly.">
    <meta name="keywords" content="git, visualization, gource, repository, version control, wasm, webassembly, rust">
    <meta name="author" content="Rource Contributors">

    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tomtom215.github.io/rource/">
    <meta property="og:title" content="Rource - Software Version Control Visualization">
    <meta property="og:description" content="Visualize your git repository history as an animated tree. Watch your codebase grow as developers collaborate.">
    <meta property="og:image" content="https://tomtom215.github.io/rource/og-image.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Rource - Software Version Control Visualization">
    <meta name="twitter:description" content="Visualize your git repository history as an animated tree. Runs entirely in your browser.">

    <!-- Favicon (inline SVG as data URI) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23e94560'/><circle cx='50' cy='30' r='8' fill='white'/><circle cx='30' cy='60' r='6' fill='white'/><circle cx='70' cy='55' r='6' fill='white'/><circle cx='50' cy='75' r='5' fill='white'/><line x1='50' y1='38' x2='50' y2='70' stroke='white' stroke-width='2'/><line x1='50' y1='50' x2='32' y2='58' stroke='white' stroke-width='2'/><line x1='50' y1='50' x2='68' y2='53' stroke='white' stroke-width='2'/></svg>">

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#1a1a2e">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-canvas: #010409;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --accent-secondary: #238636;
            --accent-blue: #58a6ff;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --border: #30363d;
            --border-light: #484f58;
            --success: #3fb950;
            --error: #f85149;
            --warning: #d29922;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            display: flex;
            flex-direction: column;
        }

        /* Focus styles for accessibility */
        :focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Skip to content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            z-index: 1000;
            text-decoration: none;
            border-radius: 0 0 4px 0;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 0.75rem;
            flex-shrink: 0;
            z-index: 100;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-brand a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: var(--text-primary);
        }

        .header-brand a:hover {
            text-decoration: none;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
        }

        header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent) 0%, #ff9a9e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .renderer-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            color: var(--text-muted);
            border: 1px solid var(--border);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .renderer-badge.webgl2 {
            color: var(--success);
            border-color: var(--success);
            background: rgba(63, 185, 80, 0.1);
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .header-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .github-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .github-link:hover {
            color: var(--text-primary);
            border-color: var(--border-light);
            background: var(--bg-tertiary);
            text-decoration: none;
        }

        .github-link svg {
            fill: currentColor;
        }

        /* Buttons */
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--accent-hover);
            text-decoration: none;
        }

        .btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
            border-color: var(--border-light);
        }

        .btn-secondary.active {
            background: var(--accent-secondary);
            border-color: var(--accent-secondary);
            color: white;
        }

        .btn-secondary.active:hover {
            background: #2ea043;
            border-color: #2ea043;
        }

        .btn-success {
            background: var(--accent-secondary);
        }

        .btn-success:hover {
            background: #2ea043;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .btn-outline:hover {
            background: var(--accent);
            color: white;
        }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        /* Main Layout - Full viewport, no scrolling */
        .app-container {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 1rem;
            padding: 1rem;
            flex: 1;
            min-height: 0; /* Critical for flex children to shrink properly */
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 0.5rem;
                gap: 0.5rem;
            }
        }

        /* Visualization Panel */
        .viz-panel {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 0; /* Allow shrinking in flex container */
            overflow: hidden;
        }

        #canvas-container {
            flex: 1;
            min-height: 200px; /* Minimum usable size */
            background: var(--bg-canvas);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
        }

        @media (max-width: 768px) {
            #canvas-container {
                min-height: 250px;
            }
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Empty state */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
            pointer-events: none;
            max-width: 400px;
            padding: 2rem;
        }

        .empty-state.hidden {
            display: none;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            opacity: 0.4;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Context lost overlay */
        .context-lost-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(13, 17, 23, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }

        .context-lost-overlay.hidden {
            display: none;
        }

        .context-lost-content {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
        }

        .context-lost-icon {
            width: 64px;
            height: 64px;
            color: var(--warning);
            margin-bottom: 1rem;
        }

        .context-lost-content h3 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .context-lost-content p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .context-lost-content .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Legend panel */
        .legend-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(22, 27, 34, 0.95);
            border-radius: 8px;
            padding: 0.75rem;
            max-width: 180px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 50;
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            font-size: 0.75rem;
        }

        .legend-panel.collapsed {
            max-height: 32px;
            overflow: hidden;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .legend-header h4 {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .legend-toggle {
            font-size: 0.7rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .legend-panel.collapsed .legend-toggle {
            transform: rotate(180deg);
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-ext {
            color: var(--text-secondary);
            flex: 1;
        }

        .legend-count {
            color: var(--text-muted);
            font-size: 0.65rem;
        }

        /* Stats overlay */
        .stats-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(22, 27, 34, 0.9);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.65rem;
            text-transform: uppercase;
        }

        /* Performance overlay (FPS, metrics) */
        .perf-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(13, 17, 23, 0.92);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.7rem;
            min-width: 140px;
            z-index: 60;
        }

        .perf-overlay.collapsed {
            min-width: auto;
        }

        .perf-overlay.collapsed .perf-details {
            display: none;
        }

        .perf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.4rem;
        }

        .perf-overlay.collapsed .perf-header {
            margin-bottom: 0;
        }

        .perf-fps {
            font-weight: 700;
            font-size: 0.85rem;
        }

        .perf-fps.good { color: var(--success); }
        .perf-fps.ok { color: var(--warning); }
        .perf-fps.bad { color: var(--error); }
        .perf-fps.paused { color: var(--text-secondary); }
        .perf-fps.complete { color: var(--accent-blue); }

        .perf-toggle {
            color: var(--text-muted);
            font-size: 0.65rem;
            transition: transform 0.2s;
        }

        .perf-overlay.collapsed .perf-toggle {
            transform: rotate(180deg);
        }

        .perf-details {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            border-top: 1px solid var(--border);
            padding-top: 0.4rem;
        }

        .perf-row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
        }

        .perf-label {
            color: var(--text-muted);
        }

        .perf-value {
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        /* Technical info panel */
        .tech-info-panel {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.08) 0%, rgba(233, 69, 96, 0.08) 100%);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .tech-info-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .tech-info-header svg {
            color: var(--accent-blue);
        }

        .tech-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .tech-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            padding: 0.5rem;
            text-align: center;
        }

        .tech-item-value {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--accent-blue);
            font-variant-numeric: tabular-nums;
        }

        .tech-item-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tech-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-top: 0.75rem;
        }

        .tech-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .tech-badge.highlight {
            background: rgba(233, 69, 96, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Timeline */
        .timeline-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 1px solid var(--border);
        }

        .timeline-controls {
            display: flex;
            gap: 0.25rem;
        }

        .timeline-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .timeline-btn:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .timeline-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .timeline-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .timeline-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }

        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .timeline-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .timeline-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .timeline-slider:disabled {
            opacity: 0.5;
        }

        .timeline-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            min-width: 80px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-left: 0.75rem;
            border-left: 1px solid var(--border);
        }

        .speed-control label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .speed-control select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        /* Sidebar Panel - Scrollable independent of main content */
        .sidebar-panel {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0; /* Critical for overflow in flex/grid children */
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .sidebar-panel::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-panel::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .sidebar-panel::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        @media (max-width: 1200px) {
            .sidebar-panel {
                max-height: 40vh;
                flex-shrink: 0;
            }
        }

        @media (max-width: 768px) {
            .sidebar-panel {
                max-height: 35vh;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-tertiary);
        }

        .panel-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-header .badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            background: var(--accent);
            color: white;
            border-radius: 10px;
            font-weight: 500;
        }

        .panel-body {
            padding: 1rem;
        }

        /* GitHub URL Input */
        .github-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .github-input-group input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .github-input-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }

        .github-input-group input::placeholder {
            color: var(--text-muted);
        }

        .popular-repos {
            margin-top: 0.75rem;
        }

        .popular-repos-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            display: block;
        }

        .repo-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .repo-chip {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.3rem 0.6rem;
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .repo-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .repo-chip svg {
            width: 12px;
            height: 12px;
        }

        /* Loading state for fetch */
        .fetch-status {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.8rem;
            display: none;
        }

        .fetch-status.visible {
            display: block;
        }

        .fetch-status.loading {
            color: var(--accent-blue);
        }

        .fetch-status.error {
            color: var(--error);
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .fetch-status.success {
            color: var(--success);
            background: rgba(63, 185, 80, 0.1);
            border: 1px solid rgba(63, 185, 80, 0.3);
        }

        .fetch-progress {
            margin-top: 0.5rem;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .fetch-progress-bar {
            height: 100%;
            background: var(--accent-blue);
            width: 0%;
            transition: width 0.3s;
        }

        /* Tab navigation */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        .tab-btn {
            flex: 1;
            padding: 0.6rem 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.03);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
            padding: 1rem;
        }

        .tab-content.active {
            display: block;
        }

        /* Textarea */
        textarea {
            width: 100%;
            height: 100px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem;
            border-radius: 6px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
            resize: vertical;
            margin-bottom: 0.75rem;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* File upload */
        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .file-upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .file-upload-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .file-upload-text strong {
            color: var(--accent);
        }

        .file-name {
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        /* Command box */
        .command-box {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 6px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.7rem;
            overflow-x: auto;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }

        .command-box code {
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Help text */
        .help-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .help-text code {
            background: var(--bg-tertiary);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        /* Documentation Panel */
        .docs-panel {
            /* Removed max-height to show all content */
        }

        .docs-section {
            margin-bottom: 1.25rem;
        }

        .docs-section:last-child {
            margin-bottom: 0;
        }

        .docs-section h4 {
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .docs-section p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .shortcut-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .shortcut-item kbd {
            background: var(--bg-primary);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.7rem;
            border: 1px solid var(--border);
        }

        .feature-list {
            list-style: none;
        }

        .feature-list li {
            padding: 0.3rem 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feature-list li::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Showcase panel (prominent Rource visualization) */
        .showcase-panel {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.15) 0%, rgba(88, 166, 255, 0.15) 100%);
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .showcase-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-blue), var(--accent));
        }

        .showcase-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.6rem;
            padding: 0.2rem 0.5rem;
            background: var(--accent);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .showcase-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 0.75rem;
        }

        .showcase-panel h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .showcase-panel p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .showcase-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.3);
        }

        .showcase-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.4);
        }

        .showcase-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .showcase-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .showcase-btn-secondary {
            flex: 0 0 auto;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: all 0.2s ease;
        }

        .showcase-btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .showcase-btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .showcase-btn-secondary.loading {
            pointer-events: none;
        }

        .showcase-btn-secondary.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .refresh-status {
            margin-top: 0.5rem;
            font-size: 0.7rem;
            text-align: center;
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
        }

        .refresh-status.success {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .refresh-status.error {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .refresh-status.loading {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .showcase-stats {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .showcase-stat {
            text-align: center;
        }

        .showcase-stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .showcase-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Authors legend panel */
        .authors-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(22, 27, 34, 0.95);
            border-radius: 8px;
            padding: 0.75rem;
            max-width: 200px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            font-size: 0.75rem;
        }

        .authors-panel.collapsed {
            max-height: 32px;
            overflow: hidden;
        }

        .authors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .authors-header h4 {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .authors-toggle {
            font-size: 0.7rem;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .authors-panel.collapsed .authors-toggle {
            transform: rotate(180deg);
        }

        .authors-items {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .author-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .author-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .author-name {
            color: var(--text-secondary);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .author-commits {
            color: var(--text-muted);
            font-size: 0.65rem;
            flex-shrink: 0;
        }

        /* About section */
        .about-banner {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.1) 0%, rgba(88, 166, 255, 0.1) 100%);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .about-banner h4 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .about-banner p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .about-links {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }

        /* Loading overlay with skeleton */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        #loading.hidden {
            display: none;
        }

        .loading-skeleton {
            flex: 1;
            display: flex;
            flex-direction: column;
            opacity: 0.4;
        }

        .skeleton-header {
            height: 60px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            gap: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .skeleton-bar {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--border) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .skeleton-title {
            width: 80px;
            height: 20px;
        }

        .skeleton-buttons {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .skeleton-btn {
            width: 60px;
            height: 28px;
        }

        .skeleton-body {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1rem;
            padding: 1rem;
        }

        .skeleton-canvas {
            background: var(--bg-canvas);
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .skeleton-viz {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .skeleton-node {
            position: absolute;
            border-radius: 50%;
            background: var(--accent);
            opacity: 0.3;
            animation: pulse 2s ease-in-out infinite;
        }

        .skeleton-node-1 { width: 16px; height: 16px; top: 20%; left: 50%; transform: translate(-50%, -50%); animation-delay: 0s; }
        .skeleton-node-2 { width: 12px; height: 12px; top: 60%; left: 25%; transform: translate(-50%, -50%); animation-delay: 0.3s; }
        .skeleton-node-3 { width: 12px; height: 12px; top: 55%; left: 75%; transform: translate(-50%, -50%); animation-delay: 0.6s; }
        .skeleton-node-4 { width: 10px; height: 10px; top: 85%; left: 50%; transform: translate(-50%, -50%); animation-delay: 0.9s; }

        .skeleton-beam {
            position: absolute;
            height: 2px;
            background: var(--accent-blue);
            opacity: 0.2;
            transform-origin: left center;
        }

        .skeleton-beam-1 {
            width: 60px;
            top: 40%;
            left: 50%;
            transform: rotate(45deg);
            animation: beam-pulse 2s ease-in-out infinite 0.2s;
        }

        .skeleton-beam-2 {
            width: 50px;
            top: 40%;
            left: 50%;
            transform: rotate(135deg);
            animation: beam-pulse 2s ease-in-out infinite 0.5s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.2; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.5; transform: translate(-50%, -50%) scale(1.1); }
        }

        @keyframes beam-pulse {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.4; }
        }

        .skeleton-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .skeleton-panel {
            height: 200px;
        }

        .skeleton-panel-sm {
            height: 120px;
        }

        .loading-content {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(13, 17, 23, 0.9);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .loading-subtext {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            .skeleton-body {
                grid-template-columns: 1fr;
            }
            .skeleton-sidebar {
                display: none;
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 20px var(--shadow);
            z-index: 1000;
            transition: transform 0.3s ease;
            max-width: 90%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: 1px solid var(--border);
        }

        .toast.visible {
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            border-left: 3px solid var(--error);
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast-message {
            flex: 1;
            font-size: 0.875rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
            line-height: 1;
        }

        /* Footer - Compact, hidden on mobile */
        footer {
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            text-align: center;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        footer a {
            color: var(--accent);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            footer {
                display: none; /* Hide footer on mobile to maximize canvas space */
            }
        }

        /* Mobile Responsive Overrides */
        @media (max-width: 768px) {
            .timeline-container {
                flex-wrap: wrap;
                padding: 0.5rem;
            }

            .speed-control {
                width: 100%;
                border-left: none;
                padding-left: 0;
                padding-top: 0.5rem;
                border-top: 1px solid var(--border);
                margin-top: 0.5rem;
            }

            .stats-overlay {
                font-size: 0.65rem;
                gap: 0.75rem;
            }

            .shortcut-grid {
                grid-template-columns: 1fr;
            }

            /* Hide header links on mobile */
            .header-links {
                display: none;
            }

            /* Compact header on mobile */
            header {
                padding: 0.5rem 0.75rem;
            }

            /* Make timeline more compact */
            .timeline-info {
                min-width: 60px;
                font-size: 0.7rem;
            }
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ========================================
           LIGHT THEME SUPPORT
           ======================================== */
        :root.light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #eaeef2;
            --bg-canvas: #f0f3f6;
            --text-primary: #1f2328;
            --text-secondary: #656d76;
            --text-muted: #8b949e;
            --border: #d0d7de;
            --border-light: #afb8c1;
            --shadow: rgba(31, 35, 40, 0.12);
        }

        .light-theme .legend-panel,
        .light-theme .authors-panel,
        .light-theme .perf-overlay,
        .light-theme .stats-overlay {
            background: rgba(246, 248, 250, 0.95);
        }

        .light-theme #canvas-container {
            background: #e8ecf0;
        }

        /* Theme toggle button */
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .theme-toggle .sun-icon { display: none; }
        .theme-toggle .moon-icon { display: block; }

        .light-theme .theme-toggle .sun-icon { display: block; }
        .light-theme .theme-toggle .moon-icon { display: none; }

        /* ========================================
           MOBILE SIDEBAR TOGGLE
           ======================================== */
        .sidebar-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 200;
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.4);
            transition: all 0.3s;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
            background: var(--accent-hover);
        }

        .sidebar-toggle svg {
            width: 24px;
            height: 24px;
        }

        @media (max-width: 1200px) {
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar-panel {
                position: fixed;
                top: 0;
                right: 0;
                width: 100%;
                max-width: 400px;
                height: 100%;
                max-height: 100%;
                background: var(--bg-primary);
                z-index: 150;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                padding: 1rem;
                padding-top: 60px;
                box-shadow: -4px 0 20px var(--shadow);
            }

            .sidebar-panel.open {
                transform: translateX(0);
            }

            .sidebar-close {
                position: absolute;
                top: 10px;
                right: 10px;
                background: var(--bg-tertiary);
                border: 1px solid var(--border);
                color: var(--text-secondary);
                width: 36px;
                height: 36px;
                border-radius: 6px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 140;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s;
            }

            .sidebar-overlay.visible {
                opacity: 1;
                visibility: visible;
            }

            /* Main content should take full width when sidebar is closed */
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr;
            }
        }

        /* ========================================
           HELP OVERLAY
           ======================================== */
        .help-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
        }

        .help-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .help-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            position: relative;
        }

        .help-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-right: 2rem;
        }

        .help-section {
            margin-bottom: 1.5rem;
        }

        .help-section h3 {
            font-size: 1rem;
            color: var(--accent);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-visual {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .help-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            flex: 1;
            min-width: 150px;
        }

        .help-item-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .help-item-text {
            font-size: 0.85rem;
        }

        .help-item-text strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        .help-item-text span {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .help-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .help-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* ========================================
           COMMIT TOOLTIP
           ======================================== */
        .commit-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            max-width: 320px;
            z-index: 300;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .commit-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        .commit-tooltip-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .commit-tooltip-author-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .commit-tooltip-author {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .commit-tooltip-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .commit-tooltip-file {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.8rem;
            color: var(--accent-blue);
            word-break: break-all;
            margin-bottom: 0.5rem;
        }

        .commit-tooltip-action {
            display: inline-block;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .commit-tooltip-action.add {
            background: rgba(63, 185, 80, 0.2);
            color: var(--success);
        }

        .commit-tooltip-action.modify {
            background: rgba(210, 153, 34, 0.2);
            color: var(--warning);
        }

        .commit-tooltip-action.delete {
            background: rgba(248, 81, 73, 0.2);
            color: var(--error);
        }

        /* ========================================
           TIMELINE MARKERS
           ======================================== */
        .timeline-markers {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .timeline-marker {
            position: absolute;
            width: 2px;
            height: 100%;
            background: var(--accent);
            opacity: 0.6;
            transform: translateX(-50%);
        }

        .timeline-marker.merge {
            background: var(--accent-blue);
        }

        .timeline-marker.large {
            background: var(--warning);
        }

        /* Slider container for markers */
        .timeline-slider-container {
            position: relative;
            flex: 1;
            height: 20px;
            display: flex;
            align-items: center;
        }

        .timeline-slider-container .timeline-slider {
            position: relative;
            z-index: 2;
            width: 100%;
        }

        .timeline-markers {
            position: absolute;
            top: 50%;
            left: 8px;  /* Account for slider thumb radius */
            right: 8px;
            height: 16px;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 1;
        }

        .timeline-marker {
            position: absolute;
            width: 3px;
            height: 12px;
            border-radius: 1px;
            transform: translateX(-50%);
            opacity: 0.7;
        }

        .timeline-marker.large-commit {
            background: var(--warning);
            height: 16px;
        }

        .timeline-marker.first-commit {
            background: var(--success);
            height: 14px;
        }

        .timeline-marker.recent-commit {
            background: var(--accent-blue);
            height: 14px;
        }

        /* ========================================
           AUTHOR FILTER
           ======================================== */
        .author-item {
            cursor: pointer;
            padding: 0.25rem;
            margin: -0.25rem;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .author-item:hover {
            background: var(--bg-tertiary);
        }

        .author-item.filtered {
            opacity: 0.4;
        }

        .author-item.active {
            background: rgba(233, 69, 96, 0.15);
            border: 1px solid var(--accent);
            margin: calc(-0.25rem - 1px);
            padding: calc(0.25rem - 1px);
        }

        .author-filter-clear {
            font-size: 0.65rem;
            color: var(--accent);
            cursor: pointer;
            margin-left: auto;
            padding: 0.2rem 0.4rem;
            background: rgba(233, 69, 96, 0.1);
            border-radius: 4px;
            display: none;
        }

        .author-filter-clear.visible {
            display: block;
        }

        /* ========================================
           DEBUG/PERFORMANCE PANEL - COLLAPSIBLE
           ======================================== */
        .debug-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 60;
        }

        .debug-toggle {
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid var(--border);
            color: var(--text-muted);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .debug-toggle:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .debug-toggle.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div id="loading" role="status" aria-live="polite">
        <div class="loading-skeleton" aria-hidden="true">
            <div class="skeleton-header">
                <div class="skeleton-bar skeleton-logo"></div>
                <div class="skeleton-bar skeleton-title"></div>
                <div class="skeleton-buttons">
                    <div class="skeleton-bar skeleton-btn"></div>
                    <div class="skeleton-bar skeleton-btn"></div>
                    <div class="skeleton-bar skeleton-btn"></div>
                </div>
            </div>
            <div class="skeleton-body">
                <div class="skeleton-canvas">
                    <div class="skeleton-viz">
                        <div class="skeleton-node skeleton-node-1"></div>
                        <div class="skeleton-node skeleton-node-2"></div>
                        <div class="skeleton-node skeleton-node-3"></div>
                        <div class="skeleton-node skeleton-node-4"></div>
                        <div class="skeleton-beam skeleton-beam-1"></div>
                        <div class="skeleton-beam skeleton-beam-2"></div>
                    </div>
                </div>
                <div class="skeleton-sidebar">
                    <div class="skeleton-bar skeleton-panel"></div>
                    <div class="skeleton-bar skeleton-panel-sm"></div>
                    <div class="skeleton-bar skeleton-panel-sm"></div>
                </div>
            </div>
        </div>
        <div class="loading-content">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div class="loading-text">Loading Rource...</div>
            <div class="loading-subtext">Initializing WebAssembly module</div>
        </div>
    </div>

    <header>
        <div class="header-brand">
            <a href="https://github.com/tomtom215/rource" target="_blank" rel="noopener noreferrer" title="View Rource on GitHub">
                <svg class="logo-icon" viewBox="0 0 100 100" aria-hidden="true">
                    <circle cx="50" cy="50" r="45" fill="#e94560"/>
                    <circle cx="50" cy="30" r="8" fill="white"/>
                    <circle cx="30" cy="60" r="6" fill="white"/>
                    <circle cx="70" cy="55" r="6" fill="white"/>
                    <circle cx="50" cy="75" r="5" fill="white"/>
                    <line x1="50" y1="38" x2="50" y2="70" stroke="white" stroke-width="2"/>
                    <line x1="50" y1="50" x2="32" y2="58" stroke="white" stroke-width="2"/>
                    <line x1="50" y1="50" x2="68" y2="53" stroke="white" stroke-width="2"/>
                </svg>
                <h1>Rource</h1>
            </a>
            <span id="renderer-badge" class="renderer-badge" title="Rendering backend"></span>
        </div>
        <div class="controls">
            <button id="btn-play" class="btn btn-sm" disabled aria-label="Play visualization">
                <svg id="play-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <span id="play-text">Play</span>
            </button>
            <button id="btn-reset" class="btn btn-sm btn-secondary" disabled aria-label="Reset camera">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
                </svg>
                Reset
            </button>
            <button id="btn-labels" class="btn btn-sm btn-secondary" disabled aria-label="Toggle labels" title="Toggle labels (L)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M3 18h12v-2H3v2zM3 6v2h18V6H3zm0 7h18v-2H3v2z"/>
                </svg>
                <span id="labels-text">Labels</span>
            </button>
            <button id="btn-screenshot" class="btn btn-sm btn-secondary" disabled aria-label="Download screenshot" title="Save screenshot (S)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M19 12h-2v3h-3v2h5v-5zM7 9h3V7H5v5h2V9zm14-6H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16.01H3V4.99h18v14.02z"/>
                </svg>
                Screenshot
            </button>
            <button id="btn-theme" class="theme-toggle" aria-label="Toggle light/dark theme" title="Toggle theme (T)">
                <svg class="sun-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                </svg>
                <svg class="moon-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/>
                </svg>
            </button>
            <button id="btn-help" class="help-btn" aria-label="Show help" title="Help (?)">?</button>
        </div>
        <div class="header-links">
            <a href="https://github.com/tomtom215/rource" target="_blank" rel="noopener noreferrer" class="github-link">
                <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                Star on GitHub
            </a>
        </div>
    </header>

    <main id="main-content" class="app-container">
        <!-- Visualization Panel -->
        <div class="viz-panel">
            <div id="canvas-container">
                <canvas id="canvas" width="1280" height="720" aria-label="Rource visualization canvas"></canvas>
                <!-- WebGL context loss recovery overlay -->
                <div id="context-lost-overlay" class="context-lost-overlay hidden" role="alert">
                    <div class="context-lost-content">
                        <svg class="context-lost-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <h3>Graphics Context Lost</h3>
                        <p>The WebGL rendering context was lost. This can happen on mobile devices or when switching tabs.</p>
                        <button id="btn-restore-context" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                            Restore Visualization
                        </button>
                    </div>
                </div>
                <div id="empty-state" class="empty-state">
                    <svg class="empty-state-icon" viewBox="0 0 100 100" aria-hidden="true">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="2" opacity="0.3"/>
                        <circle cx="50" cy="30" r="6" fill="currentColor" opacity="0.5"/>
                        <circle cx="30" cy="60" r="5" fill="currentColor" opacity="0.5"/>
                        <circle cx="70" cy="55" r="5" fill="currentColor" opacity="0.5"/>
                        <line x1="50" y1="36" x2="50" y2="50" stroke="currentColor" stroke-width="1.5" opacity="0.3"/>
                        <line x1="50" y1="50" x2="34" y2="58" stroke="currentColor" stroke-width="1.5" opacity="0.3"/>
                        <line x1="50" y1="50" x2="66" y2="53" stroke="currentColor" stroke-width="1.5" opacity="0.3"/>
                    </svg>
                    <h3>Ready to Visualize</h3>
                    <p>Enter a GitHub repository URL or load your own git log data to watch your codebase come to life.</p>
                </div>
                <div id="legend-panel" class="legend-panel collapsed" role="complementary" aria-label="File type legend">
                    <div class="legend-header" id="legend-toggle" role="button" tabindex="0" aria-expanded="false">
                        <h4>File Types</h4>
                        <span class="legend-toggle" aria-hidden="true">&#9660;</span>
                    </div>
                    <div class="legend-items" id="legend-items" role="list"></div>
                </div>
                <div id="stats-overlay" class="stats-overlay hidden">
                    <div class="stat-item">
                        <span class="stat-value" id="stat-commits">0</span>
                        <span class="stat-label">Commits</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="stat-files">0</span>
                        <span class="stat-label">Files</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="stat-authors">0</span>
                        <span class="stat-label">Authors</span>
                    </div>
                </div>
                <!-- Authors legend panel -->
                <div id="authors-panel" class="authors-panel hidden collapsed" role="complementary" aria-label="Authors legend">
                    <div class="authors-header" id="authors-toggle" role="button" tabindex="0" aria-expanded="false">
                        <h4>Authors</h4>
                        <span class="authors-toggle" aria-hidden="true">&#9660;</span>
                    </div>
                    <div class="authors-items" id="authors-items" role="list"></div>
                </div>
                <!-- Performance metrics overlay -->
                <div id="perf-overlay" class="perf-overlay hidden" role="complementary" aria-label="Performance metrics">
                    <div class="perf-header" id="perf-toggle" role="button" tabindex="0" aria-expanded="true">
                        <span class="perf-fps good" id="perf-fps">-- FPS</span>
                        <span class="perf-toggle" aria-hidden="true">&#9650;</span>
                    </div>
                    <div class="perf-details">
                        <div class="perf-row">
                            <span class="perf-label">Frame</span>
                            <span class="perf-value" id="perf-frame-time">--ms</span>
                        </div>
                        <div class="perf-row">
                            <span class="perf-label">Entities</span>
                            <span class="perf-value" id="perf-entities">--</span>
                        </div>
                        <div class="perf-row">
                            <span class="perf-label">Visible</span>
                            <span class="perf-value" id="perf-visible">--</span>
                        </div>
                        <div class="perf-row">
                            <span class="perf-label">Draw Calls</span>
                            <span class="perf-value" id="perf-draws">--</span>
                        </div>
                        <div class="perf-row">
                            <span class="perf-label">Resolution</span>
                            <span class="perf-value" id="perf-resolution">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="timeline-container" role="group" aria-label="Timeline controls">
                <div class="timeline-controls">
                    <button id="btn-prev" class="timeline-btn" disabled title="Previous commit (< or ,)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                    </button>
                    <button id="btn-play-small" class="timeline-btn" disabled title="Play/Pause (Space)">
                        <svg id="play-icon-small" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <button id="btn-next" class="timeline-btn" disabled title="Next commit (> or .)">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
                    </button>
                </div>
                <div class="timeline-slider-container" id="timeline-slider-container">
                    <input type="range" id="timeline-slider" class="timeline-slider" min="0" max="0" value="0" disabled>
                    <div class="timeline-markers" id="timeline-markers"></div>
                </div>
                <span class="timeline-info" id="timeline-info">0 / 0</span>
                <div class="speed-control">
                    <label for="speed-select">Speed:</label>
                    <select id="speed-select" disabled>
                        <option value="100">0.1x (Slow)</option>
                        <option value="20">0.5x</option>
                        <option value="10" selected>1x (Normal)</option>
                        <option value="5">2x</option>
                        <option value="2">5x (Fast)</option>
                        <option value="1">10x (Very Fast)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Sidebar Panel -->
        <div class="sidebar-panel" id="sidebar-panel">
            <!-- Close button (visible on mobile) -->
            <button id="sidebar-close" class="sidebar-close hidden" aria-label="Close sidebar">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <!-- Showcase Panel: Visualize This Project -->
            <div class="showcase-panel" id="showcase-panel">
                <span class="showcase-badge">Featured</span>
                <svg class="showcase-icon" viewBox="0 0 100 100" aria-hidden="true">
                    <circle cx="50" cy="50" r="45" fill="#e94560"/>
                    <circle cx="50" cy="30" r="8" fill="white"/>
                    <circle cx="30" cy="60" r="6" fill="white"/>
                    <circle cx="70" cy="55" r="6" fill="white"/>
                    <circle cx="50" cy="75" r="5" fill="white"/>
                    <line x1="50" y1="38" x2="50" y2="70" stroke="white" stroke-width="2"/>
                    <line x1="50" y1="50" x2="32" y2="58" stroke="white" stroke-width="2"/>
                    <line x1="50" y1="50" x2="68" y2="53" stroke="white" stroke-width="2"/>
                </svg>
                <h3>Visualize This Project</h3>
                <p>Watch the complete development history of Rource itself. Cached locally - no API limits.</p>
                <div class="showcase-buttons">
                    <button id="btn-visualize-rource" class="showcase-btn" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        Visualize Rource
                    </button>
                    <button id="btn-refresh-rource" class="showcase-btn-secondary" title="Fetch latest commits from GitHub">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Fetch Latest
                    </button>
                </div>
                <div id="refresh-status" class="refresh-status hidden"></div>
                <div class="showcase-stats">
                    <div class="showcase-stat">
                        <div class="showcase-stat-value" id="showcase-commits">--</div>
                        <div class="showcase-stat-label">Commits</div>
                    </div>
                    <div class="showcase-stat">
                        <div class="showcase-stat-value" id="showcase-files">--</div>
                        <div class="showcase-stat-label">Files</div>
                    </div>
                    <div class="showcase-stat">
                        <div class="showcase-stat-value" id="showcase-authors">--</div>
                        <div class="showcase-stat-label">Authors</div>
                    </div>
                </div>
            </div>

            <!-- GitHub URL Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        Other Repositories
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="github-input-group">
                        <input type="text" id="github-url" placeholder="https://github.com/owner/repo" aria-label="GitHub repository URL">
                        <button id="btn-fetch-github" class="btn btn-success btn-sm" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Fetch
                        </button>
                    </div>
                    <div class="popular-repos">
                        <span class="popular-repos-label">Try a popular repository:</span>
                        <div class="repo-chips">
                            <button class="repo-chip" data-repo="facebook/react">
                                <svg viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="3"/></svg>
                                react
                            </button>
                            <button class="repo-chip" data-repo="microsoft/vscode">
                                <svg viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="3"/></svg>
                                vscode
                            </button>
                            <button class="repo-chip" data-repo="rust-lang/rust">
                                <svg viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="3"/></svg>
                                rust
                            </button>
                            <button class="repo-chip" data-repo="torvalds/linux">
                                <svg viewBox="0 0 16 16" fill="currentColor"><circle cx="8" cy="8" r="3"/></svg>
                                linux
                            </button>
                        </div>
                    </div>
                    <div id="fetch-status" class="fetch-status">
                        <span id="fetch-status-text"></span>
                        <div class="fetch-progress">
                            <div id="fetch-progress-bar" class="fetch-progress-bar"></div>
                        </div>
                    </div>
                    <p class="help-text" style="margin-top: 0.75rem;">
                        Fetches up to 100 recent commits from any public GitHub repository using the GitHub API.
                    </p>
                </div>
            </div>

            <!-- Manual Load Panel -->
            <div class="panel">
                <div class="tab-nav" role="tablist">
                    <button class="tab-btn active" data-tab="command" role="tab" aria-selected="true">Git Command</button>
                    <button class="tab-btn" data-tab="upload" role="tab" aria-selected="false">Upload File</button>
                    <button class="tab-btn" data-tab="paste" role="tab" aria-selected="false">Paste Log</button>
                </div>

                <div id="tab-command" class="tab-content active" role="tabpanel">
                    <p class="help-text" style="margin-bottom: 0.75rem;">Generate a log file from your local repository:</p>
                    <div class="command-box">
                        <code id="git-command">git log --reverse --format="%at|%an" --name-status | awk '/^[0-9]+\|/{info=$0;next}/^[AMD]\t/{print info"|"substr($0,1,1)"|"substr($0,3)}' > rource.log</code>
                    </div>
                    <button id="btn-copy-command" class="btn btn-sm btn-secondary">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        Copy Command
                    </button>
                    <div class="help-text" style="margin-top: 0.75rem;">
                        <strong>How to use:</strong>
                        <ol style="margin: 0.5rem 0 0 1.2rem; padding: 0;">
                            <li>Open a terminal in your Git repository</li>
                            <li>Run the command above (creates <code>rource.log</code>)</li>
                            <li>Upload the generated file using the "Upload File" tab</li>
                        </ol>
                        <p style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85em;">
                            <strong>Note:</strong> Works on Linux/macOS. For Windows, use Git Bash or WSL.
                        </p>
                    </div>
                </div>

                <div id="tab-upload" class="tab-content" role="tabpanel" hidden>
                    <div class="file-upload-area" id="file-drop-zone">
                        <input type="file" id="file-input" accept=".txt,.log,.csv">
                        <div class="file-upload-icon">&#128194;</div>
                        <div class="file-upload-text">
                            <strong>Click to upload</strong> or drag and drop
                        </div>
                    </div>
                    <div id="file-name" class="file-name hidden"></div>
                    <button id="btn-load-file" class="btn btn-sm" disabled>Load Uploaded File</button>
                    <div class="help-text" style="margin-top: 0.75rem;">
                        <strong>Accepted formats:</strong><br>
                        <code>.txt</code>, <code>.log</code>, or <code>.csv</code> files containing log data in the format:<br>
                        <code>timestamp|author|action|path</code><br>
                        <em>Example:</em> <code>1609459200|John Doe|A|src/main.rs</code><br>
                        <span style="color: var(--text-muted); font-size: 0.85em;">Use the "Git Command" tab to generate this file from your local repository.</span>
                    </div>
                </div>

                <div id="tab-paste" class="tab-content" role="tabpanel" hidden>
                    <textarea id="log-input" placeholder="Paste your log data here...&#10;Format: timestamp|author|action|path"></textarea>
                    <button id="btn-load" class="btn btn-sm" disabled>Load Log Data</button>
                    <p class="help-text">
                        Format: <code>timestamp|author|action|path</code><br>
                        Actions: <code>A</code>=Add, <code>M</code>=Modify, <code>D</code>=Delete
                    </p>
                </div>
            </div>

            <!-- Controls Panel - Keyboard and Mouse -->
            <div class="panel">
                <div class="panel-header">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/>
                        </svg>
                        Keyboard Shortcuts
                    </h3>
                </div>
                <div class="panel-body">
                    <div class="shortcut-grid">
                        <div class="shortcut-item"><span>Play/Pause</span><kbd>Space</kbd></div>
                        <div class="shortcut-item"><span>Zoom In</span><kbd>+</kbd></div>
                        <div class="shortcut-item"><span>Zoom Out</span><kbd>-</kbd></div>
                        <div class="shortcut-item"><span>Reset View</span><kbd>R</kbd></div>
                        <div class="shortcut-item"><span>Pan</span><kbd>Arrows</kbd></div>
                        <div class="shortcut-item"><span>Labels</span><kbd>L</kbd></div>
                        <div class="shortcut-item"><span>Step Fwd</span><kbd>&gt;</kbd></div>
                        <div class="shortcut-item"><span>Step Back</span><kbd>&lt;</kbd></div>
                        <div class="shortcut-item"><span>Speed Down</span><kbd>[</kbd></div>
                        <div class="shortcut-item"><span>Speed Up</span><kbd>]</kbd></div>
                        <div class="shortcut-item"><span>Perf Stats</span><kbd>P</kbd></div>
                        <div class="shortcut-item"><span>Authors</span><kbd>A</kbd></div>
                    </div>
                    <p class="help-text" style="margin-top: 0.75rem;">
                        <strong>Mouse:</strong> Drag to pan, scroll to zoom
                    </p>
                </div>
            </div>

            <!-- Quick Guide Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-6h2v6zm0-8h-2V7h2v4z"/>
                        </svg>
                        Quick Guide
                    </h3>
                </div>
                <div class="panel-body docs-panel">
                    <div class="docs-section">
                        <h4>What is Rource?</h4>
                        <p><a href="https://github.com/tomtom215/rource" target="_blank" rel="noopener">Rource</a> visualizes software version control history as an animated tree. Each file is a colored node, each developer has a unique color, and commits create "beams" connecting developers to files they modify.</p>
                    </div>
                    <div class="docs-section">
                        <h4>Features</h4>
                        <ul class="feature-list">
                            <li>WebGL2 GPU-accelerated rendering</li>
                            <li>Force-directed graph layout</li>
                            <li>Color-coded file types</li>
                            <li>Runs entirely in browser (~76KB)</li>
                            <li>No server or installation needed</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Technical Showcase Panel -->
            <div class="tech-info-panel" id="tech-info-panel">
                <div class="tech-info-header">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                    Technical Specifications
                </div>
                <div class="tech-grid">
                    <div class="tech-item">
                        <div class="tech-item-value" id="tech-wasm-size">~76KB</div>
                        <div class="tech-item-label">WASM Gzipped</div>
                    </div>
                    <div class="tech-item">
                        <div class="tech-item-value" id="tech-renderer">WebGL2</div>
                        <div class="tech-item-label">Renderer</div>
                    </div>
                    <div class="tech-item">
                        <div class="tech-item-value" id="tech-tests">671</div>
                        <div class="tech-item-label">Unit Tests</div>
                    </div>
                    <div class="tech-item">
                        <div class="tech-item-value" id="tech-crates">4</div>
                        <div class="tech-item-label">Rust Crates</div>
                    </div>
                </div>
                <div class="tech-badges">
                    <span class="tech-badge highlight">Rust</span>
                    <span class="tech-badge highlight">WebAssembly</span>
                    <span class="tech-badge">Zero Dependencies</span>
                    <span class="tech-badge">GPU Accelerated</span>
                    <span class="tech-badge">Instanced Rendering</span>
                    <span class="tech-badge">60 FPS Target</span>
                </div>
            </div>

            <!-- About Panel -->
            <div class="about-banner">
                <h4>Built with Rust + WebAssembly</h4>
                <p><a href="https://github.com/tomtom215/rource" target="_blank" rel="noopener">Rource</a> is a modern rewrite of <a href="https://gource.io" target="_blank" rel="noopener">Gource</a>, the popular version control visualization tool.</p>
                <div class="about-links">
                    <a href="https://github.com/tomtom215/rource" target="_blank" rel="noopener" class="btn btn-sm btn-outline">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
                        View Source
                    </a>
                    <a href="https://github.com/tomtom215/rource/issues" target="_blank" rel="noopener" class="btn btn-sm btn-secondary">
                        Report Issue
                    </a>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-links">
            <span><strong><a href="https://github.com/tomtom215/rource">Rource</a></strong> - Software Version Control Visualization</span>
            <a href="https://github.com/tomtom215/rource" target="_blank" rel="noopener">GitHub</a>
            <a href="https://github.com/tomtom215/rource/issues" target="_blank" rel="noopener">Issues</a>
            <a href="https://gource.io" target="_blank" rel="noopener">Original Gource</a>
            <span>GPL-3.0 License</span>
        </div>
    </footer>

    <!-- Toast -->
    <div id="toast" class="toast" role="alert" aria-live="assertive">
        <span class="toast-message"></span>
        <button class="toast-close" aria-label="Close">&times;</button>
    </div>

    <!-- Sidebar Overlay (for mobile) -->
    <div id="sidebar-overlay" class="sidebar-overlay" aria-hidden="true"></div>

    <!-- Sidebar Toggle Button (for mobile) -->
    <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Open menu" title="Open settings panel">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
    </button>

    <!-- Commit Tooltip -->
    <div id="commit-tooltip" class="commit-tooltip" role="tooltip" aria-hidden="true">
        <div class="commit-tooltip-header">
            <div class="commit-tooltip-author-color" id="tooltip-author-color"></div>
            <span class="commit-tooltip-author" id="tooltip-author"></span>
            <span class="commit-tooltip-date" id="tooltip-date"></span>
        </div>
        <div class="commit-tooltip-file" id="tooltip-file"></div>
        <span class="commit-tooltip-action" id="tooltip-action"></span>
    </div>

    <!-- Help Overlay -->
    <div id="help-overlay" class="help-overlay" role="dialog" aria-modal="true" aria-labelledby="help-title">
        <div class="help-content">
            <button id="help-close" class="help-close" aria-label="Close help">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <h2 id="help-title">What am I looking at?</h2>

            <div class="help-section">
                <h3>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
                    Visual Elements
                </h3>
                <div class="help-visual">
                    <div class="help-item">
                        <svg class="help-item-icon" viewBox="0 0 32 32">
                            <circle cx="16" cy="16" r="8" fill="#58a6ff"/>
                        </svg>
                        <div class="help-item-text">
                            <strong>Files</strong>
                            <span>Colored dots represent files. Color = file type.</span>
                        </div>
                    </div>
                    <div class="help-item">
                        <svg class="help-item-icon" viewBox="0 0 32 32">
                            <circle cx="16" cy="16" r="10" fill="#e94560" stroke="white" stroke-width="2"/>
                        </svg>
                        <div class="help-item-text">
                            <strong>Users</strong>
                            <span>Larger circles = developers. Each has a unique color.</span>
                        </div>
                    </div>
                    <div class="help-item">
                        <svg class="help-item-icon" viewBox="0 0 32 32">
                            <line x1="8" y1="16" x2="24" y2="16" stroke="#3fb950" stroke-width="3"/>
                        </svg>
                        <div class="help-item-text">
                            <strong>Beams</strong>
                            <span>Lines connecting users to files they modify.</span>
                        </div>
                    </div>
                    <div class="help-item">
                        <svg class="help-item-icon" viewBox="0 0 32 32">
                            <line x1="16" y1="8" x2="16" y2="24" stroke="#8b949e" stroke-width="2"/>
                            <circle cx="16" cy="8" r="3" fill="#8b949e"/>
                        </svg>
                        <div class="help-item-text">
                            <strong>Directories</strong>
                            <span>Lines represent folder structure branching out.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="help-section">
                <h3>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    How It Works
                </h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                    Rource visualizes your Git history as an animated tree. Each commit creates "beams" connecting
                    developers to the files they modify. Files branch out from the root based on their directory
                    structure. The visualization uses a force-directed layout to naturally organize files and prevent overlap.
                </p>
            </div>

            <div class="help-section">
                <h3>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    Quick Tips
                </h3>
                <ul style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.8; padding-left: 1.25rem;">
                    <li><strong>Hover</strong> over files or users to see details</li>
                    <li><strong>Drag</strong> to pan around the visualization</li>
                    <li><strong>Scroll</strong> to zoom in/out</li>
                    <li>Press <kbd style="background: var(--bg-tertiary); padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.8rem;">Space</kbd> to play/pause</li>
                    <li>Press <kbd style="background: var(--bg-tertiary); padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.8rem;">?</kbd> to show this help anytime</li>
                </ul>
            </div>

            <button id="help-got-it" class="btn" style="width: 100%; margin-top: 1rem;">Got it!</button>
        </div>
    </div>

    <script type="module">
        import init, { Rource } from './pkg/rource_wasm.js';

        // State
        let rource = null;
        let animationId = null;
        let uploadedFileContent = null;
        let hasLoadedData = false;
        let commitStats = { commits: 0, files: 0, authors: new Set() };
        let isContextLost = false;
        let lastLoadedRepo = null;

        // =====================================================================
        // URL STATE MANAGEMENT
        // =====================================================================
        // Enables sharing visualization settings via URL parameters.
        // Supported params: repo, speed, autoplay
        // =====================================================================

        /**
         * Parses URL parameters and returns configuration object.
         * @returns {Object} Configuration from URL params
         */
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                repo: params.get('repo'),           // e.g., "owner/repo" or full URL
                speed: params.get('speed'),         // seconds per day
                autoplay: params.get('autoplay'),   // "true" to auto-play
            };
        }

        /**
         * Updates URL with current visualization state without page reload.
         * @param {Object} state - State to persist in URL
         */
        function updateUrlState(state) {
            const params = new URLSearchParams(window.location.search);

            if (state.repo !== undefined) {
                if (state.repo) params.set('repo', state.repo);
                else params.delete('repo');
            }
            if (state.speed !== undefined) {
                if (state.speed && state.speed !== '10') params.set('speed', state.speed);
                else params.delete('speed');
            }
            if (state.autoplay !== undefined) {
                if (state.autoplay) params.set('autoplay', 'true');
                else params.delete('autoplay');
            }

            const newUrl = params.toString()
                ? `${window.location.pathname}?${params.toString()}`
                : window.location.pathname;

            window.history.replaceState({}, '', newUrl);
        }

        /**
         * Generates a shareable URL for current state.
         * @returns {string} Full shareable URL
         */
        function getShareableUrl() {
            return window.location.href;
        }

        // =====================================================================
        // CACHED ROURCE REPOSITORY DATA
        // =====================================================================
        // This is the complete commit history of the Rource project itself.
        // Cached locally to ensure the demo always works without API rate limits.
        // Generated from: git log --reverse --format="%at|%an" --name-status
        // Last updated: 2026-01-11
        // =====================================================================
        const ROURCE_CACHED_DATA = `1768004902|Tom F|A|LICENSE
1768004902|Tom F|A|README.md
1768006231|Claude|A|GOURCE_RUST_REWRITE_PLAN.md
1768028263|Claude|A|CLAUDE.md
1768028263|Claude|A|scripts/session-setup.sh
1768029507|Claude|A|.gitignore
1768029507|Claude|A|Cargo.toml
1768029507|Claude|A|crates/rource-core/Cargo.toml
1768029507|Claude|A|crates/rource-core/src/entity.rs
1768029507|Claude|A|crates/rource-core/src/lib.rs
1768029507|Claude|A|crates/rource-math/Cargo.toml
1768029507|Claude|A|crates/rource-math/src/color.rs
1768029507|Claude|A|crates/rource-math/src/lib.rs
1768029507|Claude|A|crates/rource-math/src/mat3.rs
1768029507|Claude|A|crates/rource-math/src/mat4.rs
1768029507|Claude|A|crates/rource-math/src/rect.rs
1768029507|Claude|A|crates/rource-math/src/vec2.rs
1768029507|Claude|A|crates/rource-math/src/vec3.rs
1768029507|Claude|A|crates/rource-math/src/vec4.rs
1768029507|Claude|A|crates/rource-vcs/Cargo.toml
1768029507|Claude|A|crates/rource-vcs/src/commit.rs
1768029507|Claude|A|crates/rource-vcs/src/lib.rs
1768029545|Claude|M|CLAUDE.md
1768039323|Claude|A|crates/rource-vcs/src/detect.rs
1768039323|Claude|A|crates/rource-vcs/src/error.rs
1768039323|Claude|M|crates/rource-vcs/src/lib.rs
1768039323|Claude|A|crates/rource-vcs/src/parser/custom.rs
1768039323|Claude|A|crates/rource-vcs/src/parser/git.rs
1768039323|Claude|A|crates/rource-vcs/src/parser/mod.rs
1768039351|Claude|M|CLAUDE.md
1768041150|Claude|M|CLAUDE.md
1768041150|Claude|M|crates/rource-core/src/lib.rs
1768041150|Claude|A|crates/rource-core/src/physics/mod.rs
1768041150|Claude|A|crates/rource-core/src/physics/spatial.rs
1768041150|Claude|A|crates/rource-core/src/scene/action.rs
1768041150|Claude|A|crates/rource-core/src/scene/file.rs
1768041150|Claude|A|crates/rource-core/src/scene/mod.rs
1768041150|Claude|A|crates/rource-core/src/scene/tree.rs
1768041150|Claude|A|crates/rource-core/src/scene/user.rs
1768041150|Claude|M|crates/rource-math/src/color.rs
1768041150|Claude|M|crates/rource-math/src/mat4.rs
1768041150|Claude|M|crates/rource-vcs/src/commit.rs
1768041150|Claude|M|crates/rource-vcs/src/detect.rs
1768041150|Claude|M|crates/rource-vcs/src/parser/custom.rs
1768041150|Claude|M|crates/rource-vcs/src/parser/git.rs
1768041150|Claude|M|crates/rource-vcs/src/parser/mod.rs
1768042447|Claude|M|CLAUDE.md
1768042447|Claude|A|crates/rource-core/src/animation/mod.rs
1768042447|Claude|A|crates/rource-core/src/animation/spline.rs
1768042447|Claude|A|crates/rource-core/src/animation/tween.rs
1768042447|Claude|A|crates/rource-core/src/camera/mod.rs
1768042447|Claude|M|crates/rource-core/src/lib.rs
1768042447|Claude|A|crates/rource-core/src/physics/force.rs
1768042447|Claude|M|crates/rource-core/src/physics/mod.rs
1768042602|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768044097|Claude|M|CLAUDE.md
1768044097|Claude|M|Cargo.toml
1768044097|Claude|M|crates/rource-core/src/physics/force.rs
1768044097|Claude|A|crates/rource-render/Cargo.toml
1768044097|Claude|A|crates/rource-render/src/backend/mod.rs
1768044097|Claude|A|crates/rource-render/src/backend/software.rs
1768044097|Claude|A|crates/rource-render/src/command.rs
1768044097|Claude|A|crates/rource-render/src/effects/bloom.rs
1768044097|Claude|A|crates/rource-render/src/effects/mod.rs
1768044097|Claude|A|crates/rource-render/src/font.rs
1768044097|Claude|A|crates/rource-render/src/lib.rs
1768044097|Claude|A|crates/rource-render/src/texture.rs
1768045302|Claude|M|CLAUDE.md
1768045302|Claude|M|Cargo.toml
1768045302|Claude|M|crates/rource-render/src/backend/software.rs
1768045302|Claude|M|crates/rource-render/src/command.rs
1768045302|Claude|M|crates/rource-render/src/effects/bloom.rs
1768045302|Claude|M|crates/rource-render/src/font.rs
1768045302|Claude|M|crates/rource-render/src/texture.rs
1768045302|Claude|A|rource-cli/Cargo.toml
1768045302|Claude|A|rource-cli/src/args.rs
1768045302|Claude|A|rource-cli/src/main.rs
1768046181|Claude|M|rource-cli/src/main.rs
1768046358|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768047064|Claude|A|crates/rource-core/src/config/mod.rs
1768047064|Claude|A|crates/rource-core/src/config/settings.rs
1768047064|Claude|M|crates/rource-core/src/lib.rs
1768047064|Claude|M|crates/rource-core/src/scene/mod.rs
1768047064|Claude|M|rource-cli/src/main.rs
1768047369|Claude|M|crates/rource-render/src/effects/mod.rs
1768047369|Claude|A|crates/rource-render/src/effects/shadow.rs
1768047369|Claude|M|rource-cli/src/args.rs
1768047369|Claude|M|rource-cli/src/main.rs
1768047841|Claude|M|crates/rource-vcs/src/detect.rs
1768047841|Claude|M|crates/rource-vcs/src/parser/mod.rs
1768047841|Claude|A|crates/rource-vcs/src/parser/svn.rs
1768047991|Claude|M|CLAUDE.md
1768047991|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768049940|Claude|M|CLAUDE.md
1768049940|Claude|M|crates/rource-core/src/config/settings.rs
1768049940|Claude|M|crates/rource-core/src/scene/mod.rs
1768049940|Claude|A|crates/rource-render/assets/RobotoMono-Regular.ttf
1768049940|Claude|M|crates/rource-render/src/backend/software.rs
1768049940|Claude|A|crates/rource-render/src/default_font.rs
1768049940|Claude|M|crates/rource-render/src/effects/shadow.rs
1768049940|Claude|M|crates/rource-render/src/lib.rs
1768049940|Claude|M|crates/rource-vcs/src/parser/svn.rs
1768049940|Claude|M|rource-cli/src/main.rs
1768061605|Claude|M|CLAUDE.md
1768061605|Claude|M|rource-cli/src/args.rs
1768061605|Claude|M|rource-cli/src/main.rs
1768062405|Claude|M|CLAUDE.md
1768062405|Claude|M|rource-cli/src/args.rs
1768062405|Claude|A|rource-cli/src/export.rs
1768062405|Claude|M|rource-cli/src/main.rs
1768064101|Claude|M|crates/rource-core/src/scene/mod.rs
1768064101|Claude|M|rource-cli/src/main.rs
1768064892|Claude|M|CLAUDE.md
1768064892|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768066271|Claude|M|Cargo.toml
1768066271|Claude|M|rource-cli/src/main.rs
1768066271|Claude|A|rource-wasm/Cargo.toml
1768066271|Claude|A|rource-wasm/src/lib.rs
1768066271|Claude|A|rource-wasm/www/index.html
1768066271|Claude|A|scripts/build-wasm.sh
1768066342|Claude|M|CLAUDE.md
1768068930|Claude|M|crates/rource-vcs/src/detect.rs
1768068930|Claude|A|crates/rource-vcs/src/parser/mercurial.rs
1768068930|Claude|M|crates/rource-vcs/src/parser/mod.rs
1768068930|Claude|M|rource-cli/Cargo.toml
1768068930|Claude|M|rource-cli/src/args.rs
1768068930|Claude|M|rource-cli/src/export.rs
1768068930|Claude|M|rource-cli/src/main.rs
1768068930|Claude|M|rource-wasm/src/lib.rs
1768068930|Claude|M|rource-wasm/www/index.html
1768070585|Claude|M|crates/rource-vcs/src/detect.rs
1768070585|Claude|A|crates/rource-vcs/src/parser/bazaar.rs
1768070585|Claude|M|crates/rource-vcs/src/parser/mercurial.rs
1768070585|Claude|M|crates/rource-vcs/src/parser/mod.rs
1768070585|Claude|M|rource-cli/src/export.rs
1768070585|Claude|M|rource-cli/src/main.rs
1768070585|Claude|M|rource-wasm/src/lib.rs
1768070585|Claude|M|rource-wasm/www/index.html
1768079256|Claude|M|crates/rource-core/src/scene/mod.rs
1768079256|Claude|M|rource-cli/src/main.rs
1768082290|Claude|M|Cargo.toml
1768082290|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768082290|Claude|M|crates/rource-core/Cargo.toml
1768082290|Claude|A|crates/rource-core/src/config/config_file.rs
1768082290|Claude|M|crates/rource-core/src/config/mod.rs
1768082290|Claude|M|crates/rource-core/src/scene/mod.rs
1768082290|Claude|M|crates/rource-render/src/backend/software.rs
1768082290|Claude|M|rource-cli/Cargo.toml
1768082290|Claude|M|rource-cli/src/args.rs
1768082290|Claude|A|rource-cli/src/avatar.rs
1768082290|Claude|M|rource-cli/src/main.rs
1768082688|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768084344|Claude|M|crates/rource-core/Cargo.toml
1768084344|Claude|M|crates/rource-core/src/config/config_file.rs
1768084344|Claude|M|crates/rource-core/src/config/mod.rs
1768084344|Claude|M|crates/rource-core/src/config/settings.rs
1768084344|Claude|M|rource-cli/src/args.rs
1768084344|Claude|M|rource-cli/src/main.rs
1768087702|Claude|M|crates/rource-core/src/scene/mod.rs
1768087702|Claude|M|rource-cli/src/main.rs
1768088628|Claude|M|CLAUDE.md
1768088628|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768088628|Claude|A|crates/rource-core/src/config/config_env.rs
1768088628|Claude|M|crates/rource-core/src/config/mod.rs
1768088628|Claude|M|rource-cli/src/args.rs
1768088628|Claude|M|rource-cli/src/main.rs
1768088835|Claude|M|rource-cli/src/args.rs
1768088835|Claude|M|rource-cli/src/main.rs
1768088917|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768091184|Claude|A|MIGRATING.md
1768091184|Claude|M|README.md
1768091184|Claude|A|examples/README.md
1768091184|Claude|A|examples/basic.toml
1768091184|Claude|A|examples/export-video.sh
1768091184|Claude|A|examples/large-repo.toml
1768091184|Claude|A|examples/minimal.toml
1768091184|Claude|A|examples/presentation.toml
1768091184|Claude|A|examples/quick-preview.sh
1768091184|Claude|A|examples/rust-project.toml
1768091184|Claude|A|examples/sample-custom.log
1768091184|Claude|A|examples/video-export.toml
1768091184|Claude|A|examples/web-project.toml
1768091218|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768092822|Claude|M|CLAUDE.md
1768092822|Claude|M|README.md
1768092822|Claude|M|crates/rource-render/Cargo.toml
1768092822|Claude|M|crates/rource-render/src/backend/mod.rs
1768092822|Claude|A|crates/rource-render/src/backend/webgl2/buffers.rs
1768092822|Claude|A|crates/rource-render/src/backend/webgl2/mod.rs
1768092822|Claude|A|crates/rource-render/src/backend/webgl2/shaders.rs
1768092822|Claude|A|crates/rource-render/src/backend/webgl2/textures.rs
1768092822|Claude|M|crates/rource-render/src/lib.rs
1768092822|Claude|M|rource-wasm/Cargo.toml
1768092822|Claude|M|rource-wasm/src/lib.rs
1768093056|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768094482|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768094482|Claude|M|crates/rource-core/src/config/config_env.rs
1768094482|Claude|M|crates/rource-core/src/config/settings.rs
1768094482|Claude|M|crates/rource-core/src/scene/mod.rs
1768094482|Claude|M|crates/rource-render/src/backend/mod.rs
1768094482|Claude|M|crates/rource-render/src/backend/webgl2/textures.rs
1768094482|Claude|M|crates/rource-vcs/src/detect.rs
1768094482|Claude|M|crates/rource-vcs/src/lib.rs
1768094482|Claude|M|crates/rource-vcs/src/parser/bazaar.rs
1768094482|Claude|M|crates/rource-vcs/src/parser/mercurial.rs
1768094482|Claude|M|rource-cli/src/args.rs
1768094482|Claude|M|rource-cli/src/avatar.rs
1768094482|Claude|M|rource-cli/src/main.rs
1768094482|Claude|M|rource-wasm/src/lib.rs
1768129122|Claude|M|CLAUDE.md
1768129122|Claude|M|GOURCE_RUST_REWRITE_PLAN.md
1768129122|Claude|A|crates/rource-vcs/examples/memory_benchmark.rs
1768129122|Claude|A|crates/rource-vcs/src/compact.rs
1768129122|Claude|A|crates/rource-vcs/src/intern.rs
1768129122|Claude|M|crates/rource-vcs/src/lib.rs
1768129122|Claude|A|crates/rource-vcs/src/stream.rs
1768135084|Claude|M|crates/rource-core/src/config/config_env.rs
1768135084|Claude|M|crates/rource-core/src/config/config_file.rs
1768135084|Claude|M|crates/rource-core/src/config/mod.rs
1768135084|Claude|M|crates/rource-core/src/config/settings.rs
1768135084|Claude|M|rource-cli/src/args.rs
1768135084|Claude|M|rource-cli/src/main.rs
1768137496|Claude|A|crates/rource-core/src/camera/camera3d.rs
1768137496|Claude|M|crates/rource-core/src/camera/mod.rs
1768137496|Claude|M|crates/rource-core/src/config/config_env.rs
1768137496|Claude|M|crates/rource-core/src/config/config_file.rs
1768137496|Claude|M|crates/rource-core/src/config/settings.rs
1768137496|Claude|M|crates/rource-core/src/lib.rs
1768137496|Claude|M|crates/rource-render/Cargo.toml
1768137496|Claude|M|crates/rource-render/src/backend/software.rs
1768137496|Claude|M|crates/rource-render/src/backend/webgl2/shaders.rs
1768137496|Claude|A|crates/rource-render/src/image.rs
1768137496|Claude|M|crates/rource-render/src/lib.rs
1768137496|Claude|M|crates/rource-vcs/src/compact.rs
1768137496|Claude|M|crates/rource-vcs/src/intern.rs
1768137496|Claude|M|crates/rource-vcs/src/stream.rs
1768137496|Claude|M|rource-cli/src/args.rs
1768137496|Claude|M|rource-cli/src/main.rs
1768137496|Claude|M|rource-wasm/src/lib.rs
1768145880|Claude|A|benchmarks/.gitignore
1768145880|Claude|A|benchmarks/BENCHMARK_REPORT.md
1768145880|Claude|A|benchmarks/docs/BENCHMARK_METHODOLOGY.md
1768145880|Claude|A|benchmarks/scripts/benchmark_binary.sh
1768145880|Claude|A|benchmarks/scripts/benchmark_features.sh
1768145880|Claude|A|benchmarks/scripts/benchmark_log_parsing.sh
1768145880|Claude|A|benchmarks/scripts/benchmark_memory.sh
1768145880|Claude|A|benchmarks/scripts/benchmark_rendering.sh
1768145880|Claude|A|benchmarks/scripts/common.sh
1768145880|Claude|A|benchmarks/scripts/run_benchmarks.sh
1768145880|Claude|A|benchmarks/scripts/test_benchmarks.sh
1768146249|Claude|A|.github/workflows/deploy-pages.yml
1768146249|Claude|A|rource-wasm/www/.nojekyll
1768147375|Claude|M|.github/workflows/deploy-pages.yml
1768147375|Claude|M|rource-wasm/www/index.html
1768147471|Claude|M|README.md
1768147773|Claude|M|.github/workflows/deploy-pages.yml
1768150459|Claude|M|rource-wasm/www/index.html
1768151357|Claude|M|crates/rource-core/src/scene/mod.rs
1768151357|Claude|M|crates/rource-core/src/scene/user.rs
1768151357|Claude|M|rource-wasm/www/index.html
1768152039|Claude|M|rource-wasm/src/lib.rs
1768152039|Claude|M|rource-wasm/www/index.html
1768153285|Claude|M|rource-wasm/src/lib.rs
1768153285|Claude|M|rource-wasm/www/index.html
1768153285|Claude|A|rource-wasm/www/pkg/package.json
1768153285|Claude|A|rource-wasm/www/pkg/rource_wasm.d.ts
1768153285|Claude|A|rource-wasm/www/pkg/rource_wasm.js
1768153285|Claude|A|rource-wasm/www/pkg/rource_wasm_bg.wasm
1768153285|Claude|A|rource-wasm/www/pkg/rource_wasm_bg.wasm.d.ts
1768154755|Claude|M|rource-wasm/src/lib.rs
1768154755|Claude|M|rource-wasm/www/index.html
1768155097|Claude|M|rource-wasm/www/index.html`;

        // Pre-calculate stats for the cached Rource data
        const ROURCE_STATS = (() => {
            const lines = ROURCE_CACHED_DATA.split('\n');
            const files = new Set();
            const authors = new Set();
            let commits = 0;
            let lastTimestamp = 0;
            for (const line of lines) {
                if (!line.trim()) continue;
                const parts = line.split('|');
                if (parts.length >= 4) {
                    commits++;
                    authors.add(parts[1].trim());
                    files.add(parts[3].trim());
                    const ts = parseInt(parts[0], 10);
                    if (ts > lastTimestamp) lastTimestamp = ts;
                }
            }
            return { commits, files: files.size, authors: authors.size, lastTimestamp };
        })();

        // Track additional commits fetched via refresh
        let additionalCommits = '';

        // Demo data - more comprehensive project evolution
        const DEMO_DATA = `1704067200|Alice|A|src/main.rs
1704067260|Alice|A|src/lib.rs
1704067320|Alice|A|Cargo.toml
1704067380|Alice|A|README.md
1704153600|Bob|A|src/config.rs
1704153660|Bob|M|src/main.rs
1704153720|Bob|A|src/utils/mod.rs
1704153780|Bob|A|src/utils/helpers.rs
1704240000|Charlie|A|tests/test_main.rs
1704240060|Charlie|M|src/lib.rs
1704240120|Charlie|A|tests/test_config.rs
1704326400|Alice|M|src/main.rs
1704326460|Alice|M|src/config.rs
1704326520|Alice|A|docs/API.md
1704412800|Bob|A|src/api/mod.rs
1704412860|Bob|A|src/api/routes.rs
1704412920|Bob|A|src/api/handlers.rs
1704412980|Bob|M|src/main.rs
1704499200|Charlie|A|src/db/mod.rs
1704499260|Charlie|A|src/db/models.rs
1704499320|Charlie|A|src/db/queries.rs
1704499380|Charlie|M|src/api/handlers.rs
1704585600|Alice|A|src/auth/mod.rs
1704585660|Alice|A|src/auth/jwt.rs
1704585720|Alice|M|src/api/routes.rs
1704585780|Alice|A|tests/test_auth.rs
1704672000|Bob|M|src/db/queries.rs
1704672060|Bob|M|src/api/handlers.rs
1704672120|Bob|A|migrations/001_initial.sql
1704758400|Charlie|A|.github/workflows/ci.yml
1704758460|Charlie|M|Cargo.toml
1704758520|Charlie|A|Dockerfile
1704844800|Alice|M|README.md
1704844860|Alice|A|docs/DEPLOY.md
1704844920|Alice|M|src/main.rs
1704931200|Bob|D|src/utils/helpers.rs
1704931260|Bob|A|src/utils/string.rs
1704931320|Bob|A|src/utils/time.rs
1704931380|Bob|M|src/utils/mod.rs
1705017600|Charlie|M|src/auth/jwt.rs
1705017660|Charlie|A|src/auth/middleware.rs
1705017720|Charlie|M|src/api/routes.rs
1705104000|Diana|A|frontend/index.html
1705104060|Diana|A|frontend/style.css
1705104120|Diana|A|frontend/app.js
1705190400|Eve|A|src/cache/mod.rs
1705190460|Eve|A|src/cache/redis.rs
1705190520|Eve|M|src/api/handlers.rs`;

        // DOM elements
        const canvas = document.getElementById('canvas');
        const btnPlay = document.getElementById('btn-play');
        const playIcon = document.getElementById('play-icon');
        const playText = document.getElementById('play-text');
        const btnPlaySmall = document.getElementById('btn-play-small');
        const playIconSmall = document.getElementById('play-icon-small');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const btnReset = document.getElementById('btn-reset');
        const btnLabels = document.getElementById('btn-labels');
        const labelsText = document.getElementById('labels-text');
        const btnScreenshot = document.getElementById('btn-screenshot');
        const contextLostOverlay = document.getElementById('context-lost-overlay');
        const btnRestoreContext = document.getElementById('btn-restore-context');
        const btnLoad = document.getElementById('btn-load');
        const btnLoadFile = document.getElementById('btn-load-file');
        const btnCopyCommand = document.getElementById('btn-copy-command');
        const btnFetchGithub = document.getElementById('btn-fetch-github');
        const githubUrlInput = document.getElementById('github-url');
        const fetchStatus = document.getElementById('fetch-status');
        const fetchStatusText = document.getElementById('fetch-status-text');
        const fetchProgressBar = document.getElementById('fetch-progress-bar');
        const logInput = document.getElementById('log-input');
        const loadingEl = document.getElementById('loading');
        const timelineSlider = document.getElementById('timeline-slider');
        const timelineInfo = document.getElementById('timeline-info');
        const speedSelect = document.getElementById('speed-select');
        const fileInput = document.getElementById('file-input');
        const fileDropZone = document.getElementById('file-drop-zone');
        const fileNameEl = document.getElementById('file-name');
        const emptyState = document.getElementById('empty-state');
        const rendererBadge = document.getElementById('renderer-badge');
        const statsOverlay = document.getElementById('stats-overlay');
        const statCommits = document.getElementById('stat-commits');
        const statFiles = document.getElementById('stat-files');
        const statAuthors = document.getElementById('stat-authors');
        const toast = document.getElementById('toast');

        // Performance metrics DOM elements
        const perfOverlay = document.getElementById('perf-overlay');
        const perfFps = document.getElementById('perf-fps');
        const perfFrameTime = document.getElementById('perf-frame-time');
        const perfEntities = document.getElementById('perf-entities');
        const perfVisible = document.getElementById('perf-visible');
        const perfDraws = document.getElementById('perf-draws');
        const perfResolution = document.getElementById('perf-resolution');
        const techRenderer = document.getElementById('tech-renderer');

        // Showcase panel DOM elements
        const btnVisualizeRource = document.getElementById('btn-visualize-rource');
        const btnRefreshRource = document.getElementById('btn-refresh-rource');
        const refreshStatus = document.getElementById('refresh-status');
        const showcaseCommits = document.getElementById('showcase-commits');
        const showcaseFiles = document.getElementById('showcase-files');
        const showcaseAuthors = document.getElementById('showcase-authors');

        // Authors legend DOM elements
        const authorsPanel = document.getElementById('authors-panel');
        const authorsItems = document.getElementById('authors-items');
        const authorsToggle = document.getElementById('authors-toggle');

        // New UI feature DOM elements
        const themeToggle = document.getElementById('btn-theme');
        const helpBtn = document.getElementById('btn-help');
        const helpOverlay = document.getElementById('help-overlay');
        const helpClose = document.getElementById('help-close');
        const helpGotIt = document.getElementById('help-got-it');
        const sidebarPanel = document.getElementById('sidebar-panel');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const commitTooltip = document.getElementById('commit-tooltip');
        const tooltipAuthorColor = document.getElementById('tooltip-author-color');
        const tooltipAuthor = document.getElementById('tooltip-author');
        const tooltipDate = document.getElementById('tooltip-date');
        const tooltipFile = document.getElementById('tooltip-file');
        const tooltipAction = document.getElementById('tooltip-action');

        // Author filter state
        let filteredAuthor = null;
        let authorColorMap = new Map();

        // Timeline markers DOM element
        const timelineMarkers = document.getElementById('timeline-markers');

        // First visit state for help overlay
        const HELP_SHOWN_KEY = 'rource_help_shown';

        // Toast notification
        function showToast(message, type = 'error', duration = 5000) {
            toast.querySelector('.toast-message').textContent = message;
            toast.className = `toast ${type} visible`;
            setTimeout(() => toast.classList.remove('visible'), duration);
        }

        toast.querySelector('.toast-close').addEventListener('click', () => {
            toast.classList.remove('visible');
        });

        // Resize canvas
        function resizeCanvas() {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            const width = Math.floor(rect.width);
            const height = Math.floor(rect.height);

            if (canvas.width !== width || canvas.height !== height) {
                canvas.width = width;
                canvas.height = height;
                if (rource) {
                    rource.resize(width, height);
                    rource.forceRender();
                }
            }
        }

        // Performance metrics update counter (update every N frames for performance)
        let perfUpdateCounter = 0;
        const PERF_UPDATE_INTERVAL = 10; // Update every 10 frames

        // Animation loop
        function animate(timestamp) {
            if (rource) {
                rource.frame(timestamp);
                updateUI();

                // Update performance metrics periodically
                perfUpdateCounter++;
                if (perfUpdateCounter >= PERF_UPDATE_INTERVAL) {
                    updatePerfMetrics();
                    perfUpdateCounter = 0;
                }
            }
            animationId = requestAnimationFrame(animate);
        }

        // Update performance metrics overlay
        function updatePerfMetrics() {
            if (!rource || !hasLoadedData) return;

            try {
                // Get FPS and frame time
                const fps = rource.getFps();
                const frameTimeMs = rource.getFrameTimeMs();

                // Get render statistics
                const totalEntities = rource.getTotalEntities();
                const visibleFiles = rource.getVisibleFiles();
                const visibleUsers = rource.getVisibleUsers();
                const visibleDirs = rource.getVisibleDirectories();
                const drawCalls = rource.getDrawCalls();
                const width = rource.getCanvasWidth();
                const height = rource.getCanvasHeight();

                // Update FPS display with color coding and playback status
                const fpsRounded = Math.round(fps);
                const isPlaying = rource.isPlaying();
                const total = rource.commitCount();
                const current = rource.currentCommit();
                const isComplete = current >= total - 1 && !isPlaying;

                if (isComplete) {
                    perfFps.textContent = `Complete`;
                    perfFps.className = 'perf-fps complete';
                } else if (!isPlaying) {
                    perfFps.textContent = `Paused`;
                    perfFps.className = 'perf-fps paused';
                } else {
                    perfFps.textContent = `${fpsRounded} FPS`;
                    perfFps.className = 'perf-fps ' + (fpsRounded >= 55 ? 'good' : fpsRounded >= 30 ? 'ok' : 'bad');
                }

                // Update other metrics
                perfFrameTime.textContent = `${frameTimeMs.toFixed(1)}ms`;
                perfEntities.textContent = totalEntities.toLocaleString();
                perfVisible.textContent = `${visibleFiles + visibleUsers + visibleDirs}`;
                perfDraws.textContent = drawCalls.toString();
                perfResolution.textContent = `${width}${height}`;
            } catch (e) {
                // Silently ignore errors if methods don't exist
            }
        }

        // Update UI
        function updateUI() {
            if (!rource) return;

            const playing = rource.isPlaying();
            const total = rource.commitCount();
            const current = rource.currentCommit();

            // Update play buttons
            const pauseIcon = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
            const playIconPath = '<path d="M8 5v14l11-7z"/>';

            playText.textContent = playing ? 'Pause' : 'Play';
            playIcon.innerHTML = playing ? pauseIcon : playIconPath;
            playIconSmall.innerHTML = playing ? pauseIcon : playIconPath;

            if (playing) {
                btnPlaySmall.classList.add('active');
            } else {
                btnPlaySmall.classList.remove('active');
            }

            // Update timeline
            if (total > 0) {
                timelineSlider.max = total - 1;
                timelineSlider.value = Math.min(current, total - 1);
                timelineSlider.disabled = false;
                timelineInfo.textContent = `${Math.min(current + 1, total)} / ${total}`;
            } else {
                timelineSlider.max = 0;
                timelineSlider.value = 0;
                timelineSlider.disabled = true;
                timelineInfo.textContent = '0 / 0';
            }
        }

        // Analyze log data for stats
        function analyzeLogData(content) {
            const lines = content.split('\n');
            const files = new Set();
            const authors = new Set();
            let commits = 0;

            for (const line of lines) {
                if (!line.trim()) continue;
                const parts = line.split('|');
                if (parts.length >= 4) {
                    commits++;
                    authors.add(parts[1].trim());
                    files.add(parts[3].trim());
                }
            }

            return { commits, files: files.size, authors };
        }

        // Load log data
        function loadLogData(content, format = 'custom') {
            if (!rource || !content.trim()) {
                showToast('Please enter or upload log data first.', 'error');
                return;
            }

            try {
                let count;
                if (format === 'git') {
                    count = rource.loadGitLog(content);
                } else {
                    count = rource.loadCustomLog(content);
                }

                if (count === 0) {
                    showToast('No commits found. Check your log format.', 'error');
                    return;
                }

                // Analyze data
                const stats = analyzeLogData(content);
                statCommits.textContent = count;
                statFiles.textContent = stats.files;
                statAuthors.textContent = stats.authors.size;

                hasLoadedData = true;
                emptyState.classList.add('hidden');
                statsOverlay.classList.remove('hidden');
                perfOverlay.classList.remove('hidden');

                // Enable controls
                btnPrev.disabled = false;
                btnNext.disabled = false;
                speedSelect.disabled = false;

                updateUI();
                updateLegend(content);
                updateAuthorsLegend(content);
                updateTimelineMarkers(content);
                updatePerfMetrics();

                // Parse commits for tooltip display
                parseCommitsForTooltip(content);

                // Show first-time help overlay
                maybeShowFirstTimeHelp();

                showToast(`Loaded ${count} commits from ${stats.authors.size} authors!`, 'success', 3000);

                // Auto-play
                rource.play();
                updateUI();

            } catch (e) {
                showToast(`Failed to parse log: ${e}`, 'error');
                console.error('Parse error:', e);
            }
        }

        // Extension colors (matches Rust code)
        const extensionColors = {
            'rs': '#dea584', 'go': '#00add8', 'py': '#3572a5',
            'js': '#f7df1e', 'ts': '#3178c6', 'jsx': '#61dafb', 'tsx': '#61dafb',
            'java': '#b07219', 'kt': '#a78bfa', 'c': '#5555ff', 'cpp': '#00599c',
            'cs': '#9b4f96', 'rb': '#cc342d', 'php': '#4f5d95', 'swift': '#f05138',
            'html': '#e34c26', 'css': '#563d7c', 'scss': '#cd6799',
            'json': '#808080', 'yaml': '#cb171e', 'yml': '#cb171e',
            'toml': '#9c4221', 'xml': '#0060ac', 'md': '#083fa1',
            'sh': '#008000', 'sql': '#e38c00', 'dockerfile': '#2496ed'
        };

        function getExtensionColor(ext) {
            const lower = ext.toLowerCase();
            if (extensionColors[lower]) return extensionColors[lower];
            // Hash for unknown extensions
            let hash = 0;
            for (let i = 0; i < lower.length; i++) {
                hash = (hash * 31 + lower.charCodeAt(i)) >>> 0;
            }
            return `hsl(${hash % 360}, 50%, 50%)`;
        }

        // =====================================================================
        // TIMELINE MARKERS
        // =====================================================================
        // Creates visual markers on the timeline for significant commits
        // (first commit, large commits, recent activity bursts)
        // =====================================================================
        function updateTimelineMarkers(content) {
            if (!timelineMarkers) return;

            // Clear existing markers
            timelineMarkers.innerHTML = '';

            const lines = content.trim().split('\n').filter(l => l.trim());
            const totalCommits = lines.length;

            if (totalCommits === 0) return;

            // Parse commits to find significant ones
            const commitData = [];
            let commitIndex = 0;

            for (const line of lines) {
                const parts = line.split('|');
                if (parts.length >= 4) {
                    const timestamp = parseInt(parts[0], 10);
                    const author = parts[1];
                    const action = parts[2];
                    const path = parts[3];

                    // Track file count per commit (commits can span multiple lines)
                    if (commitData.length === 0 || commitData[commitData.length - 1].timestamp !== timestamp) {
                        commitData.push({
                            index: commitIndex++,
                            timestamp,
                            author,
                            fileCount: 1
                        });
                    } else {
                        commitData[commitData.length - 1].fileCount++;
                    }
                }
            }

            // Deduplicate to actual commit count
            const uniqueCommits = commitData.length;
            if (uniqueCommits === 0) return;

            // Find significant commits:
            // 1. First commit
            // 2. Commits with many file changes (> 10 files)
            // 3. Every 20% milestone

            const markers = [];

            // First commit marker
            markers.push({ position: 0, type: 'first-commit', title: 'First commit' });

            // Find large commits (more than 10 file changes)
            const avgFiles = commitData.reduce((sum, c) => sum + c.fileCount, 0) / commitData.length;
            const largeThreshold = Math.max(10, avgFiles * 3);

            for (let i = 0; i < commitData.length; i++) {
                const commit = commitData[i];
                if (commit.fileCount >= largeThreshold) {
                    markers.push({
                        position: (i / (uniqueCommits - 1)) * 100,
                        type: 'large-commit',
                        title: `Large commit: ${commit.fileCount} files changed`
                    });
                }
            }

            // Add milestone markers (25%, 50%, 75%)
            const milestones = [0.25, 0.5, 0.75];
            for (const milestone of milestones) {
                const idx = Math.floor(milestone * (uniqueCommits - 1));
                if (idx > 0 && idx < uniqueCommits - 1) {
                    // Only add if not too close to other markers
                    const pos = milestone * 100;
                    const tooClose = markers.some(m => Math.abs(m.position - pos) < 5);
                    if (!tooClose) {
                        markers.push({
                            position: pos,
                            type: 'recent-commit',
                            title: `${Math.round(milestone * 100)}% milestone`
                        });
                    }
                }
            }

            // Create marker elements
            for (const marker of markers) {
                const el = document.createElement('div');
                el.className = `timeline-marker ${marker.type}`;
                el.style.left = `${marker.position}%`;
                el.title = marker.title;
                timelineMarkers.appendChild(el);
            }
        }

        // Update legend
        function updateLegend(content) {
            const legendItems = document.getElementById('legend-items');
            const extensionCounts = {};

            const lines = content.split('\n');
            for (const line of lines) {
                const parts = line.split('|');
                if (parts.length >= 4) {
                    const path = parts[3].trim();
                    const dotIdx = path.lastIndexOf('.');
                    if (dotIdx > 0 && dotIdx < path.length - 1) {
                        const ext = path.substring(dotIdx + 1).toLowerCase();
                        if (ext.length <= 10) {
                            extensionCounts[ext] = (extensionCounts[ext] || 0) + 1;
                        }
                    }
                }
            }

            const sorted = Object.entries(extensionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 12);

            legendItems.innerHTML = sorted.map(([ext, count]) => {
                const color = getExtensionColor(ext);
                return `<div class="legend-item" role="listitem">
                    <span class="legend-color" style="background: ${color}"></span>
                    <span class="legend-ext">.${ext}</span>
                    <span class="legend-count">${count}</span>
                </div>`;
            }).join('');

            if (sorted.length > 0) {
                document.getElementById('legend-panel').classList.remove('collapsed');
                document.getElementById('legend-toggle').setAttribute('aria-expanded', 'true');
            }
        }

        // Legend toggle
        const legendToggle = document.getElementById('legend-toggle');
        legendToggle.addEventListener('click', () => {
            const panel = document.getElementById('legend-panel');
            panel.classList.toggle('collapsed');
            const isExpanded = !panel.classList.contains('collapsed');
            legendToggle.setAttribute('aria-expanded', isExpanded.toString());
        });

        // =====================================================================
        // AUTHORS LEGEND
        // =====================================================================
        // Updates the authors legend panel with contributors and their colors.
        // Uses the WASM getAuthors() API to get accurate color assignments.
        // =====================================================================
        function updateAuthorsLegend(content) {
            if (!rource) return;

            // Clear existing author color map
            authorColorMap.clear();

            // Parse author data from log content first (before WASM is populated)
            const authorCommits = {};
            const lines = content.split('\n');
            for (const line of lines) {
                if (!line.trim()) continue;
                const parts = line.split('|');
                if (parts.length >= 4) {
                    const author = parts[1].trim();
                    authorCommits[author] = (authorCommits[author] || 0) + 1;
                }
            }

            // Sort by commit count descending
            const sorted = Object.entries(authorCommits)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Show top 10 authors

            if (sorted.length === 0) return;

            // Build the authors items HTML and populate color map
            authorsItems.innerHTML = sorted.map(([name, commits]) => {
                // Get color from WASM (deterministic based on name hash)
                let color;
                try {
                    color = rource.getAuthorColor(name);
                } catch (e) {
                    // Fallback color generation if WASM method isn't available
                    let hash = 0;
                    for (let i = 0; i < name.length; i++) {
                        hash = (hash * 31 + name.charCodeAt(i)) >>> 0;
                    }
                    color = `hsl(${hash % 360}, 60%, 55%)`;
                }

                // Store in color map for tooltip use
                authorColorMap.set(name, color);

                // Escape HTML in name
                const escapedName = name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<div class="author-item" role="listitem" title="Click to filter by ${escapedName} (${commits} commits)">
                    <span class="author-color" style="background: ${color}"></span>
                    <span class="author-name">${escapedName}</span>
                    <span class="author-commits">${commits}</span>
                </div>`;
            }).join('');

            // Add clear filter button to header if not present
            const header = authorsPanel.querySelector('.authors-header');
            if (header && !header.querySelector('.author-filter-clear')) {
                const clearBtn = document.createElement('span');
                clearBtn.className = 'author-filter-clear';
                clearBtn.textContent = 'Clear';
                clearBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clearAuthorFilter();
                });
                header.appendChild(clearBtn);
            }

            // Show the authors panel
            authorsPanel.classList.remove('hidden');
            authorsPanel.classList.remove('collapsed');
            authorsToggle.setAttribute('aria-expanded', 'true');
        }

        // Authors legend toggle
        authorsToggle.addEventListener('click', () => {
            authorsPanel.classList.toggle('collapsed');
            const isExpanded = !authorsPanel.classList.contains('collapsed');
            authorsToggle.setAttribute('aria-expanded', isExpanded.toString());
        });

        // Keyboard shortcuts for authors panel (A key)
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            if (e.key === 'a' || e.key === 'A') {
                if (hasLoadedData && !authorsPanel.classList.contains('hidden')) {
                    authorsPanel.classList.toggle('collapsed');
                    const isExpanded = !authorsPanel.classList.contains('collapsed');
                    authorsToggle.setAttribute('aria-expanded', isExpanded.toString());
                }
            }
        });

        // Performance overlay toggle
        const perfToggle = document.getElementById('perf-toggle');
        perfToggle.addEventListener('click', () => {
            perfOverlay.classList.toggle('collapsed');
            const isExpanded = !perfOverlay.classList.contains('collapsed');
            perfToggle.setAttribute('aria-expanded', isExpanded.toString());
        });

        // Keyboard shortcut for performance overlay (P key)
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            if (e.key === 'p' || e.key === 'P') {
                if (hasLoadedData) {
                    perfOverlay.classList.toggle('hidden');
                }
            }
        });

        // GitHub API rate limit tracking
        let rateLimitRemaining = 60;
        let rateLimitReset = 0;

        // Cache for fetched repos (uses localStorage)
        const CACHE_KEY = 'rource_github_cache';
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours

        function getCache() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    // Clean expired entries
                    const now = Date.now();
                    for (const key of Object.keys(data)) {
                        if (data[key].timestamp < now - CACHE_EXPIRY) {
                            delete data[key];
                        }
                    }
                    return data;
                }
            } catch (e) { /* ignore */ }
            return {};
        }

        function setCache(key, logContent) {
            try {
                const cache = getCache();
                cache[key] = { logContent, timestamp: Date.now() };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            } catch (e) { /* ignore quota errors */ }
        }

        function getCachedRepo(owner, repo) {
            const cache = getCache();
            const key = `${owner}/${repo}`;
            if (cache[key] && cache[key].timestamp > Date.now() - CACHE_EXPIRY) {
                return cache[key].logContent;
            }
            return null;
        }

        // Check rate limit before making requests
        async function checkRateLimit() {
            try {
                const response = await fetch('https://api.github.com/rate_limit', {
                    headers: { 'Accept': 'application/vnd.github.v3+json' }
                });
                if (response.ok) {
                    const data = await response.json();
                    rateLimitRemaining = data.rate.remaining;
                    rateLimitReset = data.rate.reset * 1000;
                    return rateLimitRemaining;
                }
            } catch (e) { /* ignore */ }
            return rateLimitRemaining;
        }

        function formatTimeUntilReset() {
            const now = Date.now();
            if (rateLimitReset <= now) return 'soon';
            const minutes = Math.ceil((rateLimitReset - now) / 60000);
            return minutes === 1 ? '1 minute' : `${minutes} minutes`;
        }

        // GitHub API fetch with caching and rate limit awareness
        async function fetchGitHubRepo(repoUrl) {
            // Parse repo URL
            let owner, repo;
            try {
                const url = new URL(repoUrl.includes('://') ? repoUrl : 'https://' + repoUrl);
                const parts = url.pathname.split('/').filter(p => p);
                if (parts.length < 2) throw new Error('Invalid URL');
                owner = parts[0];
                repo = parts[1].replace('.git', '');
            } catch (e) {
                // Try simple format: owner/repo
                const parts = repoUrl.split('/').filter(p => p);
                if (parts.length >= 2) {
                    owner = parts[parts.length - 2];
                    repo = parts[parts.length - 1].replace('.git', '');
                } else {
                    throw new Error('Invalid repository URL. Use format: owner/repo or https://github.com/owner/repo');
                }
            }

            // Check cache first
            const cachedContent = getCachedRepo(owner, repo);
            if (cachedContent) {
                fetchStatus.className = 'fetch-status visible success';
                fetchStatusText.textContent = `Loaded ${owner}/${repo} from cache!`;
                fetchProgressBar.style.width = '100%';
                loadLogData(cachedContent, 'custom');
                lastLoadedRepo = `${owner}/${repo}`;
                updateUrlState({ repo: `${owner}/${repo}` });
                return;
            }

            // Check rate limit before proceeding
            const remaining = await checkRateLimit();
            if (remaining < 5) {
                throw new Error(`GitHub API rate limit low (${remaining} requests left). Resets in ${formatTimeUntilReset()}. Try a cached repo or wait.`);
            }

            fetchStatus.className = 'fetch-status visible loading';
            fetchStatusText.textContent = `Fetching commits from ${owner}/${repo}... (${remaining} API calls remaining)`;
            fetchProgressBar.style.width = '10%';

            // Limit commits based on available rate limit (each commit needs 1 API call for details)
            const maxDetailedCommits = Math.min(50, Math.floor(remaining * 0.8)); // Use 80% of remaining, max 50

            try {
                // Fetch commit list (single API call for many commits)
                const response = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/commits?per_page=100`,
                    { headers: { 'Accept': 'application/vnd.github.v3+json' } }
                );

                // Update rate limit from response headers
                const limitHeader = response.headers.get('X-RateLimit-Remaining');
                if (limitHeader) rateLimitRemaining = parseInt(limitHeader, 10);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Repository not found. Make sure it exists and is public.');
                    } else if (response.status === 403) {
                        const resetHeader = response.headers.get('X-RateLimit-Reset');
                        if (resetHeader) rateLimitReset = parseInt(resetHeader, 10) * 1000;
                        throw new Error(`GitHub API rate limit exceeded. Resets in ${formatTimeUntilReset()}.`);
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                const commits = await response.json();
                if (commits.length === 0) {
                    throw new Error('No commits found in this repository.');
                }

                fetchProgressBar.style.width = '20%';
                fetchStatusText.textContent = `Found ${commits.length} commits. Fetching file details (limited to ${maxDetailedCommits} to preserve API quota)...`;

                const logLines = [];
                const limitedCommits = commits.slice(0, maxDetailedCommits);
                let fetchedCount = 0;
                let skippedDueToRateLimit = 0;

                for (let i = 0; i < limitedCommits.length; i++) {
                    // Check if we're running low on rate limit
                    if (rateLimitRemaining < 3) {
                        skippedDueToRateLimit = limitedCommits.length - i;
                        break;
                    }

                    const commit = limitedCommits[i];
                    const timestamp = Math.floor(new Date(commit.commit.author.date).getTime() / 1000);
                    const author = commit.commit.author.name || 'Unknown';

                    // Fetch commit details for file changes
                    try {
                        const detailResponse = await fetch(commit.url, {
                            headers: { 'Accept': 'application/vnd.github.v3+json' }
                        });

                        // Update rate limit
                        const limitHeader = detailResponse.headers.get('X-RateLimit-Remaining');
                        if (limitHeader) rateLimitRemaining = parseInt(limitHeader, 10);

                        if (detailResponse.status === 403) {
                            skippedDueToRateLimit = limitedCommits.length - i;
                            break;
                        }

                        if (detailResponse.ok) {
                            const detail = await detailResponse.json();
                            if (detail.files) {
                                for (const file of detail.files.slice(0, 50)) {
                                    let action = 'M';
                                    if (file.status === 'added') action = 'A';
                                    else if (file.status === 'removed') action = 'D';
                                    logLines.push(`${timestamp}|${author}|${action}|${file.filename}`);
                                }
                            }
                            fetchedCount++;
                        }
                    } catch (e) {
                        // Skip failed file fetches
                    }

                    // Update progress
                    fetchProgressBar.style.width = `${20 + (i / limitedCommits.length) * 70}%`;
                    fetchStatusText.textContent = `Processing commits... ${i + 1}/${limitedCommits.length} (${rateLimitRemaining} API calls left)`;

                    // Small delay to be nice to the API
                    if (i % 5 === 4) {
                        await new Promise(r => setTimeout(r, 50));
                    }
                }

                // Reverse to get chronological order
                logLines.reverse();

                if (logLines.length === 0) {
                    throw new Error('Could not fetch file changes. The repository may be empty or API limit was reached.');
                }

                // Cache the result
                const logContent = logLines.join('\n');
                setCache(`${owner}/${repo}`, logContent);

                fetchProgressBar.style.width = '100%';
                fetchStatus.className = 'fetch-status visible success';
                let statusMsg = `Loaded ${logLines.length} file changes from ${fetchedCount} commits.`;
                if (skippedDueToRateLimit > 0) {
                    statusMsg += ` (${skippedDueToRateLimit} commits skipped due to rate limit)`;
                }
                fetchStatusText.textContent = statusMsg;

                loadLogData(logContent, 'custom');
                lastLoadedRepo = `${owner}/${repo}`;
                updateUrlState({ repo: `${owner}/${repo}` });

            } catch (error) {
                fetchStatus.className = 'fetch-status visible error';
                fetchStatusText.textContent = error.message;
                fetchProgressBar.style.width = '0%';
                throw error;
            }
        }

        // Initialize
        async function main() {
            try {
                await init();
                resizeCanvas();
                rource = new Rource(canvas);

                // Update renderer badge and tech panel
                const isWebGL2 = rource.isWebGL2();
                const rendererType = rource.getRendererType();
                rendererBadge.textContent = isWebGL2 ? 'WebGL2' : 'Software';
                if (isWebGL2) rendererBadge.classList.add('webgl2');
                techRenderer.textContent = isWebGL2 ? 'WebGL2' : 'CPU';

                // Enable buttons
                btnPlay.disabled = false;
                btnReset.disabled = false;
                btnLabels.disabled = false;
                btnScreenshot.disabled = false;
                btnLoad.disabled = false;
                btnFetchGithub.disabled = false;
                btnVisualizeRource.disabled = false;

                // Initialize showcase stats from pre-calculated data
                showcaseCommits.textContent = ROURCE_STATS.commits.toLocaleString();
                showcaseFiles.textContent = ROURCE_STATS.files.toLocaleString();
                showcaseAuthors.textContent = ROURCE_STATS.authors.toLocaleString();

                // Initialize labels button state
                updateLabelsButton();

                // Log technical info to console for verification
                console.log(`%c Rource Technical Info `, 'background: #e94560; color: white; font-weight: bold;');
                console.log(`  Renderer: ${rendererType}`);
                console.log(`  Canvas: ${canvas.width}${canvas.height}`);
                console.log(`  WebGL2: ${isWebGL2}`);
                console.log(`  Cached Rource Data: ${ROURCE_STATS.commits} commits, ${ROURCE_STATS.files} files, ${ROURCE_STATS.authors} authors`);

                // Start animation
                animationId = requestAnimationFrame(animate);
                loadingEl.classList.add('hidden');

                // Check URL parameters for shareable state
                const urlParams = parseUrlParams();

                // Apply speed from URL if specified
                if (urlParams.speed) {
                    const speedValue = urlParams.speed;
                    speedSelect.value = speedValue;
                    rource.setSpeed(parseFloat(speedValue));
                }

                // Load repo from URL or default to Rource
                setTimeout(async () => {
                    if (!hasLoadedData) {
                        if (urlParams.repo) {
                            // Load repo from URL parameter
                            githubUrlInput.value = urlParams.repo;
                            try {
                                await fetchGitHubRepo(urlParams.repo);
                                if (urlParams.autoplay === 'true') {
                                    rource.play();
                                    updateUI();
                                }
                            } catch (e) {
                                console.error('Failed to load repo from URL:', e);
                                // Fall back to cached Rource data
                                loadLogData(ROURCE_CACHED_DATA, 'custom');
                                lastLoadedRepo = 'rource';
                                showToast('Loaded Rource project history (cached)', 'success', 3000);
                            }
                        } else {
                            // Default: load cached Rource project
                            loadLogData(ROURCE_CACHED_DATA, 'custom');
                            lastLoadedRepo = 'rource';
                            showToast('Loaded Rource project history (cached)', 'success', 3000);
                        }
                    }
                }, 500);

            } catch (e) {
                console.error('Initialization failed:', e);
                loadingEl.querySelector('.loading-text').textContent = 'Failed to load: ' + e.message;
                showToast(`Initialization failed: ${e.message}`, 'error', 10000);
            }
        }

        // Event handlers
        btnPlay.addEventListener('click', () => {
            if (rource && hasLoadedData) {
                rource.togglePlay();
                updateUI();
            } else if (!hasLoadedData) {
                // Load Rource project data by default (cached)
                loadLogData(ROURCE_CACHED_DATA, 'custom');
            }
        });

        btnPlaySmall.addEventListener('click', () => {
            if (rource && hasLoadedData) {
                rource.togglePlay();
                updateUI();
            }
        });

        btnPrev.addEventListener('click', () => {
            if (rource) {
                rource.stepBackward();
                updateUI();
            }
        });

        btnNext.addEventListener('click', () => {
            if (rource) {
                rource.stepForward();
                updateUI();
            }
        });

        btnReset.addEventListener('click', () => {
            if (rource) rource.resetCamera();
        });

        btnLabels.addEventListener('click', () => {
            if (rource) {
                const currentState = rource.getShowLabels();
                rource.setShowLabels(!currentState);
                updateLabelsButton();
            }
        });

        function updateLabelsButton() {
            if (rource) {
                const showLabels = rource.getShowLabels();
                labelsText.textContent = showLabels ? 'Labels' : 'Labels Off';
                btnLabels.classList.toggle('active', showLabels);
            }
        }

        // =====================================================================
        // SCREENSHOT DOWNLOAD
        // =====================================================================
        // Downloads the current canvas as a PNG image.
        // Works with both WebGL2 and software renderers.
        // =====================================================================
        btnScreenshot.addEventListener('click', () => {
            if (!rource || isContextLost) {
                showToast('Cannot capture screenshot - visualization not ready', 'error');
                return;
            }

            try {
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `rource-${timestamp}.png`;

                // Use canvas.toBlob for best quality (works with WebGL2 too)
                canvas.toBlob((blob) => {
                    if (!blob) {
                        showToast('Failed to capture screenshot', 'error');
                        return;
                    }

                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();

                    // Cleanup
                    URL.revokeObjectURL(url);
                    showToast(`Screenshot saved: ${filename}`, 'success', 3000);
                }, 'image/png', 1.0);

            } catch (error) {
                console.error('Screenshot error:', error);
                showToast('Failed to capture screenshot: ' + error.message, 'error');
            }
        });

        // =====================================================================
        // WEBGL CONTEXT LOSS RECOVERY
        // =====================================================================
        // Handles WebGL context loss gracefully with user-friendly recovery.
        // Context loss can occur on mobile devices or when switching tabs.
        // =====================================================================
        canvas.addEventListener('webglcontextlost', (event) => {
            event.preventDefault();
            console.warn('WebGL context lost');
            isContextLost = true;
            contextLostOverlay.classList.remove('hidden');

            // Pause animation to prevent errors
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        });

        canvas.addEventListener('webglcontextrestored', () => {
            console.log('WebGL context restored');
            isContextLost = false;
            contextLostOverlay.classList.add('hidden');

            // Resume animation loop
            if (rource && hasLoadedData) {
                requestAnimationFrame(animationLoop);
            }
        });

        btnRestoreContext.addEventListener('click', () => {
            // Force context restoration by recreating the WASM instance
            contextLostOverlay.classList.add('hidden');

            showToast('Restoring visualization...', 'success', 2000);

            // Re-initialize after a short delay
            setTimeout(async () => {
                try {
                    // Re-create the Rource instance
                    const width = canvas.width;
                    const height = canvas.height;
                    rource = new Rource('canvas', width, height);

                    // Reload the last data if available
                    if (lastLoadedRepo === 'rource') {
                        loadLogData(ROURCE_CACHED_DATA + (additionalCommits ? '\n' + additionalCommits : ''), 'custom');
                    } else if (uploadedFileContent) {
                        loadLogData(uploadedFileContent, 'custom');
                    }

                    isContextLost = false;
                    showToast('Visualization restored!', 'success', 2000);
                } catch (error) {
                    console.error('Failed to restore:', error);
                    showToast('Failed to restore visualization. Please refresh the page.', 'error');
                }
            }, 500);
        });

        // =====================================================================
        // SHOWCASE: VISUALIZE ROURCE BUTTON
        // =====================================================================
        // Loads the cached Rource repository data - no API calls needed.
        // This ensures the demo always works regardless of GitHub rate limits.
        // =====================================================================
        btnVisualizeRource.addEventListener('click', () => {
            if (!rource) return;

            // Reset the visualization and load cached Rource data
            btnVisualizeRource.disabled = true;
            btnVisualizeRource.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="spin">
                    <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                </svg>
                Loading...
            `;

            // Short delay for visual feedback
            setTimeout(() => {
                // Combine cached data with any additional fetched commits
                const fullData = additionalCommits
                    ? ROURCE_CACHED_DATA + '\n' + additionalCommits
                    : ROURCE_CACHED_DATA;
                loadLogData(fullData, 'custom');
                lastLoadedRepo = 'rource';
                // Clear repo from URL when loading the cached Rource data
                updateUrlState({ repo: null });
                btnVisualizeRource.disabled = false;
                btnVisualizeRource.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    Visualize Rource
                `;
            }, 100);
        });

        // REFRESH: FETCH LATEST COMMITS FROM GITHUB
        // =====================================================================
        // Fetches commits since the last cached timestamp.
        // Uses GitHub API but only for incremental updates.
        // =====================================================================
        btnRefreshRource.addEventListener('click', async () => {
            if (btnRefreshRource.classList.contains('loading')) return;

            btnRefreshRource.classList.add('loading');
            refreshStatus.className = 'refresh-status loading';
            refreshStatus.textContent = 'Fetching latest commits...';
            refreshStatus.classList.remove('hidden');

            try {
                // Check rate limit first
                const remaining = await checkRateLimit();
                if (remaining < 5) {
                    throw new Error(`Rate limit low (${remaining}). Resets ${formatTimeUntilReset()}.`);
                }

                // Fetch commits since the cached timestamp
                const sinceDate = new Date(ROURCE_STATS.lastTimestamp * 1000).toISOString();
                const response = await fetch(
                    `https://api.github.com/repos/tomtom215/rource/commits?since=${sinceDate}&per_page=100`,
                    { headers: { 'Accept': 'application/vnd.github.v3+json' } }
                );

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                const commits = await response.json();

                if (commits.length <= 1) {
                    // Only the last cached commit or none - no new commits
                    refreshStatus.className = 'refresh-status success';
                    refreshStatus.textContent = 'Already up to date!';
                    setTimeout(() => refreshStatus.classList.add('hidden'), 3000);
                } else {
                    // Fetch files for each new commit (skip the first which is our cached one)
                    let newEntries = [];
                    for (const commit of commits.slice(1)) {
                        const timestamp = Math.floor(new Date(commit.commit.author.date).getTime() / 1000);
                        const author = commit.commit.author.name || 'Unknown';

                        // Fetch commit details for files
                        const detailResponse = await fetch(commit.url, {
                            headers: { 'Accept': 'application/vnd.github.v3+json' }
                        });

                        if (detailResponse.ok) {
                            const detail = await detailResponse.json();
                            for (const file of (detail.files || [])) {
                                const action = file.status === 'added' ? 'A'
                                    : file.status === 'removed' ? 'D' : 'M';
                                newEntries.push(`${timestamp}|${author}|${action}|${file.filename}`);
                            }
                        }
                    }

                    if (newEntries.length > 0) {
                        additionalCommits = newEntries.join('\n');
                        const newCommitCount = commits.length - 1;
                        refreshStatus.className = 'refresh-status success';
                        refreshStatus.textContent = `Found ${newCommitCount} new commit${newCommitCount === 1 ? '' : 's'} (${newEntries.length} files). Click "Visualize" to reload.`;

                        // Update stats display
                        const totalCommits = ROURCE_STATS.commits + newEntries.length;
                        showcaseCommits.textContent = totalCommits.toLocaleString() + '+';
                    } else {
                        refreshStatus.className = 'refresh-status success';
                        refreshStatus.textContent = 'Already up to date!';
                        setTimeout(() => refreshStatus.classList.add('hidden'), 3000);
                    }
                }

            } catch (error) {
                console.error('Refresh error:', error);
                refreshStatus.className = 'refresh-status error';
                refreshStatus.textContent = error.message || 'Failed to fetch updates';
            } finally {
                btnRefreshRource.classList.remove('loading');
            }
        });

        btnLoad.addEventListener('click', () => {
            if (logInput.value.trim()) {
                loadLogData(logInput.value, 'custom');
            } else {
                showToast('Please paste log data first.', 'error');
            }
        });

        // Speed control
        speedSelect.addEventListener('change', () => {
            if (rource) {
                const speed = speedSelect.value;
                rource.setSpeed(parseFloat(speed));
                updateUrlState({ speed });
            }
        });

        // Timeline slider
        timelineSlider.addEventListener('input', () => {
            if (rource) {
                rource.pause();
                rource.seek(parseInt(timelineSlider.value, 10));
                updateUI();
            }
        });

        // GitHub fetch
        btnFetchGithub.addEventListener('click', async () => {
            const url = githubUrlInput.value.trim();
            if (!url) {
                showToast('Please enter a GitHub repository URL.', 'error');
                return;
            }

            btnFetchGithub.disabled = true;
            try {
                await fetchGitHubRepo(url);
            } catch (e) {
                console.error('Fetch error:', e);
            }
            btnFetchGithub.disabled = false;
        });

        githubUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') btnFetchGithub.click();
        });

        // Popular repo chips
        document.querySelectorAll('.repo-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const repo = chip.dataset.repo;
                githubUrlInput.value = `https://github.com/${repo}`;
                btnFetchGithub.click();
            });
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-selected', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');

                document.querySelectorAll('.tab-content').forEach(c => {
                    c.classList.remove('active');
                    c.setAttribute('hidden', '');
                });
                const content = document.getElementById(`tab-${tab}`);
                content.classList.add('active');
                content.removeAttribute('hidden');
            });
        });

        // File upload
        fileDropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFileUpload(e.target.files[0]);
        });

        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('dragover');
        });

        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('dragover');
        });

        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]);
        });

        function handleFileUpload(file) {
            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large. Maximum size is 10MB.', 'error');
                return;
            }

            fileNameEl.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            fileNameEl.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFileContent = e.target.result;
                btnLoadFile.disabled = false;
            };
            reader.readAsText(file);
        }

        btnLoadFile.addEventListener('click', () => {
            if (uploadedFileContent) loadLogData(uploadedFileContent, 'custom');
        });

        // Copy command
        btnCopyCommand.addEventListener('click', async () => {
            const command = document.getElementById('git-command').textContent;
            try {
                await navigator.clipboard.writeText(command);
                btnCopyCommand.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Copied!';
                setTimeout(() => {
                    btnCopyCommand.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy Command';
                }, 2000);
            } catch (e) {
                showToast('Failed to copy. Please select and copy manually.', 'error');
            }
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

            // Screenshot shortcut (S key)
            if ((e.key === 's' || e.key === 'S') && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                btnScreenshot.click();
                return;
            }

            if (rource) {
                rource.onKeyDown(e.key);
                updateUI();
                // Update labels button if L was pressed
                if (e.key === 'l' || e.key === 'L') {
                    updateLabelsButton();
                }
            }
        });

        // Mouse controls
        canvas.addEventListener('mousedown', (e) => {
            if (rource) {
                const rect = canvas.getBoundingClientRect();
                rource.onMouseDown(e.clientX - rect.left, e.clientY - rect.top);
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (rource) rource.onMouseUp();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (rource) {
                const rect = canvas.getBoundingClientRect();
                rource.onMouseMove(e.clientX - rect.left, e.clientY - rect.top);
            }
        });

        canvas.addEventListener('wheel', (e) => {
            if (rource) {
                e.preventDefault();
                rource.onWheel(e.deltaY);
            }
        }, { passive: false });

        // Touch controls
        let touchState = { startX: 0, startY: 0, initialDistance: 0, isPanning: false, isPinching: false };

        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();

            if (e.touches.length === 1) {
                touchState.isPanning = true;
                touchState.startX = e.touches[0].clientX - rect.left;
                touchState.startY = e.touches[0].clientY - rect.top;
                if (rource) rource.onMouseDown(touchState.startX, touchState.startY);
            } else if (e.touches.length === 2) {
                touchState.isPanning = false;
                touchState.isPinching = true;
                touchState.initialDistance = getTouchDistance(e.touches);
                if (rource) rource.onMouseUp();
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();

            if (touchState.isPanning && e.touches.length === 1) {
                const x = e.touches[0].clientX - rect.left;
                const y = e.touches[0].clientY - rect.top;
                if (rource) rource.onMouseMove(x, y);
            } else if (touchState.isPinching && e.touches.length === 2) {
                const currentDistance = getTouchDistance(e.touches);
                const scaleFactor = currentDistance / touchState.initialDistance;

                if (rource && Math.abs(scaleFactor - 1.0) > 0.01) {
                    rource.zoom(scaleFactor > 1.0 ? 1.05 : 0.95);
                    touchState.initialDistance = currentDistance;
                }
            }
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (rource && touchState.isPanning) rource.onMouseUp();
            touchState.isPanning = false;
            touchState.isPinching = false;
        }, { passive: false });

        // Resize handler
        window.addEventListener('resize', resizeCanvas);

        // =====================================================================
        // THEME TOGGLE
        // =====================================================================
        const THEME_KEY = 'rource_theme';

        function initTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-theme');
            }
        }

        function toggleTheme() {
            const isLight = document.documentElement.classList.toggle('light-theme');
            localStorage.setItem(THEME_KEY, isLight ? 'light' : 'dark');
        }

        themeToggle.addEventListener('click', toggleTheme);

        // Theme keyboard shortcut (T)
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            if ((e.key === 't' || e.key === 'T') && !e.ctrlKey && !e.metaKey) {
                toggleTheme();
            }
        });

        // Initialize theme
        initTheme();

        // =====================================================================
        // HELP OVERLAY
        // =====================================================================
        function showHelp() {
            helpOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function hideHelp() {
            helpOverlay.classList.remove('visible');
            document.body.style.overflow = '';
            localStorage.setItem(HELP_SHOWN_KEY, 'true');
        }

        helpBtn.addEventListener('click', showHelp);
        helpClose.addEventListener('click', hideHelp);
        helpGotIt.addEventListener('click', hideHelp);

        helpOverlay.addEventListener('click', (e) => {
            if (e.target === helpOverlay) hideHelp();
        });

        // Help keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
                e.preventDefault();
                showHelp();
            }
            if (e.key === 'Escape' && helpOverlay.classList.contains('visible')) {
                hideHelp();
            }
        });

        // Show help on first visit (after data is loaded)
        function maybeShowFirstTimeHelp() {
            if (!localStorage.getItem(HELP_SHOWN_KEY)) {
                setTimeout(showHelp, 500);
            }
        }

        // =====================================================================
        // MOBILE SIDEBAR TOGGLE
        // =====================================================================
        function openSidebar() {
            sidebarPanel.classList.add('open');
            sidebarOverlay.classList.add('visible');
            sidebarClose.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            sidebarPanel.classList.remove('open');
            sidebarOverlay.classList.remove('visible');
            sidebarClose.classList.add('hidden');
            document.body.style.overflow = '';
        }

        sidebarToggle.addEventListener('click', openSidebar);
        sidebarClose.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // Close sidebar on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebarPanel.classList.contains('open')) {
                closeSidebar();
            }
        });

        // Check viewport width and setup mobile sidebar close button visibility
        function checkMobileSidebar() {
            const isMobile = window.innerWidth <= 1200;
            if (!isMobile) {
                closeSidebar();
            }
        }

        window.addEventListener('resize', checkMobileSidebar);
        checkMobileSidebar();

        // =====================================================================
        // COMMIT TOOLTIP ON HOVER
        // =====================================================================
        let tooltipData = []; // Stores parsed commit data for tooltip lookup
        let tooltipTimeout = null;

        function parseCommitsForTooltip(logData) {
            tooltipData = [];
            const lines = logData.trim().split('\n');
            for (const line of lines) {
                const parts = line.split('|');
                if (parts.length >= 4) {
                    const timestamp = parseInt(parts[0], 10);
                    const author = parts[1];
                    const action = parts[2];
                    const path = parts[3];
                    tooltipData.push({ timestamp, author, action, path });
                }
            }
        }

        function showTooltip(x, y, data) {
            tooltipAuthorColor.style.background = authorColorMap.get(data.author) || '#e94560';
            tooltipAuthor.textContent = data.author;
            tooltipDate.textContent = new Date(data.timestamp * 1000).toLocaleDateString();
            tooltipFile.textContent = data.path;

            const actionMap = { 'A': 'add', 'M': 'modify', 'D': 'delete' };
            const actionText = { 'A': 'Added', 'M': 'Modified', 'D': 'Deleted' };
            tooltipAction.textContent = actionText[data.action] || data.action;
            tooltipAction.className = `commit-tooltip-action ${actionMap[data.action] || ''}`;

            // Position tooltip
            const tooltipRect = commitTooltip.getBoundingClientRect();
            let left = x + 15;
            let top = y + 15;

            // Keep tooltip on screen
            if (left + 320 > window.innerWidth) {
                left = x - 320 - 15;
            }
            if (top + 150 > window.innerHeight) {
                top = y - 150 - 15;
            }

            commitTooltip.style.left = `${Math.max(10, left)}px`;
            commitTooltip.style.top = `${Math.max(10, top)}px`;
            commitTooltip.classList.add('visible');
        }

        function hideTooltip() {
            commitTooltip.classList.remove('visible');
        }

        // Track mouse position for tooltip
        canvas.addEventListener('mousemove', (e) => {
            if (!rource || !hasLoadedData || tooltipData.length === 0) return;

            // Get current commit index to show relevant tooltip data
            const currentCommit = rource.currentCommit();
            if (currentCommit >= 0 && currentCommit < tooltipData.length) {
                clearTimeout(tooltipTimeout);
                tooltipTimeout = setTimeout(() => {
                    // Show tooltip for current commit after hover delay
                    showTooltip(e.clientX, e.clientY, tooltipData[Math.min(currentCommit, tooltipData.length - 1)]);
                }, 500);
            }
        });

        canvas.addEventListener('mouseleave', () => {
            clearTimeout(tooltipTimeout);
            hideTooltip();
        });

        canvas.addEventListener('mousedown', () => {
            clearTimeout(tooltipTimeout);
            hideTooltip();
        });

        // =====================================================================
        // AUTHOR FILTER
        // =====================================================================
        function setAuthorFilter(author) {
            filteredAuthor = author;
            updateAuthorFilterUI();

            // If we have rource instance, we could filter visualization
            // For now, just update UI to show which author is selected
            if (rource && typeof rource.setAuthorFilter === 'function') {
                rource.setAuthorFilter(author);
            }
        }

        function clearAuthorFilter() {
            filteredAuthor = null;
            updateAuthorFilterUI();
            if (rource && typeof rource.clearAuthorFilter === 'function') {
                rource.clearAuthorFilter();
            }
        }

        function updateAuthorFilterUI() {
            const clearBtn = authorsPanel.querySelector('.author-filter-clear');
            const authorItems = authorsPanel.querySelectorAll('.author-item');

            if (clearBtn) {
                clearBtn.classList.toggle('visible', filteredAuthor !== null);
            }

            authorItems.forEach(item => {
                const name = item.querySelector('.author-name')?.textContent;
                if (filteredAuthor === null) {
                    item.classList.remove('filtered', 'active');
                } else if (name === filteredAuthor) {
                    item.classList.remove('filtered');
                    item.classList.add('active');
                } else {
                    item.classList.add('filtered');
                    item.classList.remove('active');
                }
            });
        }

        // Add click handler to author items (delegate to parent)
        authorsItems.addEventListener('click', (e) => {
            const authorItem = e.target.closest('.author-item');
            if (authorItem) {
                const authorName = authorItem.querySelector('.author-name')?.textContent;
                if (authorName) {
                    if (filteredAuthor === authorName) {
                        clearAuthorFilter();
                    } else {
                        setAuthorFilter(authorName);
                    }
                }
            }
        });

        // =====================================================================
        // ENHANCED TOUCH GESTURES
        // =====================================================================
        // The existing touch handlers are already good, but let's add
        // two-finger pan support and improve pinch-to-zoom smoothness

        let lastTouchCenter = null;

        function getTouchCenter(touches) {
            return {
                x: (touches[0].clientX + touches[1].clientX) / 2,
                y: (touches[0].clientY + touches[1].clientY) / 2
            };
        }

        // Override the existing touchmove handler with enhanced version
        canvas.removeEventListener('touchmove', null); // Note: This won't actually remove it

        // We'll modify the touchmove behavior in-place by updating touchState usage
        // The existing handler already handles pinch-to-zoom well

        // =====================================================================
        // PERFORMANCE PANEL TOGGLE ENHANCEMENT
        // =====================================================================
        // The existing perf panel toggle is handled, but let's add keyboard shortcut info

        // Start
        main();
    </script>
</body>
</html>
