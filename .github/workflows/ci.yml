name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent CI runs on the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# Principle of least privilege - only request permissions we need
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  MSRV: "1.93"

jobs:
  # ============================================================================
  # STAGE 1: Fast checks (run first, fail fast)
  # ============================================================================

  # Format check - fastest, runs first
  fmt:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Generate format summary
        if: always()
        run: |
          echo "## Format Check" >> $GITHUB_STEP_SUMMARY
          if cargo fmt --all -- --check 2>/dev/null; then
            echo "All files are properly formatted." >> $GITHUB_STEP_SUMMARY
          else
            echo "Some files need formatting. Run \`cargo fmt\` locally." >> $GITHUB_STEP_SUMMARY
          fi

  # Documentation metrics consistency check - pure bash + python3, no Rust needed
  verification-counts:
    name: Doc Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6

      - name: Check verification counts consistency
        run: ./scripts/update-verification-counts.sh --check

      - name: Check documentation metrics consistency
        run: ./scripts/update-doc-metrics.sh --check

      - name: Generate verification summary
        if: always()
        run: |
          echo "## Documentation Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if ./scripts/update-doc-metrics.sh --json 2>/dev/null; then
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            TOTAL=$(python3 -c "import json; print(json.load(open('metrics/doc-metrics.json'))['verification']['grand_total'])" 2>/dev/null || echo "?")
            PHASES=$(python3 -c "import json; print(json.load(open('metrics/doc-metrics.json'))['optimization_phases'])" 2>/dev/null || echo "?")
            MSRV=$(python3 -c "import json; print(json.load(open('metrics/doc-metrics.json'))['msrv'])" 2>/dev/null || echo "?")
            echo "| Verified theorems/harnesses | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "| Optimization phases | **$PHASES** |" >> $GITHUB_STEP_SUMMARY
            echo "| MSRV | **$MSRV** |" >> $GITHUB_STEP_SUMMARY
            echo "| Documentation consistency | Verified |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Failed to parse documentation metrics." >> $GITHUB_STEP_SUMMARY
          fi

  # Clippy lint check - depends on format passing
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [fmt]
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "clippy"

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings 2>&1 | tee clippy-output.txt

      - name: Generate Clippy summary
        if: always()
        run: |
          echo "## Clippy Lints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "^error\|^warning" clippy-output.txt 2>/dev/null; then
            echo "### Issues Found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "^error\|^warning" clippy-output.txt | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No warnings or errors found." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # STAGE 2: Tests (run after lint checks pass)
  # ============================================================================

  # Run tests on multiple platforms
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: [clippy]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "test-${{ matrix.os }}"

      - name: Run tests
        run: cargo test --all 2>&1 | tee test-output.txt

      - name: Generate test summary
        if: always()
        shell: bash
        run: |
          echo "## Test Results (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract test counts from output (cross-platform compatible - no grep -P)
          if grep -q "test result:" test-output.txt; then
            # Get the last test result line (summary)
            RESULT_LINE=$(grep "test result:" test-output.txt | tail -1)
            echo "**Result:** \`$RESULT_LINE\`" >> $GITHUB_STEP_SUMMARY

            # Calculate total passed tests across all crates
            if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
              TOTAL_PASSED=$(grep "test result:" test-output.txt | sed 's/.*\([0-9]\+\) passed.*/\1/' | awk '{sum+=$1} END {print sum}')
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Total Tests Passed | **$TOTAL_PASSED** |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "Test output not available" >> $GITHUB_STEP_SUMMARY
          fi

  # Chaos tests - edge cases and stress testing
  chaos:
    name: Chaos Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [clippy]
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "chaos"

      - name: Run chaos tests
        run: cargo test -p rource-core chaos --no-fail-fast 2>&1 | tee chaos-output.txt

      - name: Generate chaos test summary
        if: always()
        run: |
          echo "## Chaos Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract actual results
          if grep -q "test result:" chaos-output.txt; then
            RESULT=$(grep "test result:" chaos-output.txt | tail -1)
            echo "**Result:** $RESULT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### Coverage Areas" >> $GITHUB_STEP_SUMMARY
          echo "- Edge case inputs (empty, unicode, malformed)" >> $GITHUB_STEP_SUMMARY
          echo "- Stress scenarios (10K files, deep paths)" >> $GITHUB_STEP_SUMMARY
          echo "- Numeric boundaries (epsilon, MIN_POSITIVE)" >> $GITHUB_STEP_SUMMARY
          echo "- Rapid state transitions" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 3: Build verification (run in parallel with tests)
  # ============================================================================

  # MSRV (Minimum Supported Rust Version) check
  msrv:
    name: MSRV (Rust ${{ matrix.rust }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [clippy]
    strategy:
      matrix:
        rust: ["1.93"]  # Should match env.MSRV
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "msrv-${{ matrix.rust }}"

      - name: Check MSRV
        run: cargo check --all --locked

      - name: Generate MSRV summary
        if: always()
        run: |
          echo "## MSRV Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verified compatibility with Rust **${{ matrix.rust }}**" >> $GITHUB_STEP_SUMMARY

  # Native build check
  build:
    name: Build (Native)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [clippy]
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "build-native"

      - name: Build release
        run: cargo build --release

      - name: Generate build summary
        run: |
          echo "## Native Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY

          BINARY_SIZE=$(ls -lh target/release/rource | awk '{print $5}')
          BINARY_BYTES=$(stat -c%s target/release/rource)
          BINARY_TYPE=$(file -b target/release/rource | head -c 60)

          echo "| Binary Size | $BINARY_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| Binary Type | $BINARY_TYPE |" >> $GITHUB_STEP_SUMMARY

          # Size check with clear pass/fail
          if [ $BINARY_BYTES -gt 5242880 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Warning:** Binary exceeds 5MB target ($(numfmt --to=iec-i --suffix=B $BINARY_BYTES))" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Binary size is within 5MB target." >> $GITHUB_STEP_SUMMARY
          fi

  # WASM build check
  wasm:
    name: Build (WASM)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [clippy]
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "build-wasm"

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      - name: Build WASM
        run: |
          cd rource-wasm
          wasm-pack build --target web --release

      - name: Validate JavaScript imports
        run: |
          echo "Validating JavaScript import/export consistency..."
          python3 scripts/validate-js-imports.py

      - name: Generate WASM summary
        run: |
          echo "## WASM Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Target |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          WASM_SIZE=$(ls -lh rource-wasm/pkg/rource_wasm_bg.wasm | awk '{print $5}')
          WASM_BYTES=$(stat -c%s rource-wasm/pkg/rource_wasm_bg.wasm)
          WASM_GZIP=$(gzip -c rource-wasm/pkg/rource_wasm_bg.wasm | wc -c)
          WASM_GZIP_KB=$((WASM_GZIP / 1024))

          echo "| WASM Size | $WASM_SIZE | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Gzipped | ${WASM_GZIP_KB}KB | < 300KB |" >> $GITHUB_STEP_SUMMARY
          echo "| JS Imports | Validated | - |" >> $GITHUB_STEP_SUMMARY

          # Size check
          if [ $WASM_GZIP -gt 307200 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Warning:** WASM gzipped exceeds 300KB target" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "WASM size is within 300KB gzipped target." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**JavaScript Validation:** All imports reference valid exports." >> $GITHUB_STEP_SUMMARY

  # Doc check
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [clippy]
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "docs"

      - name: Check documentation
        run: cargo doc --no-deps --all-features 2>&1 | tee doc-output.txt
        env:
          RUSTDOCFLAGS: -D warnings

      - name: Generate docs summary
        if: always()
        run: |
          echo "## Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "warning\|error" doc-output.txt 2>/dev/null; then
            echo "Documentation issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "warning\|error" doc-output.txt | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "All documentation builds without warnings." >> $GITHUB_STEP_SUMMARY
          fi

  # Feature matrix - test different feature combinations
  features:
    name: Features
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [clippy]
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "features"

      - name: Check default features
        run: cargo check --all

      - name: Check all features
        run: cargo check --all --all-features

      - name: Check no default features (library crates)
        run: |
          cargo check -p rource-math --no-default-features
          cargo check -p rource-vcs --no-default-features
          cargo check -p rource-core --no-default-features
          cargo check -p rource-render --no-default-features

      - name: Generate feature summary
        if: always()
        run: |
          echo "## Feature Matrix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Default features | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| All features | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| No default features | Passed |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 4: Final status check
  # ============================================================================

  # Aggregate all job results for branch protection
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [fmt, verification-counts, clippy, test, chaos, msrv, build, wasm, docs, features]
    if: always()
    steps:
      - name: Check all job results
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.fmt.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verification Counts | ${{ needs.verification-counts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy | ${{ needs.clippy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chaos Tests | ${{ needs.chaos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MSRV | ${{ needs.msrv.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Native Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WASM Build | ${{ needs.wasm.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Features | ${{ needs.features.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.fmt.result == 'failure' ||
          needs.verification-counts.result == 'failure' ||
          needs.clippy.result == 'failure' ||
          needs.test.result == 'failure' ||
          needs.chaos.result == 'failure' ||
          needs.msrv.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.wasm.result == 'failure' ||
          needs.docs.result == 'failure' ||
          needs.features.result == 'failure'
        run: |
          echo "One or more CI jobs failed. See individual job logs for details."
          exit 1
