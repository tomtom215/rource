name: Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  deployments: write

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable

      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      - name: Run benchmarks
        run: |
          # Run benchmarks only for packages that have them defined
          # Using --workspace instead of deprecated --all flag
          cargo bench --workspace -- --noplot 2>&1 | tee benchmark-results.txt
          echo "=== Benchmark output preview ==="
          head -100 benchmark-results.txt || true

      - name: Extract Criterion results
        run: |
          # Convert Criterion output to JSON format for benchmark-action
          python3 << 'EOF'
          import json
          import re

          results = []
          with open('benchmark-results.txt', 'r') as f:
              content = f.read()

          # Parse Criterion benchmark output
          # Format: "group/name/variant    time:   [lower bound  estimate  upper bound]"
          # The name can include slashes and be quite long
          pattern = r'([\w/]+)\s+time:\s+\[([0-9.]+)\s+(\w+)\s+([0-9.]+)\s+(\w+)\s+([0-9.]+)\s+(\w+)\]'

          for match in re.finditer(pattern, content):
              name = match.group(1)
              value = float(match.group(4))  # Use estimate (middle value)
              unit = match.group(5)

              # Convert to nanoseconds for consistency
              multipliers = {'ns': 1, 'Âµs': 1000, 'us': 1000, 'ms': 1000000, 's': 1000000000}
              value_ns = value * multipliers.get(unit, 1)

              results.append({
                  'name': name,
                  'unit': 'ns',
                  'value': value_ns
              })

          # Write results even if empty (benchmark-action needs valid JSON)
          with open('benchmark-data.json', 'w') as f:
              json.dump(results, f, indent=2)

          print(f"Extracted {len(results)} benchmark results")

          # If no results, show debug info
          if len(results) == 0:
              print("WARNING: No benchmark results extracted. Check benchmark output format.")
              # Show lines containing 'time' for debugging
              for line in content.split('\n'):
                  if 'time' in line.lower() and '[' in line:
                      print(f"  Line: {line[:100]}")
          EOF

      - name: Check if benchmarks were extracted
        id: check_benchmarks
        run: |
          # Check if we have any benchmark results
          RESULT_COUNT=$(python3 -c "import json; print(len(json.load(open('benchmark-data.json'))))")
          echo "result_count=$RESULT_COUNT" >> $GITHUB_OUTPUT
          if [ "$RESULT_COUNT" -eq 0 ]; then
            echo "::warning::No benchmark results were extracted. Skipping benchmark storage."
          else
            echo "Found $RESULT_COUNT benchmark results"
          fi

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check_benchmarks.outputs.result_count != '0'
        with:
          name: Rust Benchmarks
          tool: 'customSmallerIsBetter'
          output-file-path: benchmark-data.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          # Alert if performance regresses by more than 10%
          alert-threshold: '110%'
          comment-on-alert: true
          fail-on-alert: false
          # Store benchmark data in gh-pages branch
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      - name: Compare benchmark results (PR)
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name == 'pull_request' && steps.check_benchmarks.outputs.result_count != '0'
        with:
          name: Rust Benchmarks
          tool: 'customSmallerIsBetter'
          output-file-path: benchmark-data.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: false
          # Alert if performance regresses by more than 10%
          alert-threshold: '110%'
          comment-on-alert: true
          fail-on-alert: false
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: |
            benchmark-results.txt
            benchmark-data.json

  # Size tracking - monitor binary and WASM sizes
  size-check:
    name: Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-size-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-size-

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      - name: Install binaryen
        run: |
          sudo apt-get update
          sudo apt-get install -y binaryen

      - name: Build release binary
        run: cargo build --release

      - name: Build optimized WASM
        run: |
          cd rource-wasm
          wasm-pack build --target web --release
          cd pkg
          # Feature flags MUST come before input file for validation
          wasm-opt \
            --enable-simd \
            --enable-bulk-memory \
            --enable-sign-ext \
            --enable-nontrapping-float-to-int \
            --enable-mutable-globals \
            -Oz \
            -o rource_wasm_bg_opt.wasm rource_wasm_bg.wasm
          mv rource_wasm_bg_opt.wasm rource_wasm_bg.wasm

      - name: Report sizes
        run: |
          echo "## Binary Sizes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Size | Gzipped |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|---------|" >> $GITHUB_STEP_SUMMARY

          # Native binary
          native_size=$(ls -lh target/release/rource | awk '{print $5}')
          native_gzip=$(gzip -c target/release/rource | wc -c | numfmt --to=iec-i --suffix=B)
          echo "| Native binary | $native_size | $native_gzip |" >> $GITHUB_STEP_SUMMARY

          # WASM
          wasm_size=$(ls -lh rource-wasm/pkg/rource_wasm_bg.wasm | awk '{print $5}')
          wasm_gzip=$(gzip -c rource-wasm/pkg/rource_wasm_bg.wasm | wc -c | numfmt --to=iec-i --suffix=B)
          echo "| WASM bundle | $wasm_size | $wasm_gzip |" >> $GITHUB_STEP_SUMMARY

          # JS bindings
          js_size=$(ls -lh rource-wasm/pkg/rource_wasm.js | awk '{print $5}')
          echo "| JS bindings | $js_size | - |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Size Targets" >> $GITHUB_STEP_SUMMARY
          echo "- Native binary: < 5MB" >> $GITHUB_STEP_SUMMARY
          echo "- WASM (gzipped): < 300KB" >> $GITHUB_STEP_SUMMARY

      - name: Check size limits
        run: |
          # Check native binary size (< 5MB)
          native_bytes=$(stat -c%s target/release/rource)
          if [ $native_bytes -gt 5242880 ]; then
            echo "::warning::Native binary exceeds 5MB target: $(numfmt --to=iec-i --suffix=B $native_bytes)"
          fi

          # Check WASM gzipped size (< 300KB - adjusted for wgpu backend)
          wasm_gzip=$(gzip -c rource-wasm/pkg/rource_wasm_bg.wasm | wc -c)
          if [ $wasm_gzip -gt 307200 ]; then
            echo "::warning::WASM gzipped exceeds 300KB target: $(numfmt --to=iec-i --suffix=B $wasm_gzip)"
          fi

      - name: Create size metrics JSON
        run: |
          native_bytes=$(stat -c%s target/release/rource)
          wasm_bytes=$(stat -c%s rource-wasm/pkg/rource_wasm_bg.wasm)
          wasm_gzip=$(gzip -c rource-wasm/pkg/rource_wasm_bg.wasm | wc -c)

          cat > size-metrics.json << EOF
          [
            {"name": "Native Binary", "unit": "bytes", "value": $native_bytes},
            {"name": "WASM Bundle", "unit": "bytes", "value": $wasm_bytes},
            {"name": "WASM Gzipped", "unit": "bytes", "value": $wasm_gzip}
          ]
          EOF

      - name: Store size metrics
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          name: Binary Sizes
          tool: 'customSmallerIsBetter'
          output-file-path: size-metrics.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '120%'
          comment-on-alert: true
          fail-on-alert: false
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/sizes
