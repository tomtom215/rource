name: Verus Proof Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers for testing

# Prevent concurrent verification runs on the same branch/PR
concurrency:
  group: verus-${{ github.ref }}
  cancel-in-progress: true

# Principle of least privilege
permissions:
  contents: read

env:
  VERUS_VERSION: "0.2026.01.23.1650a05"
  RUST_TOOLCHAIN_FOR_VERUS: "1.92.0"

jobs:
  verify-proofs:
    name: Verify Verus Proofs
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain for Verus
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN_FOR_VERUS }}

      - name: Cache Verus installation
        id: cache-verus
        uses: actions/cache@v4
        with:
          path: /tmp/verus
          key: verus-${{ env.VERUS_VERSION }}-linux-x86_64

      - name: Download and install Verus
        if: steps.cache-verus.outputs.cache-hit != 'true'
        run: |
          mkdir -p /tmp/verus
          cd /tmp/verus
          # Retry download up to 3 times with exponential backoff
          for attempt in 1 2 3; do
            echo "Attempt $attempt: Downloading Verus..."
            if curl -fSL --retry 3 --retry-delay 5 -o verus.zip \
              "https://github.com/verus-lang/verus/releases/download/release/${{ env.VERUS_VERSION }}/verus-${{ env.VERUS_VERSION }}-x86-linux.zip"; then
              break
            fi
            if [ "$attempt" -eq 3 ]; then
              echo "::error::Failed to download Verus after 3 attempts"
              exit 1
            fi
            DELAY=$((attempt * 10))
            echo "Download failed, retrying in ${DELAY}s..."
            sleep "$DELAY"
          done
          unzip -o verus.zip
          ln -sf /tmp/verus/verus-x86-linux/verus /tmp/verus/verus
          chmod +x /tmp/verus/verus

      - name: Verify Verus installation
        run: |
          /tmp/verus/verus --version
          echo "Verus version: $(/tmp/verus/verus --version | head -2 | tail -1)"

      # ================================================================
      # Verify all 11 proof files (498 proof functions)
      # ================================================================

      - name: Verify Vec2 Proofs (61 proof fns)
        id: vec2
        run: |
          echo "Verifying Vec2 proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/vec2_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            ldd /tmp/verus/verus-x86-linux/verus 2>&1 || true
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Vec2 verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Vec3 Proofs (61 proof fns)
        id: vec3
        run: |
          echo "Verifying Vec3 proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/vec3_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Vec3 verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Vec4 Proofs (55 proof fns)
        id: vec4
        run: |
          echo "Verifying Vec4 proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/vec4_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Vec4 verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Mat3 Proofs (48 proof fns)
        id: mat3
        run: |
          echo "Verifying Mat3 proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/mat3_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Mat3 verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Mat3 Extended Proofs (det_transpose, det_mul)
        id: mat3ext
        run: |
          echo "Verifying Mat3 extended proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/mat3_extended_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Mat3 Extended verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Mat4 Proofs (22 proof fns)
        id: mat4
        run: |
          echo "Verifying Mat4 proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/mat4_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Mat4 verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Color Proofs (64 proof fns)
        id: color
        run: |
          echo "Verifying Color proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/color_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Color verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Rect Proofs (52 proof fns)
        id: rect
        run: |
          echo "Verifying Rect proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/rect_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Rect verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Bounds Proofs (70 proof fns)
        id: bounds
        run: |
          echo "Verifying Bounds proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/bounds_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Bounds verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Utils Proofs (33 proof fns)
        id: utils
        run: |
          echo "Verifying Utils proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/utils_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Utils verification failed with $ERRORS errors"
            exit 1
          fi

      - name: Verify Mat4 Extended Proofs (32 proof fns)
        id: mat4ext
        run: |
          echo "Verifying Mat4 extended proofs..."
          set +e
          OUTPUT=$(/tmp/verus/verus crates/rource-math/proofs/mat4_extended_proofs.rs 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ] && [ -z "$OUTPUT" ]; then
            echo "::error::Verus binary exited with code $EXIT_CODE but produced no output."
            exit 1
          fi
          VCS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*:: \([0-9]*\) verified.*/\1/')
          ERRORS=$(echo "$OUTPUT" | grep "verification results" | sed 's/.*, \([0-9]*\) errors/\1/')
          echo "vcs=$VCS" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          if [ "$ERRORS" != "0" ]; then
            echo "Mat4 Extended verification failed with $ERRORS errors"
            exit 1
          fi

      # ================================================================
      # Summary
      # ================================================================

      - name: Generate Verification Summary
        if: always()
        run: |
          echo "## Verus Formal Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Formal proofs verified using [Verus](https://github.com/verus-lang/verus) v${{ env.VERUS_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Verified | Errors | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          TOTAL_VCS=0
          TOTAL_ERRORS=0

          for STEP_NAME in vec2 vec3 vec4 mat3 mat3ext mat4 mat4ext color rect bounds utils; do
            case "$STEP_NAME" in
              vec2) LABEL="Vec2"; OUTCOME="${{ steps.vec2.outcome }}"; VCS="${{ steps.vec2.outputs.vcs }}"; ERRS="${{ steps.vec2.outputs.errors }}" ;;
              vec3) LABEL="Vec3"; OUTCOME="${{ steps.vec3.outcome }}"; VCS="${{ steps.vec3.outputs.vcs }}"; ERRS="${{ steps.vec3.outputs.errors }}" ;;
              vec4) LABEL="Vec4"; OUTCOME="${{ steps.vec4.outcome }}"; VCS="${{ steps.vec4.outputs.vcs }}"; ERRS="${{ steps.vec4.outputs.errors }}" ;;
              mat3) LABEL="Mat3"; OUTCOME="${{ steps.mat3.outcome }}"; VCS="${{ steps.mat3.outputs.vcs }}"; ERRS="${{ steps.mat3.outputs.errors }}" ;;
              mat3ext) LABEL="Mat3 Extended"; OUTCOME="${{ steps.mat3ext.outcome }}"; VCS="${{ steps.mat3ext.outputs.vcs }}"; ERRS="${{ steps.mat3ext.outputs.errors }}" ;;
              mat4) LABEL="Mat4"; OUTCOME="${{ steps.mat4.outcome }}"; VCS="${{ steps.mat4.outputs.vcs }}"; ERRS="${{ steps.mat4.outputs.errors }}" ;;
              mat4ext) LABEL="Mat4 Extended"; OUTCOME="${{ steps.mat4ext.outcome }}"; VCS="${{ steps.mat4ext.outputs.vcs }}"; ERRS="${{ steps.mat4ext.outputs.errors }}" ;;
              color) LABEL="Color"; OUTCOME="${{ steps.color.outcome }}"; VCS="${{ steps.color.outputs.vcs }}"; ERRS="${{ steps.color.outputs.errors }}" ;;
              rect) LABEL="Rect"; OUTCOME="${{ steps.rect.outcome }}"; VCS="${{ steps.rect.outputs.vcs }}"; ERRS="${{ steps.rect.outputs.errors }}" ;;
              bounds) LABEL="Bounds"; OUTCOME="${{ steps.bounds.outcome }}"; VCS="${{ steps.bounds.outputs.vcs }}"; ERRS="${{ steps.bounds.outputs.errors }}" ;;
              utils) LABEL="Utils"; OUTCOME="${{ steps.utils.outcome }}"; VCS="${{ steps.utils.outputs.vcs }}"; ERRS="${{ steps.utils.outputs.errors }}" ;;
            esac

            if [ "$OUTCOME" = "success" ]; then
              ICON=":white_check_mark:"
              STATUS="Verified"
            else
              ICON=":x:"
              STATUS="Failed"
            fi

            echo "| $LABEL | ${VCS:-N/A} | ${ERRS:-N/A} | $ICON $STATUS |" >> $GITHUB_STEP_SUMMARY

            if [ -n "$VCS" ] && [ "$VCS" != "N/A" ]; then
              TOTAL_VCS=$((TOTAL_VCS + VCS))
            fi
            if [ -n "$ERRS" ] && [ "$ERRS" != "N/A" ]; then
              TOTAL_ERRORS=$((TOTAL_ERRORS + ERRS))
            fi
          done

          echo "| **Total** | **$TOTAL_VCS** | **$TOTAL_ERRORS** | |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL_ERRORS" -eq 0 ]; then
            echo "> :white_check_mark: **All $TOTAL_VCS Verus proof functions verified successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Mathematical correctness of all 9 types machine-checked: Vec2, Vec3, Vec4, Mat3, Mat4, Color, Rect, Bounds, Utils." >> $GITHUB_STEP_SUMMARY
          else
            echo "> :x: **Verification failed with $TOTAL_ERRORS errors**" >> $GITHUB_STEP_SUMMARY
          fi
