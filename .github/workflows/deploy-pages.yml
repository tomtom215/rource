name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-wasm-

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      - name: Install binaryen (wasm-opt)
        run: |
          sudo apt-get update
          sudo apt-get install -y binaryen

      - name: Generate fresh Rource commit data
        run: |
          # Generate commit log for the Rource project itself
          # Format: timestamp|author|action|path
          git log --reverse --format="%at|%an" --name-status | awk '
            /^[0-9]+\|/ { info=$0; next }
            /^[AMD]\t/ { print info"|"substr($0,1,1)"|"substr($0,3) }
          ' > /tmp/rource_commits.log

          # Count stats
          COMMIT_COUNT=$(git rev-list --count HEAD)
          FILE_COUNT=$(cat /tmp/rource_commits.log | wc -l)
          AUTHOR_COUNT=$(git log --format="%an" | sort -u | wc -l)

          echo "Generated commit log with $COMMIT_COUNT commits, $FILE_COUNT file changes, $AUTHOR_COUNT authors"
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          echo "AUTHOR_COUNT=$AUTHOR_COUNT" >> $GITHUB_ENV

      - name: Count unit tests
        run: |
          # Run cargo test with --list to count tests without running them
          TEST_COUNT=$(cargo test --workspace -- --list 2>/dev/null | grep -c "test$" || echo "0")
          echo "Found $TEST_COUNT unit tests"
          echo "TEST_COUNT=$TEST_COUNT" >> $GITHUB_ENV

      - name: Build WASM
        run: |
          cd rource-wasm
          wasm-pack build --target web --release
          cp -r pkg www/

      - name: Optimize WASM
        run: |
          cd rource-wasm/www/pkg
          # Enable modern WASM features that Rust emits by default
          # These are well-supported in all modern browsers (Chrome 75+, Firefox 79+, Safari 14.1+)
          wasm-opt -Oz \
            --enable-bulk-memory \
            --enable-sign-ext \
            --enable-nontrapping-float-to-int \
            -o rource_wasm_bg_opt.wasm rource_wasm_bg.wasm
          mv rource_wasm_bg_opt.wasm rource_wasm_bg.wasm
          echo "=== WASM sizes ==="
          ls -lh *.wasm
          WASM_SIZE_BYTES=$(gzip -c rource_wasm_bg.wasm | wc -c)
          WASM_SIZE_KB=$((WASM_SIZE_BYTES / 1024))
          echo "Gzipped: $WASM_SIZE_BYTES bytes (~${WASM_SIZE_KB}KB)"
          echo "WASM_SIZE_KB=$WASM_SIZE_KB" >> $GITHUB_ENV

      - name: Update demo with fresh data
        run: |
          cd rource-wasm/www

          # Get today's date for the comment
          TODAY=$(date +%Y-%m-%d)

          # Create the new cached data section
          CACHED_DATA=$(cat /tmp/rource_commits.log)

          # Update app.js with fresh commit data
          # We use a Python script for reliable multi-line replacement
          python3 << 'PYTHON_SCRIPT'
          import re
          import os

          # Read the commit data
          with open('/tmp/rource_commits.log', 'r') as f:
              commit_data = f.read().strip()

          # Read the current app.js
          with open('app.js', 'r') as f:
              content = f.read()

          # Build the new cached data section
          today = os.popen('date +%Y-%m-%d').read().strip()
          new_section = f'''// =====================================================================
          // CACHED ROURCE REPOSITORY DATA
          // =====================================================================
          // This is the complete commit history of the Rource project itself.
          // Cached locally to ensure the demo always works without API rate limits.
          // Generated from: git log --reverse --format="%at|%an" --name-status
          // Last updated: {today} (auto-generated by CI)
          // =====================================================================
          const ROURCE_CACHED_DATA = `{commit_data}'''

          # Fix indentation (remove leading spaces from each line)
          new_section = '\n'.join(line.lstrip() for line in new_section.split('\n'))

          # Replace the existing cached data section
          # Pattern matches from the comment block to the end of the template literal
          pattern = r'// =+\n// CACHED ROURCE REPOSITORY DATA\n// =+\n.*?// =+\nconst ROURCE_CACHED_DATA = `[^`]*'
          content = re.sub(pattern, new_section, content, flags=re.DOTALL)

          # Write the updated content
          with open('app.js', 'w') as f:
              f.write(content)

          print(f"Updated app.js with fresh commit data (as of {today})")
          PYTHON_SCRIPT

          # Update index.html with fresh technical specs
          # Update test count
          sed -i "s|<div class=\"tech-item-value\" id=\"tech-tests\">[0-9]*</div>|<div class=\"tech-item-value\" id=\"tech-tests\">${TEST_COUNT}</div>|g" index.html

          # Update WASM size
          sed -i "s|<div class=\"tech-item-value\" id=\"tech-wasm-size\">~[0-9]*KB</div>|<div class=\"tech-item-value\" id=\"tech-wasm-size\">~${WASM_SIZE_KB}KB</div>|g" index.html

          echo "Updated index.html with TEST_COUNT=${TEST_COUNT}, WASM_SIZE=~${WASM_SIZE_KB}KB"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: rource-wasm/www

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
