name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Ensure only one deployment runs at a time
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build WASM Demo
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history needed for git log to generate commit data

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          shared-key: "deploy-pages"

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      - name: Install binaryen (wasm-opt)
        run: |
          sudo apt-get update
          sudo apt-get install -y binaryen

      - name: Generate fresh Rource commit data
        run: |
          set -euo pipefail

          # Generate commit log for the Rource project itself
          # Format: timestamp|author|action|path
          git log --reverse --format="%at|%an" --name-status | awk '
            /^[0-9]+\|/ { info=$0; next }
            /^[AMD]\t/ { print info"|"substr($0,1,1)"|"substr($0,3) }
          ' > /tmp/rource_commits.log

          # Validate commit log was generated
          if [ ! -s /tmp/rource_commits.log ]; then
            echo "ERROR: Failed to generate commit log or log is empty"
            exit 1
          fi

          # Count stats
          COMMIT_COUNT=$(git rev-list --count HEAD)
          FILE_COUNT=$(wc -l < /tmp/rource_commits.log)
          AUTHOR_COUNT=$(git log --format="%an" | sort -u | wc -l)

          # Validate counts are reasonable
          if [ "$COMMIT_COUNT" -lt 1 ]; then
            echo "ERROR: Invalid commit count: $COMMIT_COUNT"
            exit 1
          fi

          echo "Generated commit log with $COMMIT_COUNT commits, $FILE_COUNT file changes, $AUTHOR_COUNT authors"
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          echo "AUTHOR_COUNT=$AUTHOR_COUNT" >> $GITHUB_ENV

      - name: Count unit tests
        run: |
          set -euo pipefail

          # Run cargo test with --list to count tests without running them
          # The grep counts lines ending with "test"
          TEST_COUNT=$(cargo test --workspace -- --list 2>&1 | grep -c ": test$" || echo "0")

          # Validate we got a reasonable count
          if [ "$TEST_COUNT" -lt 100 ]; then
            echo "WARNING: Low test count ($TEST_COUNT). This may indicate a build error."
            echo "Attempting full test run to verify..."
            cargo test --workspace --no-fail-fast 2>&1 | tail -20 || true
          fi

          echo "Found $TEST_COUNT unit tests"
          echo "TEST_COUNT=$TEST_COUNT" >> $GITHUB_ENV

      - name: Build WASM
        run: |
          cd rource-wasm
          wasm-pack build --target web --release
          cp -r pkg www/

      - name: Optimize WASM
        run: |
          cd rource-wasm/www/pkg
          # Enable modern WASM features that Rust emits by default
          # These are well-supported in all modern browsers (Chrome 91+, Firefox 89+, Safari 16.4+)
          # Feature flags MUST come before input file for validation
          wasm-opt \
            --enable-simd \
            --enable-bulk-memory \
            --enable-sign-ext \
            --enable-nontrapping-float-to-int \
            --enable-mutable-globals \
            -Oz \
            -o rource_wasm_bg_opt.wasm rource_wasm_bg.wasm
          mv rource_wasm_bg_opt.wasm rource_wasm_bg.wasm
          echo "=== WASM sizes ==="
          ls -lh *.wasm
          WASM_SIZE_BYTES=$(gzip -c rource_wasm_bg.wasm | wc -c)
          WASM_SIZE_KB=$((WASM_SIZE_BYTES / 1024))
          echo "Gzipped: $WASM_SIZE_BYTES bytes (~${WASM_SIZE_KB}KB)"
          echo "WASM_SIZE_KB=$WASM_SIZE_KB" >> $GITHUB_ENV

      - name: Bundle CSS (eliminate @import waterfall)
        run: |
          cd rource-wasm/www

          # Bundle all CSS files into a single file to prevent 503 errors from
          # too many concurrent requests hitting GitHub Pages CDN on cold load.
          # The @import cascade creates ~25 requests; bundling reduces to 1.
          python3 << 'PYTHON_SCRIPT'
          import re
          from pathlib import Path

          def resolve_imports(css_path, base_dir, seen=None):
              """Recursively resolve @import statements and concatenate CSS."""
              if seen is None:
                  seen = set()

              if css_path in seen:
                  return ""  # Prevent circular imports
              seen.add(css_path)

              content = css_path.read_text()
              result = []

              # Process @import statements in order
              for line in content.split('\n'):
                  import_match = re.match(r"@import\s+url\(['\"]?([^'\")]+)['\"]?\);?", line.strip())
                  if import_match:
                      import_path = import_match.group(1)
                      # Resolve relative path from the CSS file's directory
                      resolved = (css_path.parent / import_path).resolve()
                      if resolved.exists():
                          try:
                              rel_path = resolved.relative_to(base_dir)
                          except ValueError:
                              rel_path = resolved.name
                          result.append(f"\n/* === {rel_path} === */\n")
                          result.append(resolve_imports(resolved, base_dir, seen))
                      else:
                          print(f"Warning: Could not find {import_path}")
                  else:
                      result.append(line + '\n')

              return ''.join(result)

          base_dir = Path('.').resolve()
          styles_css = base_dir / 'styles.css'

          if styles_css.exists():
              bundled = resolve_imports(styles_css, base_dir)

              # Write bundled CSS
              styles_css.write_text(bundled)

              # Remove the now-unused styles/ directory to save space
              import shutil
              styles_dir = base_dir / 'styles'
              if styles_dir.exists():
                  shutil.rmtree(styles_dir)
                  print(f"Removed styles/ directory (bundled into styles.css)")

              print(f"Bundled CSS: {len(bundled)} bytes ({bundled.count(chr(10))} lines)")
          else:
              print("Warning: styles.css not found")
          PYTHON_SCRIPT

      - name: Update demo with fresh data
        run: |
          cd rource-wasm/www

          # Get today's date for the comment
          TODAY=$(date +%Y-%m-%d)

          # Update js/cached-data.js with fresh commit data and stats
          # We use a Python script for reliable multi-line replacement
          python3 << 'PYTHON_SCRIPT'
          import re
          import os

          # Read the commit data
          with open('/tmp/rource_commits.log', 'r') as f:
              commit_data = f.read().strip()

          # Read the current cached-data.js
          with open('js/cached-data.js', 'r') as f:
              content = f.read()

          # Get values from environment
          today = os.popen('date +%Y-%m-%d').read().strip()
          commit_count = os.environ.get('COMMIT_COUNT', '0')

          # Update the "Last updated" comment
          content = re.sub(
              r'\* Last updated: \d{4}-\d{2}-\d{2}',
              f'* Last updated: {today}',
              content
          )

          # Update TOTAL_GIT_COMMITS constant (the actual git commit count from git rev-list)
          content = re.sub(
              r'export const TOTAL_GIT_COMMITS = \d+;',
              f'export const TOTAL_GIT_COMMITS = {commit_count};',
              content
          )

          # Replace the ROURCE_CACHED_DATA content (everything between backticks)
          # Pattern: export const ROURCE_CACHED_DATA = `...`;
          pattern = r"(export const ROURCE_CACHED_DATA = `)([^`]*)(`;)"
          content = re.sub(pattern, rf"\g<1>{commit_data}\g<3>", content, flags=re.DOTALL)

          # Write the updated content
          with open('js/cached-data.js', 'w') as f:
              f.write(content)

          print(f"Updated js/cached-data.js with fresh commit data (as of {today})")
          print(f"Total git commits: {commit_count}")
          PYTHON_SCRIPT

          # Update index.html with fresh technical specs
          # Update test count
          sed -i "s|<div class=\"tech-item-value\" id=\"tech-tests\">[0-9]*</div>|<div class=\"tech-item-value\" id=\"tech-tests\">${TEST_COUNT}</div>|g" index.html

          # Update WASM size
          sed -i "s|<div class=\"tech-item-value\" id=\"tech-wasm-size\">~[0-9]*KB</div>|<div class=\"tech-item-value\" id=\"tech-wasm-size\">~${WASM_SIZE_KB}KB</div>|g" index.html

          echo "Updated index.html with TEST_COUNT=${TEST_COUNT}, WASM_SIZE=~${WASM_SIZE_KB}KB"

      - name: Generate build summary
        run: |
          echo "## GitHub Pages Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commits | $COMMIT_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| File Changes | $FILE_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Authors | $AUTHOR_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | $TEST_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| WASM Size (gzip) | ~${WASM_SIZE_KB}KB |" >> $GITHUB_STEP_SUMMARY

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: rource-wasm/www

  deploy:
    name: Deploy to Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
