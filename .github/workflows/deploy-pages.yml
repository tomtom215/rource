name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history needed for git log to generate commit data

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-wasm-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-wasm-

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      - name: Install binaryen (wasm-opt)
        run: |
          sudo apt-get update
          sudo apt-get install -y binaryen

      - name: Generate fresh Rource commit data
        run: |
          set -euo pipefail

          # Generate commit log for the Rource project itself
          # Format: timestamp|author|action|path
          git log --reverse --format="%at|%an" --name-status | awk '
            /^[0-9]+\|/ { info=$0; next }
            /^[AMD]\t/ { print info"|"substr($0,1,1)"|"substr($0,3) }
          ' > /tmp/rource_commits.log

          # Validate commit log was generated
          if [ ! -s /tmp/rource_commits.log ]; then
            echo "ERROR: Failed to generate commit log or log is empty"
            exit 1
          fi

          # Count stats
          COMMIT_COUNT=$(git rev-list --count HEAD)
          FILE_COUNT=$(wc -l < /tmp/rource_commits.log)
          AUTHOR_COUNT=$(git log --format="%an" | sort -u | wc -l)

          # Validate counts are reasonable
          if [ "$COMMIT_COUNT" -lt 1 ]; then
            echo "ERROR: Invalid commit count: $COMMIT_COUNT"
            exit 1
          fi

          echo "Generated commit log with $COMMIT_COUNT commits, $FILE_COUNT file changes, $AUTHOR_COUNT authors"
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
          echo "FILE_COUNT=$FILE_COUNT" >> $GITHUB_ENV
          echo "AUTHOR_COUNT=$AUTHOR_COUNT" >> $GITHUB_ENV

      - name: Count unit tests
        run: |
          set -euo pipefail

          # Run cargo test with --list to count tests without running them
          # The grep counts lines ending with "test"
          TEST_COUNT=$(cargo test --workspace -- --list 2>&1 | grep -c ": test$" || echo "0")

          # Validate we got a reasonable count
          if [ "$TEST_COUNT" -lt 100 ]; then
            echo "WARNING: Low test count ($TEST_COUNT). This may indicate a build error."
            echo "Attempting full test run to verify..."
            cargo test --workspace --no-fail-fast 2>&1 | tail -20 || true
          fi

          echo "Found $TEST_COUNT unit tests"
          echo "TEST_COUNT=$TEST_COUNT" >> $GITHUB_ENV

      - name: Build WASM
        run: |
          cd rource-wasm
          wasm-pack build --target web --release
          cp -r pkg www/

      - name: Optimize WASM
        run: |
          cd rource-wasm/www/pkg
          # Enable modern WASM features that Rust emits by default
          # These are well-supported in all modern browsers (Chrome 91+, Firefox 89+, Safari 16.4+)
          # Feature flags MUST come before input file for validation
          wasm-opt \
            --enable-simd \
            --enable-bulk-memory \
            --enable-sign-ext \
            --enable-nontrapping-float-to-int \
            --enable-mutable-globals \
            -Oz \
            -o rource_wasm_bg_opt.wasm rource_wasm_bg.wasm
          mv rource_wasm_bg_opt.wasm rource_wasm_bg.wasm
          echo "=== WASM sizes ==="
          ls -lh *.wasm
          WASM_SIZE_BYTES=$(gzip -c rource_wasm_bg.wasm | wc -c)
          WASM_SIZE_KB=$((WASM_SIZE_BYTES / 1024))
          echo "Gzipped: $WASM_SIZE_BYTES bytes (~${WASM_SIZE_KB}KB)"
          echo "WASM_SIZE_KB=$WASM_SIZE_KB" >> $GITHUB_ENV

      - name: Update demo with fresh data
        run: |
          cd rource-wasm/www

          # Get today's date for the comment
          TODAY=$(date +%Y-%m-%d)

          # Update js/cached-data.js with fresh commit data and stats
          # We use a Python script for reliable multi-line replacement
          python3 << 'PYTHON_SCRIPT'
          import re
          import os

          # Read the commit data
          with open('/tmp/rource_commits.log', 'r') as f:
              commit_data = f.read().strip()

          # Read the current cached-data.js
          with open('js/cached-data.js', 'r') as f:
              content = f.read()

          # Get values from environment
          today = os.popen('date +%Y-%m-%d').read().strip()
          commit_count = os.environ.get('COMMIT_COUNT', '0')

          # Update the "Last updated" comment
          content = re.sub(
              r'\* Last updated: \d{4}-\d{2}-\d{2}',
              f'* Last updated: {today}',
              content
          )

          # Update TOTAL_GIT_COMMITS constant (the actual git commit count from git rev-list)
          content = re.sub(
              r'export const TOTAL_GIT_COMMITS = \d+;',
              f'export const TOTAL_GIT_COMMITS = {commit_count};',
              content
          )

          # Replace the ROURCE_CACHED_DATA content (everything between backticks)
          # Pattern: export const ROURCE_CACHED_DATA = `...`;
          pattern = r"(export const ROURCE_CACHED_DATA = `)([^`]*)(`;)"
          content = re.sub(pattern, rf"\g<1>{commit_data}\g<3>", content, flags=re.DOTALL)

          # Write the updated content
          with open('js/cached-data.js', 'w') as f:
              f.write(content)

          print(f"Updated js/cached-data.js with fresh commit data (as of {today})")
          print(f"Total git commits: {commit_count}")
          PYTHON_SCRIPT

          # Update index.html with fresh technical specs
          # Update test count
          sed -i "s|<div class=\"tech-item-value\" id=\"tech-tests\">[0-9]*</div>|<div class=\"tech-item-value\" id=\"tech-tests\">${TEST_COUNT}</div>|g" index.html

          # Update WASM size
          sed -i "s|<div class=\"tech-item-value\" id=\"tech-wasm-size\">~[0-9]*KB</div>|<div class=\"tech-item-value\" id=\"tech-wasm-size\">~${WASM_SIZE_KB}KB</div>|g" index.html

          echo "Updated index.html with TEST_COUNT=${TEST_COUNT}, WASM_SIZE=~${WASM_SIZE_KB}KB"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: rource-wasm/www

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
