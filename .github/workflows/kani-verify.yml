name: Kani CBMC Verification

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers for testing

# Prevent concurrent verification runs on the same branch/PR
concurrency:
  group: kani-${{ github.ref }}
  cancel-in-progress: true

# Principle of least privilege
permissions:
  contents: read

jobs:
  # ===========================================================================
  # Phase 85: Parallelized Kani verification via matrix strategy
  #
  # Previously: 272 harnesses ran sequentially in ~15+ minutes (single job).
  # Now: 9 parallel jobs (one per type), each running 11-47 harnesses.
  # Expected: ~5 minutes wall-clock time (limited by slowest job: color @ 47).
  #
  # SIGSEGV avoidance: Max harnesses per job is 47 (color), well under the
  # 110-harness SIGSEGV threshold documented in lesson #94.
  # ===========================================================================

  verify-type:
    name: Kani ${{ matrix.type }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        type: [vec2, vec3, vec4, mat3, mat4, color, rect, bounds, utils]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Kani installation
        id: cache-kani
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-kani
            ~/.cargo/bin/kani-*
            ~/.kani
          key: kani-0.67.0-${{ runner.os }}

      - name: Install Kani
        if: steps.cache-kani.outputs.cache-hit != 'true'
        run: |
          # Retry up to 3 times with exponential backoff for transient network failures
          for attempt in 1 2 3; do
            echo "Attempt $attempt: Installing kani-verifier..."
            if cargo install --locked kani-verifier; then
              break
            fi
            if [ "$attempt" -eq 3 ]; then
              echo "::error::Failed to install kani-verifier after 3 attempts"
              exit 1
            fi
            DELAY=$((attempt * 10))
            echo "Install failed, retrying in ${DELAY}s..."
            sleep "$DELAY"
          done
          cargo kani setup

      - name: Verify Kani installation
        run: |
          cargo kani --version

      - name: Run ${{ matrix.type }} harnesses
        id: verify
        run: |
          PROOF_FILE="crates/rource-math/src/kani_proofs/${{ matrix.type }}.rs"

          if [ ! -f "$PROOF_FILE" ]; then
            echo "::error::Proof file not found: $PROOF_FILE"
            exit 1
          fi

          # Extract harness names from this type's file only
          HARNESSES=$(grep -h '#\[kani::proof\]' "$PROOF_FILE" -A1 | grep 'fn ' | sed 's/.*fn \([a-zA-Z_0-9]*\).*/\1/' | sort)
          COUNT=$(echo "$HARNESSES" | wc -l)
          echo "Found $COUNT harnesses in $PROOF_FILE"

          TOTAL=0
          PASSED=0
          FAILED=0
          FAILED_LIST=""

          for HARNESS in $HARNESSES; do
            TOTAL=$((TOTAL + 1))

            # Suppress verbose CBMC output for passing harnesses;
            # capture output and only display it on failure for debugging.
            LOGFILE=$(mktemp)
            if timeout 300 cargo kani -p rource-math --harness "$HARNESS" --output-format terse >"$LOGFILE" 2>&1; then
              PASSED=$((PASSED + 1))
              echo "  PASS [$TOTAL/$COUNT] $HARNESS"
            else
              FAILED=$((FAILED + 1))
              FAILED_LIST="$FAILED_LIST $HARNESS"
              echo "  FAIL [$TOTAL/$COUNT] $HARNESS"
              echo "::group::$HARNESS failure details"
              tail -50 "$LOGFILE"
              echo "::endgroup::"
              echo "::warning::Harness $HARNESS failed"
            fi
            rm -f "$LOGFILE"
          done

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "failed_list=$FAILED_LIST" >> $GITHUB_OUTPUT

          echo ""
          echo "=== ${{ matrix.type }} Verification Summary ==="
          echo "Total:  $TOTAL"
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"

          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED ${{ matrix.type }} harnesses failed: $FAILED_LIST"
            exit 1
          fi

  # ===========================================================================
  # Summary job: aggregates results from all matrix jobs
  # ===========================================================================

  summary:
    name: Kani Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: verify-type
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Count total harnesses
        id: count
        run: |
          # Count harnesses from source files (ground truth)
          TOTAL=$(grep -rc '#\[kani::proof\]' crates/rource-math/src/kani_proofs/*.rs | awk -F: '{s+=$2} END {print s}')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Count per type
          for TYPE in vec2 vec3 vec4 mat3 mat4 color rect bounds utils; do
            FILE="crates/rource-math/src/kani_proofs/${TYPE}.rs"
            if [ -f "$FILE" ]; then
              COUNT=$(grep -c '#\[kani::proof\]' "$FILE" || echo "0")
            else
              COUNT=0
            fi
            echo "${TYPE}=${COUNT}" >> $GITHUB_OUTPUT
          done

      - name: Generate Verification Summary
        run: |
          echo "## Kani CBMC Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Bit-precise IEEE 754 f32 verification using [Kani](https://model-checking.github.io/kani/) (CBMC-based bounded model checker)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution strategy:** 9 parallel matrix jobs (Phase 85 parallelization)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Harness Distribution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Harnesses | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Vec2 | ${{ steps.count.outputs.vec2 }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vec3 | ${{ steps.count.outputs.vec3 }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vec4 | ${{ steps.count.outputs.vec4 }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mat3 | ${{ steps.count.outputs.mat3 }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mat4 | ${{ steps.count.outputs.mat4 }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Color | ${{ steps.count.outputs.color }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rect | ${{ steps.count.outputs.rect }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bounds | ${{ steps.count.outputs.bounds }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Utils | ${{ steps.count.outputs.utils }} | ${{ needs.verify-type.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.count.outputs.total }}** | |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          RESULT="${{ needs.verify-type.result }}"
          if [ "$RESULT" = "success" ]; then
            echo "> :white_check_mark: **All Kani harnesses passed! Zero IEEE 754 edge-case failures.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "> :x: **One or more type verification jobs failed. See individual job logs for details.**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### What Kani Verifies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **NaN freedom**: Operations on finite inputs produce finite results" >> $GITHUB_STEP_SUMMARY
          echo "- **Overflow safety**: No unexpected infinity from bounded inputs" >> $GITHUB_STEP_SUMMARY
          echo "- **Postconditions**: Reflexivity, commutativity, componentwise correctness" >> $GITHUB_STEP_SUMMARY
          echo "- **IEEE 754 edge cases**: Denormalized numbers, ULP precision limits, catastrophic cancellation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Standard:** PEER REVIEWED PUBLISHED ACADEMIC (bit-precise CBMC model checking)" >> $GITHUB_STEP_SUMMARY
